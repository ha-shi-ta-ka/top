<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aida - ã‚°ãƒ«ãƒ¼ãƒ— | å¾…ã¡åˆã‚ã›å ´æ‰€ã‚’æŠ•ç¥¨ã§æ±ºã‚ã‚‹</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WCDYPYTJE3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-WCDYPYTJE3');
    </script>
    
    <meta name="description" content="ã¿ã‚“ãªã®ä¸­é–“åœ°ç‚¹ã‚’è¨ˆç®—ã—ã¦ã€æŠ•ç¥¨ã§å¾…ã¡åˆã‚ã›å ´æ‰€ã‚’æ±ºã‚ã‚ˆã†ã€‚ç™»éŒ²ä¸è¦ãƒ»å®Œå…¨ç„¡æ–™ã€‚">
    <meta name="robots" content="noindex, nofollow">
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
    <meta name="theme-color" content="#6366f1">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Outfit:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDzpRxX5te8hcxf_az6n92FTkoRbyCEXwI&libraries=places&callback=initApp"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'], heading: ['"Outfit"', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.4s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(5px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                } 
            }
        }
    </script>
    <style>
        .glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); }
        .glass-card { background: rgba(255,255,255,0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); border-radius: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.08); }
        .map-container { height: 250px; border-radius: 1.5rem; width: 100%; }
        .pac-container { border-radius: 12px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.15); font-family: "Noto Sans JP"; margin-top: 5px; }
        .pac-item { padding: 12px; cursor: pointer; }
    </style>
</head>
<body class="font-sans bg-slate-50 text-slate-900 min-h-screen">
    <div class="fixed inset-0 pointer-events-none overflow-hidden">
        <div class="absolute top-[-20%] right-[-10%] w-[500px] h-[500px] bg-indigo-500/20 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-20%] left-[-10%] w-[400px] h-[400px] bg-pink-500/20 rounded-full blur-[100px]"></div>
    </div>
    
    <nav class="fixed top-0 left-0 right-0 z-50 glass border-b border-white/20 px-6 py-4">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <a href="index.html" class="text-2xl font-black tracking-tighter bg-gradient-to-r from-indigo-500 to-pink-500 bg-clip-text text-transparent font-heading">Aida</a>
            <a href="index.html" class="text-sm text-slate-500 hover:text-indigo-500 transition-colors">ãƒˆãƒƒãƒ—ã¸</a>
        </div>
    </nav>

    <main class="relative z-10 max-w-2xl mx-auto px-4 pt-24 pb-12">
        <div id="createView">
            <div class="glass-card p-8">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-r from-indigo-500 to-pink-500 text-white text-3xl mb-4">ğŸ‰</div>
                    <h1 class="text-2xl font-black text-slate-900 font-heading">æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ</h1>
                    <p class="text-slate-500 mt-2">å¾…ã¡åˆã‚ã›å ´æ‰€ã‚’ã¿ã‚“ãªã§æ±ºã‚ã‚ˆã†</p>
                </div>
                <input type="text" id="groupName" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—åï¼ˆä¾‹: å¿˜å¹´ä¼š2025ï¼‰" class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none text-lg mb-4">
                <button onclick="createGroup()" class="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-500 to-pink-500 text-white font-bold text-lg shadow-lg shadow-indigo-500/25 hover:scale-[1.02] transition-transform">ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ â†’</button>
            </div>
        </div>

        <div id="groupView" class="hidden space-y-6">
            <div class="glass-card p-6">
                <h2 class="text-sm font-bold text-slate-500 mb-4">ğŸ“¤ ã“ã®URLã‚’å…±æœ‰</h2>
                <div class="bg-slate-100 rounded-xl p-4 mb-4 font-mono text-xs break-all" id="shareUrl"></div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <button onclick="copyUrl()" class="py-3 rounded-xl bg-slate-900 text-white font-bold text-sm">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    <button onclick="shareToLine()" class="py-3 rounded-xl bg-[#06C755] text-white font-bold text-sm">ğŸ’¬ LINE</button>
                </div>
            </div>

            <div class="glass-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-slate-500">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆ<span id="memberCount">0</span>äººï¼‰</h2>
                    <button onclick="openAddFriendModal()" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg">ï¼‹ å‹é”ã‚’è¿½åŠ </button>
                </div>
                <div id="memberList" class="space-y-3 mb-4"></div>
                <button id="joinBtn" onclick="showJoinForm()" class="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-500 to-pink-500 text-white font-bold shadow-md">âœ‹ è‡ªåˆ†ã‚‚å‚åŠ ã™ã‚‹</button>
            </div>

            <div id="joinForm" class="hidden glass-card p-6 animate-fade-in">
                <h2 class="text-sm font-bold text-slate-500 mb-4" id="formTitle">ğŸ™‹ å‚åŠ æƒ…å ±ã‚’å…¥åŠ›</h2>
                <input type="text" id="nickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none text-lg mb-4">
                <label onclick="toggleAnywhere()" class="flex items-center gap-3 p-4 rounded-xl bg-amber-50 border-2 border-amber-200 cursor-pointer mb-4">
                    <div id="checkboxIcon" class="w-6 h-6 rounded-md border-2 border-amber-400 flex items-center justify-center text-white text-sm font-bold"></div>
                    <span class="font-bold text-amber-700">ã©ã“ã§ã‚‚OKï¼ˆé§…ã‚’æŒ‡å®šã—ãªã„ï¼‰</span>
                </label>
                <div id="stationWrapper" class="mb-4">
                    <input type="text" id="stationInput" placeholder="å‡ºç™ºé§…ã‚’å…¥åŠ›ï¼ˆä¾‹: æ¸‹è°·é§…ï¼‰" class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none text-lg">
                    <p class="text-[10px] text-slate-400 mt-2 px-1">â€»å€™è£œã‹ã‚‰é§…åã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                </div>
                <button onclick="joinOrUpdateGroup()" class="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-500 to-pink-500 text-white font-bold shadow-lg" id="submitBtn">å‚åŠ ã™ã‚‹ â†’</button>
            </div>

            <div id="jumpButtons" class="hidden grid grid-cols-3 gap-2">
                <button onclick="scrollToSection('normalSection')" class="py-3 rounded-xl bg-indigo-500 text-white font-bold text-xs shadow-sm">ğŸ“ å€™è£œ</button>
                <button onclick="scrollToSection('biasSection')" class="py-3 rounded-xl bg-pink-500 text-white font-bold text-xs shadow-sm">ğŸ‘¤ å¯„ã›ã‚‹</button>
                <button onclick="scrollToSection('rankingSection')" class="py-3 rounded-xl bg-amber-500 text-white font-bold text-xs shadow-sm">ğŸ† ãƒ©ãƒ³ã‚¯</button>
            </div>

            <div id="normalSection" class="hidden space-y-4">
                <div class="glass-card p-6">
                    <h2 class="text-lg font-black text-slate-900 mb-4">ğŸ“ ãŠã™ã™ã‚ã®å€™è£œé§…</h2>
                    <div id="normalMap" class="map-container mb-6 bg-slate-100 flex items-center justify-center text-slate-400">Map Loading...</div>
                    <div id="normalCandidates" class="space-y-4"></div>
                </div>
            </div>

            <div id="biasSection" class="hidden space-y-4">
                <div class="glass-card p-6">
                    <h2 class="text-lg font-black text-slate-900 mb-2">ğŸ‘¤ èª°ã‹ã«å¯„ã›ã‚‹</h2>
                    <p class="text-xs text-slate-400 mb-4">ä¸»å½¹ã‚„å¹¹äº‹ã®è¿‘ãã‚’å€™è£œã«ã—ã¾ã™</p>
                    <div id="biasMemberList" class="flex flex-wrap gap-2 mb-6"></div>
                    <div id="biasMap" class="map-container mb-6 bg-slate-100 flex items-center justify-center text-slate-400">Map Loading...</div>
                    <div id="biasCandidates" class="space-y-4"></div>
                </div>
            </div>

            <div id="rankingSection" class="hidden space-y-4">
                <div class="glass-card p-6">
                    <h2 class="text-lg font-black text-slate-900 mb-4">ğŸ† æŠ•ç¥¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
                    <div id="rankingList" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="addFriendModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl animate-fade-in">
            <h2 class="text-xl font-bold mb-4 text-slate-900">ğŸ‘¤ å‹é”ã‚’è¿½åŠ </h2>
            <input type="text" id="addFriendNickname" placeholder="åå‰" class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 mb-4">
            <input type="text" id="addFriendStationInput" placeholder="å‡ºç™ºé§…ã‚’å…¥åŠ›" class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 mb-6">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeAddFriendModal()" class="py-3 rounded-xl bg-slate-100 font-bold">æˆ»ã‚‹</button>
                <button onclick="submitAddFriend()" class="py-3 rounded-xl bg-indigo-500 text-white font-bold">è¿½åŠ ã™ã‚‹</button>
            </div>
        </div>
    </div>
</body>

<script>
/**
 * è¨­å®šãƒ»åˆæœŸåŒ–
 */
const firebaseConfig = {
    apiKey: "AIzaSyCxj6Qxk6PkL9WhbIQZh_wCwlhZBdY8MrQ",
    authDomain: "aida-f2eb3.firebaseapp.com",
    projectId: "aida-f2eb3",
    storageBucket: "aida-f2eb3.firebasestorage.app",
    messagingSenderId: "124876591098",
    appId: "1:124876591098:web:93bef3d94de8cf37799e43"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let groupId = null, groupData = null, myMemberId = null;
let gMapNormal = null, gMapBias = null;
let normalMarkers = [], biasMarkers = [];
let isAnywhere = false, selectedStation = null;
let editTargetId = null;

// Google Maps API ãƒ­ãƒ¼ãƒ‰å¾Œã«å‘¼ã°ã‚Œã‚‹
function initApp() {
    setupAutocomplete('stationInput');
    setupAutocomplete('addFriendStationInput');
    
    const urlParams = new URLSearchParams(window.location.search);
    groupId = urlParams.get('g');
    if (groupId) {
        document.getElementById('createView').classList.add('hidden');
        document.getElementById('groupView').classList.remove('hidden');
        loadGroup();
    }
}

/**
 * Google Maps Autocomplete (é§…åäºˆæ¸¬)
 */
function setupAutocomplete(elementId) {
    const input = document.getElementById(elementId);
    const autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['transit_station'],
        componentRestrictions: { country: 'jp' },
        fields: ['name', 'geometry', 'formatted_address']
    });

    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;
        
        // "é§…"ã‚’å‰Šã‚‹å‡¦ç†ï¼ˆAPIé€£æºç”¨ï¼‰
        const cleanName = place.name.replace(/é§…$/g, '');
        selectedStation = {
            name: cleanName,
            lat: place.geometry.location.lat(),
            lng: place.geometry.location.lng()
        };
    });
}

/**
 * çµŒè·¯è¨ˆç®— (Directions API)
 */
let directionsService = null;
function getRouteInfo(origin, destination) {
    return new Promise((resolve) => {
        if (!directionsService) directionsService = new google.maps.DirectionsService();
        directionsService.route({
            origin: origin + "é§…",
            destination: destination + "é§…",
            travelMode: google.maps.TravelMode.TRANSIT,
            transitOptions: { routingPreference: google.maps.TransitRoutePreference.FEWER_TRANSFERS }
        }, (res, status) => {
            if (status === 'OK') {
                const leg = res.routes[0].legs[0];
                const transSteps = leg.steps.filter(s => s.travel_mode === 'TRANSIT');
                resolve({ duration: leg.duration.text, transfers: Math.max(0, transSteps.length - 1) });
            } else { resolve(null); }
        });
    });
}

/**
 * ã‚°ãƒ«ãƒ¼ãƒ—æ“ä½œ
 */
async function createGroup() {
    const name = document.getElementById('groupName').value.trim() || 'æ–°ã—ã„é›†ã¾ã‚Š';
    const docRef = await db.collection('groups').add({
        name, members: [], memberVotes: {}, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    groupId = docRef.id;
    window.history.pushState({}, '', `?g=${groupId}`);
    document.getElementById('createView').classList.add('hidden');
    document.getElementById('groupView').classList.remove('hidden');
    loadGroup();
}

function loadGroup() {
    document.getElementById('shareUrl').textContent = window.location.href;
    db.collection('groups').doc(groupId).onSnapshot(doc => {
        if (doc.exists) {
            groupData = doc.data();
            renderAll();
        }
    });
}

function renderAll() {
    const savedId = localStorage.getItem('aida_member_' + groupId);
    myMemberId = savedId;
    
    renderMembers(savedId);
    
    const sMembers = (groupData.members || []).filter(m => !m.anywhere && m.lat);
    if (sMembers.length >= 2) {
        document.getElementById('jumpButtons').classList.remove('hidden');
        document.getElementById('normalSection').classList.remove('hidden');
        document.getElementById('biasSection').classList.remove('hidden');
        document.getElementById('rankingSection').classList.remove('hidden');
        calculateNormal(sMembers);
        renderBiasOptions(sMembers);
        renderRanking();
    }
}

function renderMembers(savedId) {
    const list = document.getElementById('memberList');
    const members = groupData.members || [];
    document.getElementById('memberCount').textContent = members.length;
    
    if (members.length === 0) {
        list.innerHTML = '<p class="text-center text-slate-400 py-6 text-sm">ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‹Ÿé›†ã—ã¾ã—ã‚‡ã†</p>';
    } else {
        list.innerHTML = members.map(m => {
            const isMe = m.id === savedId;
            return `
            <div class="flex items-center gap-3 p-4 bg-white/60 rounded-2xl border border-white shadow-sm ${isMe ? 'ring-2 ring-indigo-400 bg-white' : ''}">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-pink-500 text-white flex items-center justify-center font-bold">${m.name[0]}</div>
                <div class="flex-1 overflow-hidden">
                    <p class="font-bold text-slate-900 truncate">${m.name} ${isMe ? '<span class="text-[10px] text-indigo-500 font-normal"> (è‡ªåˆ†)</span>' : ''}</p>
                    <p class="text-xs text-slate-500">${m.anywhere ? 'ğŸŒ ã©ã“ã§ã‚‚OK' : 'ğŸš‰ ' + m.station + 'é§…'}</p>
                </div>
                <div class="flex gap-1">
                    <button onclick="editMember('${m.id}')" class="p-2 text-slate-400 hover:text-indigo-500">âœï¸</button>
                    <button onclick="deleteMember('${m.id}')" class="p-2 text-slate-400 hover:text-red-500">ğŸ—‘ï¸</button>
                </div>
            </div>`;
        }).join('');
    }

    if (savedId && members.some(m => m.id === savedId)) {
        document.getElementById('joinBtn').classList.add('hidden');
        document.getElementById('joinForm').classList.add('hidden');
    }
}

/**
 * å€™è£œé§…è¨ˆç®— (HeartRails API + é‡è¤‡æ’é™¤)
 */
async function calculateNormal(sMembers) {
    const avgLat = sMembers.reduce((s, m) => s + m.lat, 0) / sMembers.length;
    const avgLng = sMembers.reduce((s, m) => s + m.lng, 0) / sMembers.length;

    try {
        const res = await fetch(`https://express.heartrails.com/api/json?method=getStations&x=${avgLng}&y=${avgLat}`);
        const data = await res.json();
        const rawStations = data.response?.station || [];
        
        // â˜… é§…åã®é‡è¤‡æ’é™¤ï¼ˆè·¯ç·šãŒé•ã£ã¦ã‚‚é§…åãŒåŒã˜ãªã‚‰1ã¤ã«ï¼‰
        const uniqueMap = new Map();
        rawStations.forEach(s => {
            if (!uniqueMap.has(s.name)) {
                uniqueMap.set(s.name, {
                    name: s.name,
                    lat: parseFloat(s.y),
                    lng: parseFloat(s.x),
                    line: s.line,
                    type: 'ğŸ“ ä¸­é–“åœ°ç‚¹ã®è¿‘ã'
                });
            }
        });

        const normalCandidates = Array.from(uniqueMap.values()).slice(0, 4);
        renderCandidatesUI('normalCandidates', normalCandidates, 'normal');
        updateGoogleMap('normalMap', normalCandidates, 'normal');
    } catch(e) { console.error(e); }
}

/**
 * åœ°å›³æ›´æ–° (Google MapsåŒ–)
 */
function updateGoogleMap(containerId, candidates, type) {
    const container = document.getElementById(containerId);
    if (!candidates.length) return;

    const center = { lat: candidates[0].lat, lng: candidates[0].lng };
    const map = new google.maps.Map(container, {
        center: center,
        zoom: 13,
        disableDefaultUI: true,
        zoomControl: true,
        styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
    });

    const bounds = new google.maps.LatLngBounds();
    candidates.forEach((c, idx) => {
        const marker = new google.maps.Marker({
            position: { lat: c.lat, lng: c.lng },
            map: map,
            label: { text: String(idx + 1), color: 'white', fontWeight: 'bold' },
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: type === 'normal' ? '#6366f1' : '#ec4899',
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: '#white',
                scale: 15
            }
        });
        bounds.extend(marker.getPosition());
    });
    map.fitBounds(bounds);
}

/**
 * å€™è£œUIè¡¨ç¤º (æŠ•ç¥¨ãƒã‚°ä¿®æ­£å«ã‚€)
 */
function renderCandidatesUI(targetId, candidates, section) {
    const myStation = (groupData.members || []).find(m => m.id === myMemberId)?.station;
    const votes = groupData.memberVotes || {};
    const myVotes = votes[myMemberId] || [];

    document.getElementById(targetId).innerHTML = candidates.map((c, i) => {
        const voteCount = Object.values(votes).filter(v => v.includes(c.name)).length;
        const isVoted = myVotes.includes(c.name);
        const infoId = `info-${section}-${i}`;

        if (myStation) {
            getRouteInfo(myStation, c.name).then(info => {
                const el = document.getElementById(infoId);
                if (el && info) el.innerHTML = `<span class="px-2 py-0.5 rounded bg-green-100 text-green-700 mr-2">${info.transfers === 0 ? 'âœ¨ ä¹—æ›ãªã—' : 'ä¹—æ› ' + info.transfers + 'å›'}</span><span>â± ${info.duration}</span>`;
            });
        }

        return `
        <div onclick="vote('${c.name}')" class="p-5 rounded-3xl border-2 transition-all cursor-pointer shadow-sm ${isVoted ? 'bg-green-50 border-green-400' : 'bg-white border-transparent hover:border-slate-200'}">
            <div class="flex justify-between items-start mb-2">
                <div class="flex items-center gap-3">
                    <span class="w-7 h-7 rounded-full flex items-center justify-center bg-slate-900 text-white text-xs font-bold">${i+1}</span>
                    <h3 class="font-black text-lg">${c.name}é§…</h3>
                </div>
                ${voteCount > 0 ? `<span class="px-3 py-1 bg-indigo-500 text-white text-[10px] font-bold rounded-full">${voteCount} ç¥¨</span>` : ''}
            </div>
            <p class="text-xs text-slate-400 mb-3">${c.line}</p>
            <div id="${infoId}" class="text-[11px] font-bold text-slate-600 mb-4 h-5 flex items-center"></div>
            <div class="grid grid-cols-2 gap-2">
                <a href="https://transit.yahoo.co.jp/search/result?from=${encodeURIComponent(c.name)}&to=${encodeURIComponent(myStation || '')}&type=last" target="_blank" onclick="event.stopPropagation()" class="py-2 bg-slate-800 text-white text-center text-[10px] font-bold rounded-xl">ğŸŒ™ çµ‚é›»æ¤œç´¢</a>
                <a href="https://www.google.com/search?q=${encodeURIComponent(c.name + 'é§… å±…é…’å±‹')}" target="_blank" onclick="event.stopPropagation()" class="py-2 bg-orange-500 text-white text-center text-[10px] font-bold rounded-xl">ğŸº åº—ã‚’æ¢ã™</a>
            </div>
        </div>`;
    }).join('');
}

/**
 * èª°ã‹ã«å¯„ã›ã‚‹
 */
function renderBiasOptions(sMembers) {
    document.getElementById('biasMemberList').innerHTML = sMembers.map(m => `
        <button onclick="calculateBias('${m.id}')" class="px-4 py-2 bg-pink-50 text-pink-600 border border-pink-100 rounded-full text-xs font-bold hover:bg-pink-100">${m.name}ã•ã‚“</button>
    `).join('');
}

async function calculateBias(mId) {
    const target = (groupData.members || []).find(m => m.id === mId);
    if (!target) return;

    try {
        const res = await fetch(`https://express.heartrails.com/api/json?method=getStations&x=${target.lng}&y=${target.lat}`);
        const data = await res.json();
        const raw = data.response?.station || [];
        
        const unique = new Map();
        raw.forEach(s => {
            if (!unique.has(s.name)) {
                unique.set(s.name, { name: s.name, lat: parseFloat(s.y), lng: parseFloat(s.x), line: s.line, type: 'ğŸ‘¤ è¿‘ãã®é§…' });
            }
        });

        const biasCandidates = Array.from(unique.values()).slice(0, 4);
        renderCandidatesUI('biasCandidates', biasCandidates, 'bias');
        updateGoogleMap('biasMap', biasCandidates, 'bias');
    } catch(e) { console.error(e); }
}

/**
 * æŠ•ç¥¨
 */
async function vote(sName) {
    if (!myMemberId) { alert('ã¾ãšã¯å‚åŠ ã—ã¦ãã ã•ã„'); return; }
    const votes = { ...(groupData.memberVotes || {}) };
    let myVotes = votes[myMemberId] || [];
    
    if (myVotes.includes(sName)) { myVotes = myVotes.filter(v => v !== sName); }
    else { myVotes.push(sName); }
    
    votes[myMemberId] = myVotes;
    await db.collection('groups').doc(groupId).update({ memberVotes: votes });
}

/**
 * å‚åŠ ãƒ»ç·¨é›†ãƒ­ã‚¸ãƒƒã‚¯
 */
function showJoinForm() {
    editTargetId = null;
    document.getElementById('formTitle').textContent = 'ğŸ™‹ å‚åŠ æƒ…å ±ã‚’å…¥åŠ›';
    document.getElementById('submitBtn').textContent = 'å‚åŠ ã™ã‚‹ â†’';
    document.getElementById('joinForm').classList.remove('hidden');
    document.getElementById('joinBtn').classList.add('hidden');
}

function editMember(mId) {
    const m = (groupData.members || []).find(x => x.id === mId);
    if (!m) return;
    editTargetId = mId;
    document.getElementById('nickname').value = m.name;
    document.getElementById('stationInput').value = m.station || '';
    document.getElementById('formTitle').textContent = 'âœï¸ æƒ…å ±ã‚’ç·¨é›†';
    document.getElementById('submitBtn').textContent = 'æ›´æ–°ã™ã‚‹ â†’';
    document.getElementById('joinForm').classList.remove('hidden');
    scrollToSection('joinForm');
}

async function joinOrUpdateGroup() {
    const name = document.getElementById('nickname').value.trim();
    if (!name) return alert('åå‰ã‚’å…¥ã‚Œã¦ãã ã•ã„');
    if (!isAnywhere && !selectedStation && !editTargetId) return alert('é§…åã‚’é¸æŠã—ã¦ãã ã•ã„');

    const members = [...(groupData.members || [])];
    const mData = {
        id: editTargetId || 'mem_' + Date.now(),
        name,
        anywhere: isAnywhere,
        station: isAnywhere ? null : (selectedStation ? selectedStation.name : (members.find(x=>x.id===editTargetId)?.station)),
        lat: isAnywhere ? null : (selectedStation ? selectedStation.lat : (members.find(x=>x.id===editTargetId)?.lat)),
        lng: isAnywhere ? null : (selectedStation ? selectedStation.lng : (members.find(x=>x.id===editTargetId)?.lng))
    };

    if (editTargetId) {
        const idx = members.findIndex(x => x.id === editTargetId);
        members[idx] = mData;
    } else {
        members.push(mData);
        localStorage.setItem('aida_member_' + groupId, mData.id);
    }

    await db.collection('groups').doc(groupId).update({ members });
    document.getElementById('joinForm').classList.add('hidden');
    selectedStation = null;
}

/**
 * ãã®ä»–ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 */
function toggleAnywhere() {
    isAnywhere = !isAnywhere;
    const box = document.getElementById('checkboxIcon');
    const wrap = document.getElementById('stationWrapper');
    if (isAnywhere) { box.innerHTML = 'âœ“'; box.classList.add('bg-amber-400'); wrap.classList.add('hidden'); }
    else { box.innerHTML = ''; box.classList.remove('bg-amber-400'); wrap.classList.remove('hidden'); }
}

async function deleteMember(mId) {
    if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    const members = (groupData.members || []).filter(x => x.id !== mId);
    const votes = { ...(groupData.memberVotes || {}) };
    delete votes[mId];
    await db.collection('groups').doc(groupId).update({ members, memberVotes: votes });
    if (mId === myMemberId) localStorage.removeItem('aida_member_' + groupId);
}

function scrollToSection(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }
function copyUrl() { navigator.clipboard.writeText(window.location.href); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
function shareToLine() { window.open(`https://line.me/R/msg/text/?${encodeURIComponent(groupData.name + ' ã®å ´æ‰€ã‚’æ±ºã‚ã‚ˆã†ï¼\n' + window.location.href)}`); }

// å‹é”è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
function openAddFriendModal() { document.getElementById('addFriendModal').classList.remove('hidden'); }
function closeAddFriendModal() { document.getElementById('addFriendModal').classList.add('hidden'); }
async function submitAddFriend() {
    const name = document.getElementById('addFriendNickname').value.trim();
    if (!name || !selectedStation) return alert('å…¥åŠ›ãŒè¶³ã‚Šã¾ã›ã‚“');
    const member = { id: 'mem_' + Date.now(), name, anywhere: false, station: selectedStation.name, lat: selectedStation.lat, lng: selectedStation.lng };
    await db.collection('groups').doc(groupId).update({ members: firebase.firestore.FieldValue.arrayUnion(member) });
    selectedStation = null;
    closeAddFriendModal();
}

function renderRanking() {
    const votes = groupData.memberVotes || {};
    const count = {};
    Object.values(votes).flat().forEach(s => count[s] = (count[s] || 0) + 1);
    const sorted = Object.entries(count).sort((a,b) => b[1] - a[1]);
    
    document.getElementById('rankingList').innerHTML = sorted.map(([name, v], i) => `
        <div class="flex items-center gap-4">
            <span class="text-lg font-black text-slate-300 w-6">${i+1}</span>
            <div class="flex-1 bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                <span class="font-bold">${name}é§…</span>
                <span class="text-xs font-bold px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full">${v} ç¥¨</span>
            </div>
        </div>
    `).join('') || '<p class="text-center py-6 text-slate-400 text-xs">ã¾ã æŠ•ç¥¨ãŒã‚ã‚Šã¾ã›ã‚“</p>';
}
</script>
