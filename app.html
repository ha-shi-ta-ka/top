/** * ãŠåº—æƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
 */
function fetchTopRatedShop(lat, lng, stationName, elementId) {
    const el = document.getElementById(elementId);
    if (!el) return;

    // Google Places Serviceã®åˆæœŸåŒ–ï¼ˆãƒ€ãƒŸãƒ¼è¦ç´ ã‚’ä½¿ç”¨ï¼‰
    const service = new google.maps.places.PlacesService(document.createElement('div'));
    
    const request = {
        location: new google.maps.LatLng(lat, lng),
        radius: 800, // æ¤œç´¢ç¯„å›²ã‚’å°‘ã—åºƒã‚ã«
        type: ['restaurant']
    };

    service.nearbySearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
            // è©•ä¾¡(rating)ãŒé«˜ã„é †ã€ã‹ã¤ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ãŒã‚ã‚‹ç¨‹åº¦ã‚ã‚‹é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedShops = results
                .filter(r => r.rating && r.user_ratings_total > 5) // ä¿¡é ¼æ€§ã®ä½ã„åº—ã‚’é™¤å¤–
                .sort((a, b) => b.rating - a.rating);

            const topShop = sortedShops.length > 0 ? sortedShops[0] : results[0];
            
            // æ˜Ÿã®çµµæ–‡å­—ç”Ÿæˆ
            const stars = "â˜…".repeat(Math.floor(topShop.rating || 0)) + (topShop.rating % 1 >= 0.5 ? "â˜†" : "");
            
            // ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼æ¤œç´¢URLï¼ˆã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆç”¨ãƒ™ãƒ¼ã‚¹ï¼‰
            // åº—åã§æ¤œç´¢ã™ã‚‹ã‚ˆã†ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
            const hpSearchUrl = `https://www.hotpepper.jp/SA11/sk${encodeURIComponent(stationName)}/`;
            const shopSpecificUrl = `https://www.hotpepper.jp/gstr000/sk${encodeURIComponent(topShop.name)}/`;

            el.innerHTML = `
                <div class="flex flex-col gap-2 animate-fade-in">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <p class="text-[11px] font-black text-slate-800 truncate">${topShop.name}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[10px] text-amber-500 font-bold">${topShop.rating || '-'} ${stars}</span>
                                <span class="text-[9px] text-slate-400">(${topShop.user_ratings_total || 0}ä»¶)</span>
                            </div>
                        </div>
                        <span class="shrink-0 text-[8px] font-black bg-white px-2 py-0.5 rounded-full border border-slate-200 text-slate-400 shadow-sm uppercase">Google Rank #1</span>
                    </div>
                    
                    <div class="grid grid-cols-1 mt-1">
                        <a href="${shopSpecificUrl}" target="_blank" onclick="event.stopPropagation()" 
                           class="py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white text-center text-[10px] rounded-xl font-black shadow-lg shadow-orange-100 active:scale-95 transition-transform">
                            ğŸ”¥ ã“ã®ãŠåº—ã‚’äºˆç´„ã™ã‚‹
                        </a>
                    </div>
                    <p class="text-[8px] text-center text-slate-300">â€»æº€å¸­ã®å ´åˆã¯é§…å‘¨è¾ºã®åˆ¥åº—èˆ—ã‚’ã”æ¤œè¨ãã ã•ã„</p>
                </div>
            `;
        } else {
            // ãŠåº—ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const hpUrl = `https://www.hotpepper.jp/SA11/sk${encodeURIComponent(stationName)}/`;
            el.innerHTML = `
                <a href="${hpUrl}" target="_blank" onclick="event.stopPropagation()" 
                   class="block py-3 bg-slate-100 text-slate-500 text-center text-[10px] rounded-xl font-bold border border-dashed border-slate-300">
                    ğŸº ${stationName}é§…å‘¨è¾ºã®ãŠåº—ã‚’æ¤œç´¢
                </a>
            `;
        }
    });
}

/** * ã‚«ãƒ¼ãƒ‰æç”»é–¢æ•°ï¼ˆå¾®èª¿æ•´ï¼‰
 */
function renderCards(containerId, candidates, section) {
    const me = groupData.members.find(m => m.id === myMemberId);
    const votes = groupData.memberVotes || {};
    const myVotes = votes[myMemberId] || [];
    
    const dateStr = document.getElementById('meetDate')?.value;
    let dateParams = '';
    let lastTrainParams = '&type=2';
    
    if (dateStr) {
        const d = new Date(dateStr);
        const y = d.getFullYear();
        const m = d.getMonth() + 1;
        const day = d.getDate();
        dateParams = `&y=${y}&m=${m}&d=${day}&hh=18&m1=0&m2=0&type=1`;
        lastTrainParams = `&y=${y}&m=${m}&d=${day}&hh=23&m1=0&m2=0&type=2`;
    }

    document.getElementById(containerId).innerHTML = candidates.map((c, i) => {
        const isVoted = myVotes.includes(c.name);
        const vCount = Object.values(votes).filter(v => v.includes(c.name)).length;
        const shopInfoId = `shop-${section}-${i}`;
        
        // æç”»ãŒå®Œäº†ã—ãŸç›´å¾Œã«APIã‚’å©ã
        setTimeout(() => {
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                fetchTopRatedShop(c.lat, c.lng, c.name, shopInfoId);
            }
        }, 300 + (i * 200)); // æç”»ãƒ©ã‚°ã‚’è€ƒæ…®ã—ã¦å°‘ã—é•·ã‚ã«è¨­å®š

        const routeUrl = `https://transit.yahoo.co.jp/search/result?from=${encodeURIComponent(me?.station || '')}é§…&to=${encodeURIComponent(c.name)}é§…${dateParams}`;
        const lastTrainUrl = `https://transit.yahoo.co.jp/search/result?from=${encodeURIComponent(c.name)}é§…&to=${encodeURIComponent(me?.station || '')}é§…${lastTrainParams}`;

        return `
            <div onclick="vote('${c.name}')" class="candidate-card p-5 rounded-[2rem] border-2 shadow-sm cursor-pointer ${isVoted ? 'bg-green-50 border-green-400' : 'bg-white border-slate-50 hover:border-slate-200'}">
                <div class="flex justify-between items-center mb-1">
                    <div class="flex items-center gap-2">
                        <span class="w-6 h-6 rounded-full bg-slate-900 text-white text-[10px] flex items-center justify-center font-black">${i+1}</span>
                        <h3 class="font-black text-lg text-slate-800">${c.name}é§…</h3>
                    </div>
                    ${vCount > 0 ? `<span class="px-3 py-1 bg-indigo-600 text-white text-[10px] rounded-full font-black">${vCount} ç¥¨</span>` : ''}
                </div>
                <p class="text-[10px] text-slate-400 mb-3 ml-8">${c.line}</p>
                
                <div id="${shopInfoId}" class="p-4 bg-slate-50 rounded-2xl border border-slate-100 mb-4 min-h-[80px] flex flex-col justify-center">
                    <div class="flex items-center justify-center gap-2 text-slate-400">
                        <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p class="text-[10px]">äººæ°—åº—ã‚’æ¤œç´¢ä¸­...</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <a href="${routeUrl}" target="_blank" onclick="event.stopPropagation()" class="py-3 bg-indigo-600 text-white text-center text-[10px] rounded-xl font-bold">ğŸšƒ çµŒè·¯</a>
                    <a href="${lastTrainUrl}" target="_blank" onclick="event.stopPropagation()" class="py-3 bg-slate-800 text-white text-center text-[10px] rounded-xl font-bold">ğŸŒ™ çµ‚é›»</a>
                </div>
            </div>
        `;
    }).join('');
}
