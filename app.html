<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fairway Meet - ã‚´ãƒ«ãƒ•ã®å ´æ‰€æ±ºã‚</title>
    <meta name="description" content="ã‚´ãƒ«ãƒ•ã®å ´æ‰€æ±ºã‚ã‚’ã€ãƒ‡ãƒ¼ã‚¿ã§æ°‘ä¸»çš„ã«è§£æ±ºã€‚ä¸­é–“åœ°ç‚¹è¨ˆç®—ã€ãƒˆãƒ¼ã‚¿ãƒ«ã‚³ã‚¹ãƒˆæ¯”è¼ƒã€åŒ¿åæŠ•ç¥¨ã§å…¬å¹³ã«æ±ºã¾ã‚‹ã€‚">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WCDYPYTJE3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-WCDYPYTJE3');
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Outfit:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDzpRxX5te8hcxf_az6n92FTkoRbyCEXwI&libraries=places&callback=initMap"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'], heading: ['"Outfit"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0fdf4', 100: '#dcfce7', 500: '#22c55e', 600: '#16a34a', 900: '#14532d' },
                        accent: { 500: '#eab308' }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-6px)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f0fdf4; color: #1e293b; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        .glass {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.7);
            border-radius: 1.5rem;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .glass-card:active { transform: scale(0.98); }
        
        .aurora-bg {
            background: 
                radial-gradient(at 0% 0%, rgba(34, 197, 94, 0.15) 0, transparent 50%),
                radial-gradient(at 100% 0%, rgba(234, 179, 8, 0.1) 0, transparent 50%),
                radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.1) 0, transparent 50%);
            position: fixed; inset: 0; z-index: -1;
        }

        .map-container { height: 340px; border-radius: 1.5rem; width: 100%; z-index: 1; border: 4px solid white; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .tab-active { color: #15803d; border-bottom: 3px solid #22c55e; }
        .tab-inactive { color: #94a3b8; }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="aurora-bg"></div>

    <nav class="fixed top-0 left-0 right-0 z-50 glass px-6 py-4 border-b border-white/50">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2 group cursor-pointer">
                <span class="text-2xl pt-1 drop-shadow-sm group-hover:scale-110 transition-transform">â›³ï¸</span>
                <span class="text-xl font-black tracking-tighter text-brand-900 font-heading">Fairway Meet</span>
            </a>
            <button onclick="shareGroupInfo()" class="bg-white/80 text-brand-600 px-4 py-2 rounded-full text-xs font-bold hover:bg-white transition-all active:scale-95 flex items-center gap-2 shadow-sm border border-brand-100 backdrop-blur-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
                æ‹›å¾…
            </button>
        </div>
    </nav>

    <main class="relative z-10 max-w-2xl mx-auto px-4 pt-24 pb-32">
        
        <div id="loading" class="fixed inset-0 bg-white/90 backdrop-blur-md z-[100] flex flex-col items-center justify-center hidden">
            <div class="animate-spin rounded-full h-14 w-14 border-[5px] border-brand-100 border-t-brand-600 mb-4"></div>
            <p class="text-brand-600 font-bold text-sm tracking-widest animate-pulse">CALCULATING FAIRNESS...</p>
        </div>

        <div id="createView" class="fade-in">
            <div class="glass p-8 text-center rounded-[2.5rem] shadow-xl">
                <div class="w-24 h-24 bg-gradient-to-br from-brand-500 to-green-300 rounded-[2rem] flex items-center justify-center text-5xl mx-auto mb-8 shadow-lg text-white animate-float">
                    ğŸš˜
                </div>
                <h1 class="text-3xl font-black mb-3 text-slate-800 font-heading">ã‚´ãƒ«ãƒ•å ´èª¿æ•´</h1>
                <p class="text-slate-500 text-sm mb-10 font-medium leading-relaxed">ç§»å‹•ã®è‹¦åŠ´ã¨è²»ç”¨ã®ä¸å…¬å¹³ã‚’è§£æ±ºã€‚<br>å…¨å“¡ã®ã€ŒçœŸã‚“ä¸­ã€ã‚’ææ¡ˆã—ã¾ã™ã€‚</p>
                <div class="relative mb-6">
                    <input type="text" id="groupName" placeholder="ä¾‹: GWã‚´ãƒ«ãƒ•ã‚³ãƒ³ãƒš ğŸ†" 
                        class="w-full px-6 py-5 rounded-2xl bg-white border border-brand-100 focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 outline-none text-xl text-slate-800 transition-all placeholder:text-slate-300 font-bold text-center shadow-inner">
                </div>
                <button onclick="createGroup()" class="w-full py-5 rounded-2xl bg-brand-600 text-white font-bold text-xl shadow-xl shadow-brand-600/30 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2">
                    ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ ğŸš€
                </button>
            </div>
        </div>

        <div id="groupView" class="hidden space-y-6">
            <div class="fade-in glass p-6 relative overflow-hidden group rounded-[2rem] border border-white/60">
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 id="groupTitleDisplay" class="text-2xl font-black text-slate-800 line-clamp-1 font-heading tracking-tight">Group</h2>
                            <p class="text-xs text-slate-400 font-bold mt-1 uppercase tracking-wider">Members: <span id="memberCount" class="text-brand-600 text-lg">0</span></p>
                        </div>
                        <button onclick="openAddFriendModal()" class="bg-white text-brand-600 p-3 rounded-2xl transition-all active:scale-90 border border-brand-100 shadow-sm hover:shadow-md hover:bg-brand-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z" /></svg>
                        </button>
                    </div>
                    <div class="flex gap-3 overflow-x-auto hide-scrollbar pb-2" id="memberList"></div>
                    <div id="actionArea" class="mt-6"></div>
                </div>
            </div>

            <div id="mainContent" class="hidden fade-in" style="animation-delay: 0.1s;">
                <div class="flex border-b border-brand-200 mb-6 sticky top-[72px] bg-[#f0fdf4]/95 backdrop-blur-xl z-40 px-2 pt-2">
                    <button onclick="switchTab('normal')" id="tab-normal" class="flex-1 py-3 text-sm font-bold transition-all tracking-wide tab-active">ğŸ“ å€™è£œã‚³ãƒ¼ã‚¹</button>
                    <button onclick="switchTab('ranking')" id="tab-ranking" class="flex-1 py-3 text-sm font-bold transition-all tracking-wide tab-inactive">ğŸ† æŠ•ç¥¨çµæœ</button>
                </div>

                <div id="content-normal" class="space-y-6">
                    <div class="relative group rounded-[2rem] overflow-hidden shadow-xl border-4 border-white">
                        <div id="normalMap" class="map-container" style="border:none; border-radius: 0;"></div>
                        <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur px-4 py-2 rounded-xl shadow-lg border border-white/50 z-[400]">
                            <span class="text-[10px] text-brand-600 font-bold uppercase tracking-wider block">AI Analysis</span>
                            <span class="text-xs text-slate-800 font-bold">å…¨å“¡ã®ä¸å…¬å¹³æŒ‡æ•°ã‚’æœ€å°åŒ–</span>
                        </div>
                    </div>
                    <div id="normalCandidates" class="grid gap-4"></div>
                </div>

                <div id="content-ranking" class="hidden space-y-4">
                    <div class="glass p-6 rounded-[2rem]">
                        <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2 text-lg"><span class="text-2xl">ğŸ“Š</span> æŠ•ç¥¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                        <div id="rankingList" class="space-y-3"></div>
                    </div>
                    <div class="glass p-6 rounded-[2rem]">
                        <h3 class="font-bold text-slate-400 mb-4 text-xs uppercase tracking-widest">æŠ•ç¥¨ã®å†…è¨³</h3>
                        <div id="votersDetail" class="text-sm space-y-3 font-medium text-slate-600"></div>
                    </div>
                </div>
            </div>
            
            <div id="emptyState" class="text-center py-20 opacity-60 fade-in" style="animation-delay: 0.2s;">
                <div class="text-6xl mb-6 animate-bounce">â›³ï¸</div>
                <p class="font-bold text-lg text-slate-800">ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²å¾…ã¡...</p>
                <p class="text-sm text-slate-500 mt-2">ã‚ã¨1äººä»¥ä¸ŠãŒå‡ºç™ºåœ°ã‚’å…¥åŠ›ã™ã‚‹ã¨<br>æœ€é©ãªã‚´ãƒ«ãƒ•å ´ã‚’ææ¡ˆã—ã¾ã™</p>
            </div>
        </div>
    </main>

    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] hidden opacity-0 transition-opacity duration-300 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div id="modalContent" class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 shadow-2xl transform translate-y-full sm:translate-y-10 transition-transform duration-300">
            <div class="w-12 h-1.5 bg-slate-100 rounded-full mx-auto mb-8 sm:hidden"></div>
            <h2 id="modalTitle" class="text-xl font-black text-slate-900 mb-8 text-center font-heading">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h2>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">ãŠåå‰</label>
                    <input type="text" id="nickname" class="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-100 focus:border-brand-500 focus:bg-white outline-none text-slate-800 font-bold transition-all text-lg shadow-inner">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">å‡ºç™ºåœ° (IC / æœ€å¯„ã‚Šé§…)</label>
                    <div class="relative">
                        <input type="text" id="stationInput" placeholder="ä¾‹: ç·´é¦¬ICã€æ–°å®¿é§…" oninput="searchStationDebounced()" 
                            class="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-100 focus:border-brand-500 focus:bg-white outline-none text-slate-800 font-bold transition-all text-lg shadow-inner placeholder:text-slate-300">
                        <div id="suggestions" class="absolute left-0 right-0 top-full mt-2 bg-white rounded-2xl shadow-xl border border-slate-100 max-h-48 overflow-y-auto hidden z-50"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">ç§»å‹•æ‰‹æ®µ</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="carStatus" value="driver" class="peer sr-only" checked>
                            <div class="rounded-xl border border-slate-200 bg-white p-3 text-center transition-all peer-checked:border-brand-500 peer-checked:bg-brand-50 peer-checked:text-brand-700 hover:bg-slate-50 shadow-sm">
                                <div class="text-2xl mb-1">ğŸš—</div><div class="text-[10px] font-bold">è»Šå‡ºã™</div>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="carStatus" value="passenger" class="peer sr-only">
                            <div class="rounded-xl border border-slate-200 bg-white p-3 text-center transition-all peer-checked:border-brand-500 peer-checked:bg-brand-50 peer-checked:text-brand-700 hover:bg-slate-50 shadow-sm">
                                <div class="text-2xl mb-1">ğŸ™‹â€â™‚ï¸</div><div class="text-[10px] font-bold">ä¹—ã›ã¦</div>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="carStatus" value="train" class="peer sr-only">
                            <div class="rounded-xl border border-slate-200 bg-white p-3 text-center transition-all peer-checked:border-brand-500 peer-checked:bg-brand-50 peer-checked:text-brand-700 hover:bg-slate-50 shadow-sm">
                                <div class="text-2xl mb-1">ğŸšƒ</div><div class="text-[10px] font-bold">ç¾åœ°é›†åˆ</div>
                            </div>
                        </label>
                    </div>
                </div>
                <label class="flex items-center gap-4 p-4 rounded-2xl border border-slate-100 bg-slate-50/50 cursor-pointer hover:bg-slate-50 transition-colors group">
                    <input type="checkbox" id="anywhereCheck" onchange="toggleAnywhere()" class="w-6 h-6 text-brand-600 rounded-lg focus:ring-offset-0 bg-white border-slate-300">
                    <span class="text-sm font-bold text-slate-500 group-hover:text-slate-700 transition-colors">â›³ï¸ ã‚´ãƒ«ãƒ•å ´ãªã‚‰ã©ã“ã§ã‚‚ (è¨ˆç®—å¯¾è±¡å¤–)</span>
                </label>
                <div class="pt-4 flex gap-3">
                    <button onclick="closeModal()" class="flex-1 py-4 rounded-2xl bg-slate-100 text-slate-500 font-bold hover:bg-slate-200 transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="submitMember()" class="flex-1 py-4 rounded-2xl bg-brand-600 text-white font-bold hover:bg-brand-700 shadow-lg shadow-brand-500/30 transition-all active:scale-95">ä¿å­˜ã™ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCxj6Qxk6PkL9WhbIQZh_wCwlhZBdY8MrQ",
            authDomain: "aida-f2eb3.firebaseapp.com",
            projectId: "aida-f2eb3",
            storageBucket: "aida-f2eb3.firebasestorage.app",
            messagingSenderId: "124876591098",
            appId: "1:124876591098:web:93bef3d94de8cf37799e43"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- Config ---
        const COLLECTION_NAME = 'golf_groups';
        const STORAGE_KEY_PREFIX = 'fairway_mem_';
        const TOAST_OPT = { 
            duration: 2500, gravity: "top", position: "center", 
            style: { background: "#14532d", borderRadius: "16px", fontWeight: "bold", fontSize: "14px", boxShadow: "0 10px 30px -10px rgba(0,0,0,0.2)" }
        };

        // --- State ---
        let groupId = new URLSearchParams(window.location.search).get('g');
        let groupData = null;
        let myMemberId = null;
        let selectedStation = null;
        let googleMap = null;
        let mapMarkers = [];
        let calculatedCandidates = []; 
        let lastMemberHash = "";
        let isProxyMode = false;

        // --- Google Maps Init ---
        function initMap() {
            // Callback when script loads
        }

        // --- Lifecycle ---
        if (groupId) {
            document.getElementById('createView').classList.add('hidden');
            document.getElementById('groupView').classList.remove('hidden');
            initGroup();
        }

        async function createGroup() {
            const name = document.getElementById('groupName').value.trim() || 'ã‚´ãƒ«ãƒ•ä¼š';
            showLoading(true);
            try {
                const docRef = await db.collection(COLLECTION_NAME).add({ 
                    name, members: [], memberVotes: {}, candidates: [], 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                });
                groupId = docRef.id;
                window.history.pushState({}, '', `?g=${groupId}`);
                confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 }, colors: ['#22c55e', '#eab308'] });
                document.getElementById('createView').classList.add('hidden');
                document.getElementById('groupView').classList.remove('hidden');
                initGroup();
            } catch(e) { console.error(e); Toastify({ ...TOAST_OPT, text: "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", style: { background: "#ef4444" } }).showToast(); } 
            finally { showLoading(false); }
        }

        function initGroup() {
            const savedId = localStorage.getItem(`${STORAGE_KEY_PREFIX}${groupId}`);
            if(savedId) myMemberId = savedId;

            db.collection(COLLECTION_NAME).doc(groupId).onSnapshot(doc => {
                if (doc.exists) {
                    groupData = doc.data();
                    renderMemberSection();
                    renderRanking();
                    
                    const validMembers = groupData.members.filter(m => !m.anywhere && m.lat);
                    const currentHash = JSON.stringify(groupData.members.map(m => m.station).sort());

                    if (groupData.candidates && groupData.candidates.length > 0) {
                        calculatedCandidates = groupData.candidates;
                        renderMainContent();
                    } else if (validMembers.length >= 2) {
                        if (currentHash !== lastMemberHash) {
                            lastMemberHash = currentHash;
                            generateGolfCandidates(validMembers);
                        }
                    } else {
                        document.getElementById('emptyState').classList.remove('hidden');
                        document.getElementById('mainContent').classList.add('hidden');
                    }
                }
            });
        }

        async function generateGolfCandidates(members) {
            const avgLat = members.reduce((s, m) => s + m.lat, 0) / members.length;
            const avgLng = members.reduce((s, m) => s + m.lng, 0) / members.length;
            
            // Dummy Data (In production, replace with GORA/Place API call)
            const dummyGolfCourses = [
                { name: "å¯Œå£«ãƒ¬ã‚¤ã‚¯ã‚µã‚¤ãƒ‰CC", price: 12000, travelCost: 4500, rating: 4.5, lat: avgLat + 0.04, lng: avgLng + 0.02, type: "ğŸ‘‘ ãƒ™ã‚¹ãƒˆãƒãƒ©ãƒ³ã‚¹" },
                { name: "è¶³æŸ„æ£®æ—ã‚«ãƒ³ãƒˆãƒªãƒ¼", price: 9800, travelCost: 5200, rating: 4.2, lat: avgLat - 0.03, lng: avgLng + 0.01, type: "ğŸ’° ã‚³ã‚¹ãƒ‘é‡è¦–" },
                { name: "å—ç·ãƒ’ãƒ«ã‚ºã‚´ãƒ«ãƒ•", price: 15000, travelCost: 3000, rating: 4.8, lat: avgLat + 0.01, lng: avgLng - 0.05, type: "â­ï¸ é«˜è©•ä¾¡ãƒ»è¿‘å ´" },
                { name: "éœãƒ¶æµ¦ãƒªãƒ³ã‚¯ã‚¹", price: 8500, travelCost: 6000, rating: 3.8, lat: avgLat - 0.02, lng: avgLng - 0.03, type: "ğŸš— ã‚¤ãƒ³ã‚¿ãƒ¼è‡³è¿‘" },
            ];
            await db.collection(COLLECTION_NAME).doc(groupId).update({ candidates: dummyGolfCourses });
        }

        // --- UI ---
        function getAvatarUrl(name) { return `https://api.dicebear.com/7.x/notionists/svg?seed=${encodeURIComponent(name)}&backgroundColor=dcfce7,f0fdf4`; }

        function renderMemberSection() {
            document.getElementById('groupTitleDisplay').textContent = groupData.name;
            document.getElementById('memberCount').textContent = groupData.members.length;
            const list = document.getElementById('memberList');
            list.innerHTML = groupData.members.map(m => {
                const isMe = m.id === myMemberId;
                let icon = "ğŸš™"; if(m.carStatus === 'passenger') icon = "ğŸ™‹â€â™‚ï¸"; if(m.carStatus === 'train') icon = "ğŸšƒ";
                return `
                <div class="flex-shrink-0 flex flex-col items-center gap-2 group cursor-pointer min-w-[70px]" onclick="deleteMember('${m.id}')">
                    <div class="relative">
                        <img src="${getAvatarUrl(m.name)}" class="w-14 h-14 rounded-2xl bg-white border-2 ${isMe ? 'border-brand-500 shadow-lg' : 'border-brand-100'} object-cover">
                        <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-white rounded-full border border-slate-100 flex items-center justify-center text-xs shadow-sm">${icon}</div>
                    </div>
                    <p class="text-[11px] font-bold text-slate-700 truncate max-w-[70px]">${m.name}</p>
                </div>
            `}).join('');

            const actionArea = document.getElementById('actionArea');
            const me = groupData.members.find(m => m.id === myMemberId);
            if (myMemberId && me) {
                actionArea.innerHTML = `
                    <div onclick="showEditModal()" class="glass-card p-4 flex justify-between items-center cursor-pointer hover:bg-white transition-colors group border border-brand-100 shadow-sm rounded-2xl">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-brand-50 flex items-center justify-center text-xl">ğŸ§¢</div>
                            <div><p class="text-[10px] text-brand-600 font-bold uppercase">MY ENTRY</p><p class="font-bold text-slate-800 text-lg">${me.anywhere ? "ã©ã“ã§ã‚‚" : me.station}</p></div>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 group-hover:text-brand-600 transition-colors">âœ</div>
                    </div>`;
            } else {
                actionArea.innerHTML = `<button onclick="showJoinModal()" class="w-full py-4 rounded-2xl bg-gradient-to-r from-brand-600 to-brand-500 text-white font-bold text-lg shadow-xl hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-3"><span>ğŸš™</span> å‚åŠ ãƒ»å‡ºç™ºåœ°ç™»éŒ²</button>`;
            }
        }

        async function deleteMember(id) {
            if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            const newM = groupData.members.filter(m => m.id !== id);
            await db.collection(COLLECTION_NAME).doc(groupId).update({ members: newM });
            if(id === myMemberId) { myMemberId = null; localStorage.removeItem(`${STORAGE_KEY_PREFIX}${groupId}`); }
        }

        function renderMainContent() {
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            // Google Map Logic
            if (!googleMap && window.google) {
                const center = { lat: calculatedCandidates[0].lat, lng: calculatedCandidates[0].lng };
                googleMap = new google.maps.Map(document.getElementById('normalMap'), {
                    center: center, zoom: 12, disableDefaultUI: true,
                    styles: [ { "featureType": "poi.business", "stylers": [ { "visibility": "off" } ] }, { "featureType": "poi.park", "elementType": "geometry", "stylers": [ { "color": "#e5e5e5" } ] } ]
                });
            }

            if (googleMap) {
                mapMarkers.forEach(m => m.setMap(null));
                mapMarkers = [];
                const bounds = new google.maps.LatLngBounds();
                
                calculatedCandidates.forEach((c, i) => {
                    const isBest = i === 0;
                    const marker = new google.maps.Marker({
                        position: { lat: c.lat, lng: c.lng },
                        map: googleMap,
                        label: { text: (i + 1).toString(), color: "white", fontWeight: "bold" },
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE, scale: isBest ? 18 : 14,
                            fillColor: isBest ? "#22c55e" : "#64748b", fillOpacity: 1, strokeColor: "white", strokeWeight: 2,
                        }
                    });
                    bounds.extend(marker.getPosition());
                    mapMarkers.push(marker);
                });
                googleMap.fitBounds(bounds);
            }

            // Cards
            const votes = groupData.memberVotes || {};
            const myVotes = votes[myMemberId] || [];
            document.getElementById('normalCandidates').innerHTML = calculatedCandidates.map((c, i) => {
                let voteCount = 0; Object.values(votes).forEach(v => { if(v.includes(c.name)) voteCount++; });
                const isVoted = myVotes.includes(c.name);
                const isTop = i === 0;
                const totalCost = (c.price + c.travelCost).toLocaleString();
                return `
                <div class="glass-card p-5 relative overflow-hidden group cursor-pointer transition-all ${isVoted ? 'ring-2 ring-brand-500 bg-brand-50/50' : 'hover:bg-white'}" onclick="toggleVote('${c.name}')">
                    ${isTop ? '<div class="absolute top-0 right-0 bg-brand-500 text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl shadow-sm">AI æ¨å¥¨ No.1</div>' : ''}
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl ${isTop ? 'bg-brand-500 text-white' : 'bg-slate-100 text-slate-500'} flex items-center justify-center font-black text-xl">${i+1}</div>
                            <div>
                                <h3 class="font-bold text-lg text-slate-900 leading-tight">${c.name}</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs font-bold text-brand-700 bg-brand-100 px-2 py-0.5 rounded-md">å®Ÿè³ª Â¥${totalCost}</span>
                                    <span class="text-[10px] text-slate-400">(ãƒ—ãƒ¬ãƒ¼Â¥${c.price.toLocaleString()} + ç§»å‹•Â¥${c.travelCost.toLocaleString()})</span>
                                </div>
                            </div>
                        </div>
                        <div class="pt-6">${voteCount > 0 ? `<div class="bg-brand-900 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md">ğŸ‘ ${voteCount}</div>` : ''}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 relative z-10">
                        <button onclick="event.stopPropagation(); window.open('https://search.google.com/local/writereview?placeid=${c.name}')" class="bg-white border border-slate-200 py-2.5 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-50 transition-colors flex items-center justify-center gap-1.5 shadow-sm"><span>ğŸ“±</span> è©³ç´°ãƒ»äºˆç´„</button>
                        <button class="py-2.5 rounded-xl text-xs font-bold transition-all shadow-sm flex items-center justify-center gap-1.5 ${isVoted ? 'bg-brand-600 text-white' : 'bg-brand-900 text-white hover:bg-brand-800'}"><span>${isVoted ? 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' : 'æŠ•ç¥¨ã™ã‚‹'}</span></button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderRanking() {
            const votes = groupData.memberVotes || {};
            const counts = {}; Object.values(votes).forEach(arr => arr.forEach(s => counts[s] = (counts[s]||0)+1));
            const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]);
            document.getElementById('rankingList').innerHTML = sorted.length ? sorted.map(([n, c], i) => `
                <div class="flex items-center gap-4 p-4 bg-white/50 rounded-2xl border border-slate-100">
                    <span class="text-2xl font-black text-slate-200 w-8 text-center">${i+1}</span>
                    <span class="flex-1 font-bold text-slate-800 text-lg">${n}</span>
                    <span class="font-black text-brand-600 text-xl">${c}<span class="text-xs text-slate-400 ml-1 font-medium">ç¥¨</span></span>
                </div>
            `).join('') : '<p class="text-center text-slate-400 text-xs py-4">ã¾ã æŠ•ç¥¨ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            
            const details = [];
            groupData.members.forEach(m => { const v = votes[m.id] || []; if(v.length) details.push(`<div class="flex justify-between border-b border-slate-100 pb-2 last:border-0"><span>${m.name}</span><span class="text-slate-500 text-xs">${v.join(', ')}</span></div>`); });
            document.getElementById('votersDetail').innerHTML = details.join('');
        }

        async function toggleVote(name) {
            if(!myMemberId) return showJoinModal();
            const votes = groupData.memberVotes || {};
            let my = votes[myMemberId] || [];
            if(my.includes(name)) my = my.filter(v => v !== name);
            else { my.push(name); confetti({ particleCount: 30, colors: ['#22c55e', '#eab308'], origin: { y: 0.7 } }); }
            votes[myMemberId] = my;
            await db.collection(COLLECTION_NAME).doc(groupId).update({ memberVotes: votes });
        }

        // --- Modal & Search ---
        const modal = document.getElementById('modalOverlay');
        const modalContent = document.getElementById('modalContent');
        function showJoinModal() { isProxyMode = false; openModal("ã‚ãªãŸã®æƒ…å ±ã‚’å…¥åŠ›"); }
        function openAddFriendModal() { isProxyMode = true; openModal("å‹é”ã‚’è¿½åŠ  (ä»£ç†)"); }
        function showEditModal() { 
            isProxyMode = false; 
            const me = groupData.members.find(m => m.id === myMemberId);
            openModal("æƒ…å ±ã‚’å¤‰æ›´");
            document.getElementById('nickname').value = me.name;
            document.getElementById('stationInput').value = me.station || '';
            document.getElementById('anywhereCheck').checked = me.anywhere;
            if(me.carStatus) document.querySelector(`input[name="carStatus"][value="${me.carStatus}"]`).checked = true;
            selectedStation = me.station ? { name: me.station, lat: me.lat, lng: me.lng } : null;
        }
        function openModal(title) {
            document.getElementById('modalTitle').textContent = title;
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modalContent.classList.remove('translate-y-full'); modalContent.classList.add('sm:translate-y-0'); }, 10);
        }
        function closeModal() {
            modal.classList.add('opacity-0'); modalContent.classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 300);
            if(!isProxyMode) { document.getElementById('nickname').value=''; document.getElementById('stationInput').value=''; }
        }

        async function submitMember() {
            const name = document.getElementById('nickname').value.trim();
            const any = document.getElementById('anywhereCheck').checked;
            const carStatus = document.querySelector('input[name="carStatus"]:checked').value;
            if (!name) return Toastify({ ...TOAST_OPT, text: "åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", style: { background: "#ef4444" } }).showToast();
            if (!any && !selectedStation) return Toastify({ ...TOAST_OPT, text: "å ´æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„", style: { background: "#ef4444" } }).showToast();
            
            showLoading(true);
            const id = (!isProxyMode && myMemberId) ? myMemberId : `mem_${Date.now()}_${Math.random().toString(36).substr(2,5)}`;
            const data = { id, name, anywhere: any, carStatus, station: any ? null : selectedStation.name, lat: any ? null : selectedStation.lat, lng: any ? null : selectedStation.lng };
            
            const newM = [...(groupData.members||[])];
            const idx = newM.findIndex(m => m.id === id);
            if(idx >= 0) newM[idx] = data; else newM.push(data);
            
            try {
                await db.collection(COLLECTION_NAME).doc(groupId).update({ members: newM });
                if(!isProxyMode) { myMemberId = id; localStorage.setItem(`${STORAGE_KEY_PREFIX}${groupId}`, id); }
                closeModal();
                Toastify({ ...TOAST_OPT, text: isProxyMode ? "è¿½åŠ ã—ã¾ã—ãŸï¼" : "å®Œäº†ã—ã¾ã—ãŸï¼", style: { background: "#22c55e" } }).showToast();
            } catch(e) { console.error(e); } finally { showLoading(false); }
        }

        let sT;
        function searchStationDebounced() {
            clearTimeout(sT);
            const q = document.getElementById('stationInput').value;
            if(q.length < 1) return document.getElementById('suggestions').classList.add('hidden');
            sT = setTimeout(() => execSearch(q), 400);
        }
        async function execSearch(q) {
            const sug = document.getElementById('suggestions');
            sug.classList.remove('hidden');
            sug.innerHTML = '<div class="p-4 text-center text-slate-400 text-xs animate-pulse">æ¤œç´¢ä¸­...</div>';
            try {
                const res = await fetch(`https://express.heartrails.com/api/json?method=getStations&name=${encodeURIComponent(q)}`);
                const data = await res.json();
                if(data.response?.station) {
                    const seen = new Set();
                    sug.innerHTML = data.response.station.filter(s => seen.has(s.name) ? false : seen.add(s.name)).slice(0, 5).map(s => `
                        <div onclick='selectStation("${s.name}", ${s.y}, ${s.x})' class="p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-50 last:border-0 flex justify-between items-center group">
                            <div><div class="font-bold text-slate-800">${s.name}</div><div class="text-xs text-slate-400">${s.line}</div></div>
                        </div>`).join('');
                } else sug.innerHTML = '<div class="p-4 text-center text-slate-400 text-xs">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
            } catch { sug.classList.add('hidden'); }
        }
        function selectStation(n, y, x) {
            selectedStation = { name: n, lat: y, lng: x };
            document.getElementById('stationInput').value = n;
            document.getElementById('suggestions').classList.add('hidden');
            document.getElementById('anywhereCheck').checked = false;
        }
        function toggleAnywhere() {
            const c = document.getElementById('anywhereCheck').checked;
            const i = document.getElementById('stationInput');
            i.disabled = c; i.style.opacity = c ? 0.5 : 1;
            if(c) { i.value = ''; selectedStation = null; }
        }

        function switchTab(t) {
            document.querySelectorAll('[id^="content-"]').forEach(e => e.classList.add('hidden'));
            document.getElementById(`content-${t}`).classList.remove('hidden');
            document.getElementById('tab-normal').className = t==='normal' ? 'flex-1 py-3 text-sm font-bold transition-all tracking-wide tab-active' : 'flex-1 py-3 text-sm font-bold transition-all tracking-wide tab-inactive';
            document.getElementById('tab-ranking').className = t==='ranking' ? 'flex-1 py-3 text-sm font-bold transition-all tracking-wide tab-active' : 'flex-1 py-3 text-sm font-bold transition-all tracking-wide tab-inactive';
        }
        function showLoading(s) { document.getElementById('loading').classList.toggle('hidden', !s); }
        function shareGroupInfo() {
            const url = window.location.href;
            if(navigator.share) navigator.share({ title: 'Fairway Meet', text: `â›³ï¸ ${groupData.name} ã®å ´æ‰€ã‚’æ±ºã‚ã‚ˆã†ï¼`, url });
            else { navigator.clipboard.writeText(url); Toastify({ ...TOAST_OPT, text: "ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ" }).showToast(); }
        }
    </script>
</body>
</html>