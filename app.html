<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aida - ã‚°ãƒ«ãƒ¼ãƒ— | å¾…ã¡åˆã‚ã›å ´æ‰€ã‚’æŠ•ç¥¨ã§æ±ºã‚ã‚‹</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WCDYPYTJE3"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-WCDYPYTJE3');</script>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Outfit:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDzpRxX5te8hcxf_az6n92FTkoRbyCEXwI&libraries=places&v=beta&callback=initApp"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script>
        tailwind.config = {
            theme: { extend: { 
                fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'], heading: ['"Outfit"', 'sans-serif'] },
                animation: { 'fade-in': 'fadeIn 0.4s ease-out' },
                keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(5px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
            } }
        }
    </script>
    <style>
        .glass { background: rgba(255,255,255,0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); }
        .glass-card { background: rgba(255,255,255,0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); border-radius: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.06); }
        .map-container { height: 250px; border-radius: 1.5rem; width: 100%; overflow: hidden; background: #f1f5f9; }
        .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white; font-weight: 800; }
        .btn-bias { background: #fdf2f8; border: 1px solid #fbcfe8; color: #db2777; font-weight: 700; transition: all 0.2s; }
        .btn-bias.active { background: #db2777 !important; color: white !important; border-color: #db2777 !important; }
        .candidate-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="font-sans bg-slate-50 text-slate-900 min-h-screen pb-12">
    <nav class="fixed top-0 left-0 right-0 z-50 glass border-b border-slate-200/50 px-6 py-4">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <a href="#" class="text-2xl font-black tracking-tighter bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent font-heading">Aida</a>
            <div id="dateStatus" class="hidden text-[10px] font-black bg-indigo-600 text-white px-3 py-1 rounded-full shadow-sm"></div>
        </div>
    </nav>

    <main class="relative z-10 max-w-2xl mx-auto px-4 pt-24 space-y-6">
        <div id="dateSelection" class="hidden glass-card p-6 animate-fade-in">
            <h2 class="text-[11px] font-black text-slate-400 mb-3 tracking-widest uppercase flex items-center gap-2">ğŸ“… é–‹å‚¬æ—¥è¨­å®š <span class="text-[9px] bg-slate-100 px-2 py-0.5 rounded text-slate-500 font-normal">ä»»æ„</span></h2>
            <div class="flex gap-2">
                <input type="date" id="meetDate" onchange="updateDate()" class="flex-1 px-4 py-3 rounded-xl border-2 border-slate-100 focus:border-indigo-400 outline-none text-sm font-bold bg-white">
                <button onclick="clearDate()" class="px-4 text-xs font-bold text-slate-400 hover:text-red-400">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>

        <div id="createView">
            <div class="glass-card p-8 text-center">
                <h1 class="text-2xl font-black mb-6 font-heading">ä¸­é–“åœ°ç‚¹ã§é›†ã¾ã‚ã†</h1>
                <input type="text" id="groupName" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆåï¼ˆä¾‹: å¿˜å¹´ä¼šï¼‰" class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 mb-4 outline-none">
                <button onclick="createGroup()" class="w-full py-4 rounded-xl btn-primary shadow-lg">ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã™ã‚‹</button>
            </div>
        </div>

        <div id="groupView" class="hidden space-y-6">
            <div class="glass-card p-4 flex items-center justify-between gap-4">
                <div class="flex-1 bg-slate-50 px-3 py-2 rounded-lg border border-slate-100 overflow-hidden">
                    <div class="text-[9px] font-bold text-slate-400 uppercase">Invite URL</div>
                    <div class="text-[11px] font-mono text-slate-600 truncate" id="shareUrl"></div>
                </div>
                <button onclick="copyUrl()" class="px-5 py-3 btn-primary rounded-xl text-xs whitespace-nowrap">ã‚³ãƒ”ãƒ¼</button>
            </div>

            <div class="glass-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-black text-slate-800">ğŸ‘¥ å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼ (<span id="memberCount">0</span>)</h2>
                    <button onclick="openAddFriendModal()" class="text-[11px] font-bold text-indigo-600 bg-indigo-50 border border-indigo-100 px-3 py-1.5 rounded-xl">ï¼‹ å‹é”è¿½åŠ </button>
                </div>
                <div id="memberList" class="space-y-2 mb-4"></div>
                <button id="joinBtn" onclick="showJoinForm()" class="w-full py-4 rounded-2xl btn-primary shadow-md">âœ‹ å‚åŠ ã™ã‚‹</button>
            </div>

            <div id="joinForm" class="hidden glass-card p-6 border-2 border-indigo-500/20 animate-fade-in">
                <h2 class="text-sm font-black text-indigo-600 mb-4" id="formLabel">ğŸ™‹ æƒ…å ±ã‚’å…¥åŠ›</h2>
                <input type="text" id="nickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 mb-4 outline-none focus:border-indigo-500 text-lg font-bold">
                <input type="text" id="stationInput" placeholder="æœ€å¯„ã‚Šé§…ï¼ˆå€™è£œã‹ã‚‰é¸æŠï¼‰" class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 mb-6 outline-none focus:border-indigo-500 text-lg font-bold">
                <div class="flex gap-2">
                    <button onclick="joinOrUpdateGroup()" class="flex-1 py-4 rounded-xl bg-slate-900 text-white font-bold">ç¢ºå®š</button>
                    <button onclick="closeJoinForm()" id="cancelBtn" class="hidden px-6 py-4 rounded-xl bg-slate-200">æˆ»ã‚‹</button>
                </div>
            </div>

            <div id="normalSection" class="hidden space-y-4">
                <div class="glass-card p-6">
                    <h2 class="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">ğŸ“ ãŠã™ã™ã‚å€™è£œ</h2>
                    <div id="normalMap" class="map-container mb-6"></div>
                    <div id="normalCandidates" class="space-y-4"></div>
                </div>
            </div>

            <div id="biasSection" class="hidden space-y-4">
                <div class="glass-card p-6">
                    <h2 class="text-lg font-black text-slate-900 mb-1 flex items-center gap-2">ğŸ‘¤ èª°ã‹ã«å¯„ã›ã‚‹</h2>
                    <p class="text-[10px] text-slate-400 mb-5 font-bold">ç‰¹å®šã®ãƒ¡ãƒ³ãƒãƒ¼ã®è¿‘ãã§æ¢ã—ã¾ã™</p>
                    <div id="biasMemberList" class="flex flex-wrap gap-2 mb-6"></div>
                    <div id="biasMap" class="map-container mb-6"></div>
                    <div id="biasCandidates" class="space-y-4"></div>
                </div>
            </div>

            <div id="rankingSection" class="hidden glass-card p-6">
                <h2 class="text-lg font-black text-slate-900 mb-4">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
                <div id="rankingList" class="space-y-2"></div>
            </div>
        </div>
    </main>

    <div id="addFriendModal" class="hidden fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl animate-fade-in">
            <h2 class="text-xl font-bold mb-4">ğŸ‘¤ å‹é”ã‚’ç™»éŒ²</h2>
            <input type="text" id="addFriendNickname" placeholder="åå‰" class="w-full px-5 py-4 rounded-xl border-2 border-slate-100 mb-4 outline-none bg-slate-50">
            <input type="text" id="addFriendStationInput" placeholder="æœ€å¯„ã‚Šé§…" class="w-full px-5 py-4 rounded-xl border-2 border-slate-100 mb-6 outline-none bg-slate-50">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeAddFriendModal()" class="py-4 bg-slate-100 rounded-xl font-bold">æˆ»ã‚‹</button>
                <button onclick="submitAddFriend()" class="py-4 bg-indigo-600 text-white rounded-xl font-bold">è¿½åŠ </button>
            </div>
        </div>
    </div>

<script>
    /** * Firebase */
    const firebaseConfig = {
        apiKey: "AIzaSyCxj6Qxk6PkL9WhbIQZh_wCwlhZBdY8MrQ",
        authDomain: "aida-f2eb3.firebaseapp.com",
        projectId: "aida-f2eb3",
        storageBucket: "aida-f2eb3.firebasestorage.app",
        messagingSenderId: "124876591098",
        appId: "1:124876591098:web:93bef3d94de8cf37799e43"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let groupId = null, groupData = null, myMemberId = null;
    let selectedStation = null, addFriendSelectedStation = null;
    let currentBiasMemberId = null;
    let currentBiasCandidates = [];

    /** * åˆæœŸåŒ– */
    function initApp() {
        if (typeof google !== 'undefined' && google.maps) {
            setupAutocomplete('stationInput', (p) => { 
                selectedStation = { name: p.name.replace(/é§…$/g,''), lat: p.geometry.location.lat(), lng: p.geometry.location.lng() }; 
            });
            setupAutocomplete('addFriendStationInput', (p) => { 
                addFriendSelectedStation = { name: p.name.replace(/é§…$/g,''), lat: p.geometry.location.lat(), lng: p.geometry.location.lng() }; 
            });
        }
        const urlParams = new URLSearchParams(window.location.search);
        groupId = urlParams.get('g');
        if (groupId) {
            document.getElementById('createView').classList.add('hidden');
            document.getElementById('groupView').classList.remove('hidden');
            document.getElementById('dateSelection').classList.remove('hidden');
            loadGroup();
        }
    }

    function setupAutocomplete(id, callback) {
        const input = document.getElementById(id);
        const autocomplete = new google.maps.places.Autocomplete(input, { types: ['transit_station'], componentRestrictions: { country: 'jp' } });
        autocomplete.addListener('place_changed', () => {
            const place = autocomplete.getPlace();
            if (place.geometry) callback(place);
        });
    }

    /** * ã€è§£æ±ºç‰ˆã€‘2025å¹´æœ€æ–°ä»•æ§˜ã®Google Placesæ¤œç´¢ */
    async function fetchTopRatedShop(lat, lng, stationName, elementId) {
        const el = document.getElementById(elementId);
        if (!el) return;
        try {
            const { Place, SearchNearbyRankPreference } = await google.maps.importLibrary("places");
            
            const request = {
                fields: ["displayName", "rating", "userRatingCount"],
                locationRestriction: { center: { lat, lng }, radius: 1000 },
                includedPrimaryTypes: ["restaurant", "izakaya", "dining_establishment", "bar", "cafe"],
                maxResultCount: 10,
                rankPreference: SearchNearbyRankPreference.POPULARITY,
                language: "ja"
            };

            const { places } = await Place.searchNearby(request);

            if (places && places.length > 0) {
                const sorted = places.filter(p => p.rating).sort((a,b) => b.rating - a.rating);
                const topShop = sorted[0] || places[0];
                
                // æœ€æ–°ä»•æ§˜ã§ã¯ displayName ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                const shopName = topShop.displayName?.text || topShop.displayName || "ãŠã™ã™ã‚ã®åº—";
                const rating = topShop.rating || "-";
                const count = topShop.userRatingCount || 0;
                const stars = "â˜…".repeat(Math.floor(rating)) + (rating % 1 >= 0.5 ? "â˜†" : "");
                
                const hpUrl = `https://www.hotpepper.jp/gstr000/sk${encodeURIComponent(shopName)}/`;

                el.innerHTML = `
                    <div class="animate-fade-in text-left">
                        <p class="text-[11px] font-black text-slate-800 truncate">${shopName}</p>
                        <p class="text-[10px] text-amber-500 font-bold mt-1">${rating} ${stars} <span class="text-slate-400 font-normal">(${count}ä»¶)</span></p>
                        <a href="${hpUrl}" target="_blank" onclick="event.stopPropagation()" class="block mt-3 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white text-center text-[10px] rounded-xl font-black shadow-lg">ğŸ”¥ ã“ã®ãŠåº—ã‚’äºˆç´„ã™ã‚‹</a>
                    </div>`;
            } else { throw new Error(); }
        } catch (e) {
            const hpUrl = `https://www.hotpepper.jp/SA11/sk${encodeURIComponent(stationName)}/`;
            el.innerHTML = `<a href="${hpUrl}" target="_blank" onclick="event.stopPropagation()" class="block py-3 bg-slate-100 text-slate-500 text-center text-[10px] rounded-xl font-bold border border-dashed border-slate-300">ğŸº ${stationName}é§…å‘¨è¾ºã®åº—ã‚’æ¢ã™</a>`;
        }
    }

    /** * ã‚«ãƒ¼ãƒ‰æç”» */
    function renderCards(containerId, candidates, section) {
        const votes = groupData.memberVotes || {};
        const myVotes = votes[myMemberId] || [];
        const me = groupData.members.find(m => m.id === myMemberId);

        document.getElementById(containerId).innerHTML = candidates.map((c, i) => {
            const isVoted = myVotes.includes(c.name);
            const vCount = Object.values(votes).filter(v => v.includes(c.name)).length;
            const shopId = `shop-${section}-${i}`;
            
            setTimeout(() => fetchTopRatedShop(c.lat, c.lng, c.name, shopId), 400 + (i * 200));

            const routeUrl = `https://transit.yahoo.co.jp/search/result?to=${encodeURIComponent(c.name)}é§…&from=${encodeURIComponent(me?.station || '')}é§…`;
            const lastTrainUrl = `https://transit.yahoo.co.jp/search/result?from=${encodeURIComponent(c.name)}é§…&to=${encodeURIComponent(me?.station || '')}é§…&type=2`;

            return `
                <div onclick="vote('${c.name}')" class="candidate-card p-5 rounded-[2rem] border-2 shadow-sm cursor-pointer ${isVoted ? 'bg-green-50 border-green-400' : 'bg-white border-slate-50 hover:border-slate-200'}">
                    <div class="flex justify-between items-start mb-1">
                        <div class="flex items-center gap-2">
                            <span class="w-6 h-6 rounded-full bg-slate-900 text-white text-[10px] flex items-center justify-center font-black">${i+1}</span>
                            <h3 class="font-black text-lg text-slate-800">${c.name}é§…</h3>
                        </div>
                        ${vCount > 0 ? `<span class="px-3 py-1 bg-indigo-600 text-white text-[10px] rounded-full font-black">${vCount} ç¥¨</span>` : ''}
                    </div>
                    <p class="text-[10px] text-slate-400 mb-3 ml-8">${c.line}</p>
                    <div id="${shopId}" class="p-4 bg-slate-50 rounded-2xl border border-slate-100 mb-4 min-h-[80px] flex items-center justify-center text-[9px] text-slate-300 font-bold">äººæ°—åº—ã‚’æ¤œç´¢ä¸­...</div>
                    <div class="grid grid-cols-2 gap-2">
                        <a href="${routeUrl}" target="_blank" onclick="event.stopPropagation()" class="py-3 bg-indigo-600 text-white text-center text-[10px] rounded-xl font-bold">ğŸšƒ çµŒè·¯</a>
                        <a href="${lastTrainUrl}" target="_blank" onclick="event.stopPropagation()" class="py-3 bg-slate-800 text-white text-center text-[10px] rounded-xl font-bold">ğŸŒ™ çµ‚é›»</a>
                    </div>
                </div>`;
        }).join('');
    }

    /** * ãƒ­ã‚¸ãƒƒã‚¯ãƒ»åŒæœŸ */
    function loadGroup() {
        document.getElementById('shareUrl').textContent = window.location.href;
        db.collection('groups').doc(groupId).onSnapshot(doc => {
            if (doc.exists) {
                groupData = doc.data();
                myMemberId = localStorage.getItem('aida_member_' + groupId);
                if(groupData.date) {
                    document.getElementById('meetDate').value = groupData.date;
                    document.getElementById('dateStatus').textContent = groupData.date + " é–‹å‚¬";
                    document.getElementById('dateStatus').classList.remove('hidden');
                }
                renderAll();
            }
        });
    }

    function renderAll() {
        const members = groupData.members || [];
        document.getElementById('memberCount').textContent = members.length;
        document.getElementById('memberList').innerHTML = members.map(m => `
            <div class="flex items-center gap-3 p-4 bg-white rounded-2xl border ${m.id === myMemberId ? 'ring-2 ring-indigo-500 shadow-sm' : 'border-slate-100'}">
                <div class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center font-bold text-[10px]">${m.name[0]}</div>
                <div class="flex-1 text-xs font-bold text-slate-700">${m.name} <span class="font-normal text-slate-400">(${m.station}é§…)</span></div>
                <div class="flex gap-2">
                    <button onclick="editMember('${m.id}')" class="text-slate-300 hover:text-indigo-500">âœï¸</button>
                    <button onclick="deleteMember('${m.id}')" class="text-slate-300 hover:text-red-500">ğŸ—‘ï¸</button>
                </div>
            </div>`).join('');
        
        if (myMemberId && members.some(m => m.id === myMemberId)) document.getElementById('joinBtn').classList.add('hidden');
        
        const sMembers = members.filter(m => m.lat);
        if (sMembers.length >= 2) {
            const lat = sMembers.reduce((s, m) => s + m.lat, 0) / sMembers.length;
            const lng = sMembers.reduce((s, m) => s + m.lng, 0) / sMembers.length;
            fetchStations(lat, lng, 'normal');
            renderBiasOptions(sMembers);
            document.getElementById('normalSection').classList.remove('hidden');
            document.getElementById('biasSection').classList.remove('hidden');
            renderRanking();
            if (currentBiasCandidates.length > 0) renderCards('biasCandidates', currentBiasCandidates, 'bias');
        }
    }

    async function fetchStations(lat, lng, type) {
        try {
            const res = await fetch(`https://express.heartrails.com/api/json?method=getStations&x=${lng}&y=${lat}`);
            const data = await res.json();
            const stations = data.response?.station || [];
            const unique = []; const names = new Set();
            stations.forEach(s => { if(!names.has(s.name)){ unique.push({ name: s.name, lat: parseFloat(s.y), lng: parseFloat(s.x), line: s.line }); names.add(s.name); } });
            const candidates = unique.slice(0, 4);
            if(type === 'bias') currentBiasCandidates = candidates;
            renderCards(type === 'normal' ? 'normalCandidates' : 'biasCandidates', candidates, type);
            updateMap(type === 'normal' ? 'normalMap' : 'biasMap', candidates, type === 'normal' ? '#6366f1' : '#ec4899');
        } catch(e) { console.error(e); }
    }

    function renderBiasOptions(sMembers) {
        document.getElementById('biasMemberList').innerHTML = sMembers.map(m => `
            <button onclick="selectBiasMember('${m.id}', ${m.lat}, ${m.lng})" 
                    id="bias-btn-${m.id}"
                    class="px-4 py-2 btn-bias rounded-full text-[11px] ${currentBiasMemberId === m.id ? 'active' : ''}">${m.name}</button>
        `).join('');
    }

    function selectBiasMember(id, lat, lng) {
        currentBiasMemberId = id;
        document.querySelectorAll('[id^="bias-btn-"]').forEach(btn => btn.classList.remove('active'));
        const target = document.getElementById(`bias-btn-${id}`);
        if(target) target.classList.add('active');
        fetchStations(lat, lng, 'bias');
    }

    async function vote(sName) {
        if (!myMemberId) return alert('å…ˆã«å‚åŠ ã—ã¦ãã ã•ã„');
        const v = { ...(groupData.memberVotes || {}) };
        let myV = v[myMemberId] || [];
        myV = myV.includes(sName) ? myV.filter(x => x !== sName) : [...myV, sName];
        v[myMemberId] = myV;
        await db.collection('groups').doc(groupId).update({ memberVotes: v });
    }

    /** * UIãƒ»ãã®ä»– */
    function showJoinForm() { document.getElementById('joinForm').classList.remove('hidden'); document.getElementById('joinBtn').classList.add('hidden'); }
    function closeJoinForm() { document.getElementById('joinForm').classList.add('hidden'); if(!myMemberId) document.getElementById('joinBtn').classList.remove('hidden'); }
    function openAddFriendModal() { document.getElementById('addFriendModal').classList.remove('hidden'); }
    function closeAddFriendModal() { document.getElementById('addFriendModal').classList.add('hidden'); }

    async function createGroup() {
        const name = document.getElementById('groupName').value.trim() || 'é›†ã¾ã‚Š';
        const doc = await db.collection('groups').add({ name, members: [], memberVotes: {}, date: null, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        location.href = `?g=${doc.id}`;
    }

    async function joinOrUpdateGroup() {
        const name = document.getElementById('nickname').value.trim();
        if (!name || !selectedStation) return alert('å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        const m = { id: 'mem_' + Date.now(), name, station: selectedStation.name, lat: selectedStation.lat, lng: selectedStation.lng };
        await db.collection('groups').doc(groupId).update({ members: firebase.firestore.FieldValue.arrayUnion(m) });
        localStorage.setItem('aida_member_' + groupId, m.id);
        closeJoinForm();
    }

    async function submitAddFriend() {
        const name = document.getElementById('addFriendNickname').value.trim();
        if (!name || !addFriendSelectedStation) return alert('å…¥åŠ›ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        const m = { id: 'mem_' + Date.now(), name, station: addFriendSelectedStation.name, lat: addFriendSelectedStation.lat, lng: addFriendSelectedStation.lng };
        await db.collection('groups').doc(groupId).update({ members: firebase.firestore.FieldValue.arrayUnion(m) });
        closeAddFriendModal();
    }

    function editMember(id) {
        editTargetId = id;
        const m = groupData.members.find(x => x.id === id);
        document.getElementById('nickname').value = m.name;
        document.getElementById('stationInput').value = m.station;
        document.getElementById('formLabel').innerHTML = '<span>âœï¸</span> æƒ…å ±ã‚’ä¿®æ­£';
        document.getElementById('joinForm').classList.remove('hidden');
        document.getElementById('joinBtn').classList.add('hidden');
    }

    async function deleteMember(id) {
        if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        const members = groupData.members.filter(x => x.id !== id);
        const v = { ...(groupData.memberVotes || {}) }; delete v[id];
        await db.collection('groups').doc(groupId).update({ members, memberVotes: v });
        if(id === myMemberId) localStorage.removeItem('aida_member_' + groupId);
    }

    function updateMap(id, cands, color) {
        if (typeof google === 'undefined' || !google.maps || cands.length === 0) return;
        const map = new google.maps.Map(document.getElementById(id), { center: { lat: cands[0].lat, lng: cands[0].lng }, zoom: 14, disableDefaultUI: true, zoomControl: true });
        const b = new google.maps.LatLngBounds();
        cands.forEach((c, i) => {
            const m = new google.maps.Marker({ position: { lat: c.lat, lng: c.lng }, map, label: { text: String(i+1), color: 'white', fontWeight: 'bold' }, icon: { path: google.maps.SymbolPath.CIRCLE, fillColor: color, fillOpacity: 1, scale: 13, strokeColor: 'white', strokeWeight: 2 } });
            b.extend(m.getPosition());
        });
        map.fitBounds(b);
    }

    function renderRanking() {
        const v = groupData.memberVotes || {};
        const count = {};
        Object.values(v).flat().forEach(s => count[s] = (count[s] || 0) + 1);
        const sorted = Object.entries(count).sort((a,b) => b[1] - a[1]);
        document.getElementById('rankingList').innerHTML = sorted.map(([n, c], i) => `
            <div class="bg-white p-5 rounded-[1.5rem] flex justify-between items-center text-sm shadow-sm border border-slate-50">
                <div class="flex items-center gap-3">
                    <span class="text-xs font-black text-slate-300">#${i+1}</span>
                    <span class="font-black text-slate-700">${n}é§…</span>
                </div>
                <span class="text-[11px] font-black text-indigo-600 bg-indigo-50 px-4 py-1.5 rounded-full">${c} ç¥¨</span>
            </div>`).join('') || '<p class="text-center text-[10px] text-slate-400 py-8 font-bold">æŠ•ç¥¨ãªã—</p>';
    }

    async function updateDate() { await db.collection('groups').doc(groupId).update({ date: document.getElementById('meetDate').value }); }
    async function clearDate() { document.getElementById('meetDate').value = ""; await db.collection('groups').doc(groupId).update({ date: null }); document.getElementById('dateStatus').classList.add('hidden'); }
    function copyUrl() { navigator.clipboard.writeText(window.location.href); alert('æ‹›å¾…URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ ğŸ”—'); }
</script>
</body>
</html>
