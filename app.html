<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aida - ã‚°ãƒ«ãƒ¼ãƒ—</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Outfit:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'], heading: ['"Outfit"', 'sans-serif'] } } }
        }
    </script>
    <style>
        .glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); }
        .glass-card { background: rgba(255,255,255,0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); border-radius: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.08); }
        .suggestions { position: absolute; left: 0; right: 0; z-index: 9999; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); max-height: 200px; overflow-y: auto; display: none; }
        .suggestions.show { display: block; }
        #map { height: 200px; border-radius: 12px; }
    </style>
</head>
<body class="font-sans bg-slate-50 text-slate-900 min-h-screen">
    <div class="fixed inset-0 pointer-events-none overflow-hidden">
        <div class="absolute top-[-20%] right-[-10%] w-[500px] h-[500px] bg-indigo-500/20 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-20%] left-[-10%] w-[400px] h-[400px] bg-pink-500/20 rounded-full blur-[100px]"></div>
    </div>
    <nav class="fixed top-0 left-0 right-0 z-50 glass border-b border-white/20 px-6 py-4">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <a href="index.html" class="text-2xl font-black tracking-tighter bg-gradient-to-r from-indigo-500 to-pink-500 bg-clip-text text-transparent font-heading">Aida</a>
            <a href="index.html" class="text-sm text-slate-500 hover:text-indigo-500 transition-colors">ãƒˆãƒƒãƒ—ã¸</a>
        </div>
    </nav>
    <main class="relative z-10 max-w-2xl mx-auto px-4 pt-24 pb-12">
        <div id="createView">
            <div class="glass-card p-8">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-r from-indigo-500 to-pink-500 text-white text-3xl mb-4">ğŸ‰</div>
                    <h1 class="text-2xl font-black text-slate-900 font-heading">æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ</h1>
                    <p class="text-slate-500 mt-2">å¾…ã¡åˆã‚ã›å ´æ‰€ã‚’ã¿ã‚“ãªã§æ±ºã‚ã‚ˆã†</p>
                </div>
                <input type="text" id="groupName" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—åï¼ˆä¾‹: å¿˜å¹´ä¼š2025ï¼‰" class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none text-lg mb-4">
                <button onclick="createGroup()" class="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-500 to-pink-500 text-white font-bold text-lg shadow-lg shadow-indigo-500/25 hover:scale-[1.02] transition-transform">ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ â†’</button>
            </div>
        </div>
        <div id="groupView" class="hidden space-y-6">
            <div class="glass-card p-6">
                <h2 class="text-sm font-bold text-slate-500 mb-4">ğŸ“¤ ã“ã®URLã‚’å…±æœ‰</h2>
                <div class="bg-slate-100 rounded-xl p-4 mb-4"><p id="shareUrl" class="text-sm text-slate-700 break-all font-mono"></p></div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <button onclick="copyUrl()" class="py-3 rounded-xl bg-slate-900 text-white font-bold">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    <button onclick="shareToLine()" class="py-3 rounded-xl bg-[#06C755] text-white font-bold">ğŸ’¬ LINE</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="shareToFacebook()" class="py-3 rounded-xl bg-[#1877F2] text-white font-bold">ğŸ“˜ Facebook</button>
                    <button onclick="shareToInstagram()" class="py-3 rounded-xl bg-gradient-to-r from-[#833AB4] via-[#FD1D1D] to-[#F77737] text-white font-bold">ğŸ“· Instagram</button>
                </div>
            </div>
            <div class="glass-card p-6">
                <h2 class="text-sm font-bold text-slate-500 mb-4">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆ<span id="memberCount">0</span>äººï¼‰</h2>
                <div id="memberList" class="space-y-3 mb-4"></div>
                <button id="joinBtn" onclick="showJoinForm()" class="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-500 to-pink-500 text-white font-bold shadow-lg shadow-indigo-500/25 hover:scale-[1.02] transition-transform">âœ‹ è‡ªåˆ†ã‚‚å‚åŠ ã™ã‚‹</button>
            </div>
            <div id="joinForm" class="hidden glass-card p-6">
                <h2 class="text-sm font-bold text-slate-500 mb-4">ğŸ™‹ å‚åŠ æƒ…å ±ã‚’å…¥åŠ›</h2>
                <input type="text" id="nickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none text-lg mb-4">
                <p class="text-sm font-bold text-slate-700 mb-2">ğŸš‰ ã‚ãªãŸã®å‡ºç™ºé§…ï¼ˆæœ€å¯„ã‚Šé§…ï¼‰</p>
                <p class="text-xs text-slate-400 mb-3">â€»ã“ã“ã‹ã‚‰ä¸­é–“åœ°ç‚¹ã‚’è¨ˆç®—ã—ã¾ã™</p>
                <label id="anywhereBtn" onclick="toggleAnywhere()" class="flex items-center gap-3 p-4 rounded-xl bg-amber-50 border-2 border-amber-200 cursor-pointer mb-4">
                    <div id="checkboxIcon" class="w-6 h-6 rounded-md border-2 border-amber-400 flex items-center justify-center text-white text-sm font-bold"></div>
                    <span class="font-bold text-amber-700">ã©ã“ã§ã‚‚OKï¼ˆé§…ã‚’æŒ‡å®šã—ãªã„ï¼‰</span>
                </label>
                <div id="stationWrapper" class="relative mb-4">
                    <input type="text" id="stationInput" placeholder="å‡ºç™ºé§…ã‚’å…¥åŠ›ï¼ˆä¾‹: æ¸‹è°·ã€æ–°å®¿...ï¼‰" oninput="searchStation()" onfocus="searchStation()" class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none text-lg">
                    <div id="suggestions" class="suggestions"></div>
                </div>
                <button onclick="joinGroup()" class="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-500 to-pink-500 text-white font-bold shadow-lg shadow-indigo-500/25 hover:scale-[1.02] transition-transform">å‚åŠ ã™ã‚‹ â†’</button>
            </div>
            <!-- å€™è£œã®èª¿æ•´ -->
            <div id="biasCard" class="hidden glass-card p-6">
                <h2 class="text-sm font-bold text-slate-500 mb-4">ğŸ¯ å€™è£œã®èª¿æ•´</h2>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="calculateNormal()" class="py-3 rounded-xl bg-indigo-500 text-white font-bold hover:opacity-90">ğŸ“ ãƒãƒ¼ãƒãƒ«</button>
                    <button onclick="showBiasList()" id="biasToggleBtn" class="py-3 rounded-xl bg-slate-200 text-slate-700 font-bold hover:bg-slate-300">ğŸ‘¤ èª°ã‹ã«å¯„ã›ã‚‹</button>
                </div>
                <div id="biasMemberList" class="hidden flex-wrap gap-2"></div>
            </div>
            <div id="mapCard" class="hidden glass-card p-6">
                <h2 class="text-sm font-bold text-slate-500 mb-4">ğŸ—ºï¸ å€™è£œã‚¨ãƒªã‚¢</h2>
                <div id="map"></div>
            </div>
            <div id="candidatesCard" class="hidden glass-card p-6">
                <h2 class="text-sm font-bold text-slate-500 mb-4">ğŸ—³ï¸ å€™è£œã«æŠ•ç¥¨ã—ã‚ˆã†</h2>
                <p class="text-xs text-slate-400 mb-4">è¤‡æ•°æŠ•ç¥¨OKï¼ã‚¿ãƒƒãƒ—ã§æŠ•ç¥¨ãƒ»ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã§å–ã‚Šæ¶ˆã—</p>
                <div id="candidateList" class="space-y-4"></div>
            </div>
            <!-- æŠ•ç¥¨ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
            <div id="rankingCard" class="hidden glass-card p-6">
                <h2 class="text-sm font-bold text-slate-500 mb-4">ğŸ† æŠ•ç¥¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
                <div id="rankingList" class="space-y-3"></div>
                <div id="votersList" class="mt-4 pt-4 border-t border-slate-200">
                    <h3 class="text-xs font-bold text-slate-400 mb-2">æŠ•ç¥¨çŠ¶æ³</h3>
                    <div id="votersDetail" class="text-sm text-slate-600"></div>
                </div>
            </div>
        </div>
    </main>
</body>
</html>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCxj6Qxk6PkL9WhbIQZh_wCwlhZBdY8MrQ",
    authDomain: "aida-f2eb3.firebaseapp.com",
    projectId: "aida-f2eb3",
    storageBucket: "aida-f2eb3.firebasestorage.app",
    messagingSenderId: "124876591098",
    appId: "1:124876591098:web:93bef3d94de8cf37799e43"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let groupId = null, groupData = null, myMemberId = null, isAnywhere = false, selectedStation = null, map = null, lastMemberCount = 0;

// ä¸»è¦ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãƒ»ç¹è¯è¡—é§…ãƒªã‚¹ãƒˆ
const busyStations = ['æ¸‹è°·','æ–°å®¿','æ± è¢‹','æ±äº¬','å“å·','ä¸Šé‡','ç§‹è‘‰åŸ','æœ‰æ¥½ç”º','éŠ€åº§','å…­æœ¬æœ¨','æµæ¯”å¯¿','ç›®é»’','äº”åç”°','å¤§å´','æ–°æ©‹','æµœæ¾ç”º','ç”°ç”º','é«˜ç”°é¦¬å ´','ä¸­é‡','å‰ç¥¥å¯º','ç«‹å·','ç”ºç”°','æ¨ªæµœ','å·å´','å¤§å®®','åƒè‘‰','èˆ¹æ©‹','æŸ','åŒ—åƒä½','èµ¤ç¾½','è’²ç”°','è‡ªç”±ãŒä¸˜','ä¸‹åŒ—æ²¢','ä¸‰è»’èŒ¶å±‹','ä¸­ç›®é»’','ä»£å®˜å±±','è¡¨å‚é“','åŸå®¿','ä»£ã€…æœ¨','å¾¡èŒ¶ãƒæ°´','ç¥ç”°','æ—¥æœ¬æ©‹','é–€å‰ä»²ç”º','éŒ¦ç³¸ç”º','æŠ¼ä¸Š','æµ…è‰','å·£é´¨','å¤§å¡š','é§’è¾¼','ç‹å­','åæ¡','æ¿æ©‹','ç·´é¦¬','è»çªª','é˜¿ä½ãƒ¶è°·','é«˜å††å¯º','è¥¿è»çªª','ä¸‰é·¹','æ­¦è”µå¢ƒ','å›½åˆ†å¯º','å…«ç‹å­','èª¿å¸ƒ','åºœä¸­','è–è¹Ÿæ¡œãƒ¶ä¸˜','å¤šæ‘©ã‚»ãƒ³ã‚¿ãƒ¼','æºã®å£','æ­¦è”µå°æ‰','æ—¥å‰','èŠå','æ–°æ¨ªæµœ','æˆ¸å¡š','è—¤æ²¢','å¤§èˆ¹','éŒå€‰','èŒ…ãƒ¶å´','å¹³å¡š','å°ç”°åŸ','æµ·è€å','æœ¬åšæœ¨','ç›¸æ¨¡å¤§é‡','ç™»æˆ¸','å‘ãƒ¶ä¸˜éŠåœ’','ç¨²ç”°å ¤','å—æ­¦ç·š','æµ¦å’Œ','å·å£','è‰åŠ ','è¶Šè°·','æ˜¥æ—¥éƒ¨','ä¹…å–œ','ç†Šè°·','æ‰€æ²¢','å·è¶Š','å¿—æœ¨','æœéœå°','å’Œå…‰å¸‚','æˆå¢—','å…‰ãŒä¸˜','çŸ³ç¥äº•å…¬åœ’','å¤§æ³‰å­¦åœ’','ã²ã°ã‚Šãƒ¶ä¸˜','æ¸…ç€¬','æ±æ‘å±±','å°å¹³','å›½ç«‹','æ—¥é‡','è±Šç”°','é«˜å°¾','æ©‹æœ¬','ç›¸æ¨¡åŸ','æ·µé‡è¾º','å¤æ·µ','å—ç”ºç”°','é•·æ´¥ç”°','é’è‘‰å°','ãŸã¾ãƒ—ãƒ©ãƒ¼ã‚¶','ã‚ã–ã¿é‡','ã‚»ãƒ³ã‚¿ãƒ¼åŒ—','ã‚»ãƒ³ã‚¿ãƒ¼å—','æ–°ç™¾åˆãƒ¶ä¸˜','èª­å£²ãƒ©ãƒ³ãƒ‰å‰','ç”Ÿç”°','ç™¾åˆãƒ¶ä¸˜','æŸ¿ç”Ÿ','é¶´å·','ç‰å·å­¦åœ’å‰','æˆç€¬','ã¤ãã—é‡','ã™ãšã‹ã‘å°','å—ç”ºç”°ã‚°ãƒ©ãƒ³ãƒ™ãƒªãƒ¼ãƒ‘ãƒ¼ã‚¯','ä¸­å¤®æ—é–“','å¤§å’Œ','ç€¬è°·','ä¸‰ãƒ„å¢ƒ','äºŒä¿£å·','é¶´ãƒ¶å³°','è¥¿è°·','ä¸Šå¤§å²¡','é‡‘æ²¢æ–‡åº«','é‡‘æ²¢å…«æ™¯','é€—å­','è‘‰å±±','ä¹…é‡Œæµœ','æ¨ªé ˆè³€ä¸­å¤®','æ±å…¥','è¿½æµœ','èƒ½è¦‹å°','æ‰ç”°','ç£¯å­','æ ¹å²¸','å±±æ‰‹','çŸ³å·ç”º','é–¢å†…','æ¡œæœ¨ç”º','ã¿ãªã¨ã¿ã‚‰ã„','é¦¬è»Šé“','æ—¥æœ¬å¤§é€šã‚Š','å…ƒç”ºãƒ»ä¸­è¯è¡—'];

const urlParams = new URLSearchParams(window.location.search);
groupId = urlParams.get('g');
if (groupId) { document.getElementById('createView').classList.add('hidden'); document.getElementById('groupView').classList.remove('hidden'); loadGroup(); }

async function createGroup() {
    const name = document.getElementById('groupName').value.trim() || 'æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—';
    const docRef = await db.collection('groups').add({ name, members: [], candidates: [], votes: {}, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    groupId = docRef.id;
    window.history.pushState({}, '', `?g=${groupId}`);
    document.getElementById('createView').classList.add('hidden');
    document.getElementById('groupView').classList.remove('hidden');
    loadGroup();
}

function getShareUrl() {
    if (window.location.protocol === 'https:') return window.location.origin + '/app.html?g=' + groupId;
    return 'https://top-bay-three.vercel.app/app.html?g=' + groupId;
}

function getMyStation() {
    const savedId = localStorage.getItem('aida_member_' + groupId);
    const members = groupData?.members || [];
    const me = members.find(m => m.id === savedId);
    return me?.station || null;
}

async function loadGroup() {
    document.getElementById('shareUrl').textContent = getShareUrl();
    db.collection('groups').doc(groupId).onSnapshot(doc => {
        if (doc.exists) { groupData = doc.data(); renderMembers(); checkAndShowCandidates(); renderBiasOptions(); }
    });
}

function renderMembers() {
    const list = document.getElementById('memberList');
    const members = groupData.members || [];
    document.getElementById('memberCount').textContent = members.length;
    if (members.length === 0) {
        list.innerHTML = '<p class="text-center text-slate-400 py-8">ã¾ã èª°ã‚‚å‚åŠ ã—ã¦ã„ã¾ã›ã‚“</p>';
    } else {
        list.innerHTML = members.map(m => `
            <div class="flex items-center gap-4 p-4 bg-white/50 rounded-xl">
                <div class="w-12 h-12 rounded-full bg-gradient-to-r from-indigo-500 to-pink-500 flex items-center justify-center text-white font-bold text-lg">${m.name.charAt(0)}</div>
                <div><p class="font-bold text-slate-900">${m.name}</p><p class="text-sm text-slate-500">${m.anywhere ? 'ğŸŒ ã©ã“ã§ã‚‚OK' : 'ğŸš‰ ' + m.station + 'é§…'}</p></div>
            </div>
        `).join('');
    }
    const savedId = localStorage.getItem('aida_member_' + groupId);
    if (savedId && members.find(m => m.id === savedId)) {
        myMemberId = savedId;
        document.getElementById('joinBtn').classList.add('hidden');
        document.getElementById('joinForm').classList.add('hidden');
    }
}

function renderBiasOptions() {
    const members = groupData.members || [];
    const stationMembers = members.filter(m => !m.anywhere && m.station);
    if (stationMembers.length < 2) { document.getElementById('biasCard').classList.add('hidden'); return; }
    document.getElementById('biasCard').classList.remove('hidden');
    document.getElementById('biasMemberList').innerHTML = stationMembers.map(m => `
        <button onclick="biasToMember('${m.id}')" class="px-4 py-2 rounded-full bg-pink-100 text-pink-700 font-bold text-sm hover:bg-pink-200 transition-colors">
            ${m.name}ã•ã‚“
        </button>
    `).join('');
}

function showBiasList() {
    const list = document.getElementById('biasMemberList');
    list.classList.toggle('hidden');
    list.classList.toggle('flex');
}

async function biasToMember(memberId) {
    const members = groupData.members || [];
    const target = members.find(m => m.id === memberId);
    if (!target || !target.lat) return;
    try {
        const res = await fetch(`https://express.heartrails.com/api/json?method=getStations&x=${target.lng}&y=${target.lat}`);
        const data = await res.json();
        if (data.response?.station) {
            let stations = [...new Map(data.response.station.slice(0, 20).map(c => [c.name, c])).values()];
            let candidates = stations.slice(0, 5).map(c => ({ name: c.name, lat: parseFloat(c.y), lng: parseFloat(c.x), line: c.line, type: `${target.name}ã•ã‚“å‘¨è¾º` }));
            await db.collection('groups').doc(groupId).update({ candidates });
        }
    } catch(e) { console.error(e); }
}

// ãƒãƒ¼ãƒãƒ«è¨ˆç®—ï¼š4ç¨®é¡ã®å€™è£œã‚’å‡ºã™
async function calculateNormal() {
    const members = groupData.members || [];
    const stationMembers = members.filter(m => !m.anywhere && m.lat && m.lng);
    if (stationMembers.length < 2) return;
    
    // 1. ç´”ç²‹ãªé‡å¿ƒ
    const avgLat = stationMembers.reduce((s, m) => s + m.lat, 0) / stationMembers.length;
    const avgLng = stationMembers.reduce((s, m) => s + m.lng, 0) / stationMembers.length;
    
    // 2. å¯†é›†åº¦è€ƒæ…®ã®é‡å¿ƒ
    const stationCount = {};
    stationMembers.forEach(m => { stationCount[m.station] = (stationCount[m.station] || 0) + 1; });
    let totalLat = 0, totalLng = 0, totalWeight = 0;
    stationMembers.forEach(m => {
        const weight = stationCount[m.station];
        totalLat += m.lat * weight;
        totalLng += m.lng * weight;
        totalWeight += weight;
    });
    const densityLat = totalLat / totalWeight;
    const densityLng = totalLng / totalWeight;
    
    try {
        // é‡å¿ƒå‘¨è¾ºã®é§…ã‚’å–å¾—
        const res1 = await fetch(`https://express.heartrails.com/api/json?method=getStations&x=${avgLng}&y=${avgLat}`);
        const data1 = await res1.json();
        
        // å¯†é›†åº¦é‡å¿ƒå‘¨è¾ºã®é§…ã‚’å–å¾—
        const res2 = await fetch(`https://express.heartrails.com/api/json?method=getStations&x=${densityLng}&y=${densityLat}`);
        const data2 = await res2.json();
        
        const candidates = [];
        
        if (data1.response?.station) {
            const stations1 = [...new Map(data1.response.station.slice(0, 10).map(c => [c.name, c])).values()];
            // 1. é‡å¿ƒã«è¿‘ã„é§…
            if (stations1[0]) candidates.push({ name: stations1[0].name, lat: parseFloat(stations1[0].y), lng: parseFloat(stations1[0].x), line: stations1[0].line, type: 'ğŸ“ é‡å¿ƒ' });
            // 2. é‡å¿ƒè¿‘ãã®ä¸»è¦é§…
            const busy1 = stations1.find(s => busyStations.includes(s.name));
            if (busy1 && busy1.name !== stations1[0]?.name) candidates.push({ name: busy1.name, lat: parseFloat(busy1.y), lng: parseFloat(busy1.x), line: busy1.line, type: 'ğŸ™ï¸ é‡å¿ƒè¿‘ãã®ä¸»è¦é§…' });
        }
        
        if (data2.response?.station) {
            const stations2 = [...new Map(data2.response.station.slice(0, 10).map(c => [c.name, c])).values()];
            // 3. å¯†é›†åº¦è€ƒæ…®ã®é§…
            const density = stations2[0];
            if (density && !candidates.find(c => c.name === density.name)) candidates.push({ name: density.name, lat: parseFloat(density.y), lng: parseFloat(density.x), line: density.line, type: 'ğŸ“Š å¯†é›†åº¦è€ƒæ…®' });
            // 4. å¯†é›†åº¦è¿‘ãã®ä¸»è¦é§…
            const busy2 = stations2.find(s => busyStations.includes(s.name));
            if (busy2 && !candidates.find(c => c.name === busy2.name)) candidates.push({ name: busy2.name, lat: parseFloat(busy2.y), lng: parseFloat(busy2.x), line: busy2.line, type: 'ğŸ™ï¸ å¯†é›†åº¦è¿‘ãã®ä¸»è¦é§…' });
        }
        
        // è¶³ã‚Šãªã‘ã‚Œã°é‡å¿ƒå‘¨è¾ºã‹ã‚‰è¿½åŠ 
        if (candidates.length < 4 && data1.response?.station) {
            const stations1 = [...new Map(data1.response.station.slice(0, 10).map(c => [c.name, c])).values()];
            for (const s of stations1) {
                if (candidates.length >= 5) break;
                if (!candidates.find(c => c.name === s.name)) {
                    candidates.push({ name: s.name, lat: parseFloat(s.y), lng: parseFloat(s.x), line: s.line, type: 'ğŸ“ å‘¨è¾º' });
                }
            }
        }
        
        await db.collection('groups').doc(groupId).update({ candidates: candidates.slice(0, 5) });
    } catch(e) { console.error(e); }
}

function showJoinForm() { document.getElementById('joinForm').classList.remove('hidden'); document.getElementById('joinBtn').classList.add('hidden'); }

function toggleAnywhere() {
    isAnywhere = !isAnywhere;
    const checkbox = document.getElementById('checkboxIcon');
    const wrapper = document.getElementById('stationWrapper');
    if (isAnywhere) { checkbox.innerHTML = 'âœ“'; checkbox.classList.add('bg-amber-400'); wrapper.classList.add('hidden'); }
    else { checkbox.innerHTML = ''; checkbox.classList.remove('bg-amber-400'); wrapper.classList.remove('hidden'); }
}

let searchTimeout = null;
function searchStation() {
    const query = document.getElementById('stationInput').value.trim();
    const suggestionsDiv = document.getElementById('suggestions');
    if (query.length < 1) { suggestionsDiv.classList.remove('show'); return; }
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
        suggestionsDiv.innerHTML = '<div class="p-4 text-slate-400">æ¤œç´¢ä¸­...</div>';
        suggestionsDiv.classList.add('show');
        try {
            const res = await fetch(`https://express.heartrails.com/api/json?method=getStations&name=${encodeURIComponent(query)}`);
            const data = await res.json();
            if (data.response?.station) {
                const unique = [...new Map(data.response.station.map(s => [s.name + s.line, s])).values()];
                suggestionsDiv.innerHTML = unique.slice(0, 8).map(s => `
                    <div class="p-4 hover:bg-slate-50 cursor-pointer border-b border-slate-100" onclick="selectStation('${s.name}',${s.y},${s.x},'${s.line}')">
                        <p class="font-bold">${s.name}é§…</p><p class="text-sm text-slate-500">${s.line}ï¼ˆ${s.prefecture}ï¼‰</p>
                    </div>
                `).join('');
            } else { suggestionsDiv.innerHTML = '<div class="p-4 text-slate-400">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>'; }
        } catch(e) { suggestionsDiv.innerHTML = '<div class="p-4 text-red-500">ã‚¨ãƒ©ãƒ¼</div>'; }
    }, 300);
}

function selectStation(name, lat, lng, line) { selectedStation = { name, lat, lng, line }; document.getElementById('stationInput').value = name; document.getElementById('suggestions').classList.remove('show'); }
document.addEventListener('click', e => { if (!e.target.closest('#stationWrapper')) document.getElementById('suggestions').classList.remove('show'); });

async function joinGroup() {
    const members = groupData.members || [];
    if (members.length >= 20) { alert('ãƒ¡ãƒ³ãƒãƒ¼ã¯æœ€å¤§20äººã¾ã§ã§ã™'); return; }
    const name = document.getElementById('nickname').value.trim();
    if (!name) { alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if (!isAnywhere && !selectedStation) { alert('é§…ã‚’é¸æŠã™ã‚‹ã‹ã€Œã©ã“ã§ã‚‚OKã€ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
    const memberId = 'member_' + Date.now();
    const member = { id: memberId, name, anywhere: isAnywhere, station: isAnywhere ? null : selectedStation.name, lat: isAnywhere ? null : selectedStation.lat, lng: isAnywhere ? null : selectedStation.lng };
    await db.collection('groups').doc(groupId).update({ members: firebase.firestore.FieldValue.arrayUnion(member) });
    myMemberId = memberId;
    localStorage.setItem('aida_member_' + groupId, memberId);
    document.getElementById('joinForm').classList.add('hidden');
}

async function checkAndShowCandidates() {
    const members = groupData.members || [];
    const stationMembers = members.filter(m => !m.anywhere && m.lat && m.lng);
    if (stationMembers.length >= 2 && stationMembers.length !== lastMemberCount) {
        lastMemberCount = stationMembers.length;
        await calculateCandidates(stationMembers);
    }
    if (groupData.candidates && groupData.candidates.length > 0) { renderCandidates(); renderMap(); }
}

async function calculateCandidates(stationMembers) {
    // åˆå›ã¯ãƒãƒ¼ãƒãƒ«è¨ˆç®—ã‚’å®Ÿè¡Œ
    await calculateNormal();
}

function renderMap() {
    document.getElementById('mapCard').classList.remove('hidden');
    const candidates = groupData.candidates || [];
    if (candidates.length === 0) return;
    if (!map) { map = L.map('map').setView([candidates[0].lat, candidates[0].lng], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map); }
    map.eachLayer(layer => { if (layer instanceof L.Marker) map.removeLayer(layer); });
    candidates.forEach((c, i) => {
        const icon = L.divIcon({ className: '', html: `<div style="background:linear-gradient(135deg,#6366f1,#ec4899);color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,0.3);">${i+1}</div>`, iconSize: [28, 28] });
        L.marker([c.lat, c.lng], { icon }).addTo(map).bindPopup(`${c.name}é§…`);
    });
    map.fitBounds(L.latLngBounds(candidates.map(c => [c.lat, c.lng])), { padding: [30, 30] });
}

function renderCandidates() {
    document.getElementById('candidatesCard').classList.remove('hidden');
    const candidates = groupData.candidates || [];
    const memberVotes = groupData.memberVotes || {}; // { memberId: [station1, station2, ...] }
    
    // å„é§…ã®æŠ•ç¥¨æ•°ã‚’é›†è¨ˆ
    const voteCounts = {};
    candidates.forEach(c => voteCounts[c.name] = 0);
    Object.values(memberVotes).forEach(votes => {
        votes.forEach(station => {
            if (voteCounts[station] !== undefined) voteCounts[station]++;
        });
    });
    
    const totalVotes = Object.values(voteCounts).reduce((a, b) => a + b, 0) || 1;
    const myVotes = memberVotes[myMemberId] || [];
    const myStation = getMyStation();
    
    document.getElementById('candidateList').innerHTML = candidates.map((c, i) => {
        const voteCount = voteCounts[c.name] || 0;
        const pct = Math.round((voteCount / totalVotes) * 100);
        const isVoted = myVotes.includes(c.name);
        const navitimeUrl = myStation ? `https://www.navitime.co.jp/transfer/searchlist?orvStationName=${encodeURIComponent(myStation)}&dnvStationName=${encodeURIComponent(c.name)}` : '';
        return `
            <div class="p-5 rounded-2xl ${isVoted ? 'bg-green-50 border-2 border-green-400' : 'bg-white/60 border-2 border-transparent'} transition-all cursor-pointer hover:shadow-lg" onclick="vote('${c.name}')">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <span class="w-8 h-8 rounded-full bg-gradient-to-r from-indigo-500 to-pink-500 text-white flex items-center justify-center font-bold text-sm">${i+1}</span>
                        <span class="font-bold text-lg">${c.name}é§…</span>
                    </div>
                    <div class="flex gap-2">
                        ${i === 0 ? '<span class="px-3 py-1 rounded-full bg-gradient-to-r from-indigo-500 to-pink-500 text-white text-xs font-bold">ãŠã™ã™ã‚</span>' : ''}
                        ${voteCount > 0 ? `<span class="px-3 py-1 rounded-full bg-blue-100 text-blue-600 text-xs font-bold">${voteCount}ç¥¨</span>` : ''}
                    </div>
                </div>
                <p class="text-sm text-slate-500 mb-1">${c.line || ''}</p>
                ${c.type ? `<p class="text-xs text-indigo-500 font-bold mb-3">${c.type}</p>` : '<div class="mb-3"></div>'}
                <div class="flex items-center gap-3 mb-4">
                    <div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-indigo-500 to-pink-500 transition-all" style="width:${pct}%"></div></div>
                    <span class="text-sm font-bold text-slate-500">${pct}%</span>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <a href="https://www.google.com/search?q=${encodeURIComponent(c.name + 'é§… å±…é…’å±‹ é£Ÿã¹ãƒ­ã‚°')}" target="_blank" onclick="event.stopPropagation()" class="py-3 rounded-xl bg-orange-500 text-white text-center font-bold text-sm">ğŸº é£Ÿã¹ãƒ­ã‚°</a>
                    <a href="https://www.google.com/maps/search/å±…é…’å±‹/@${c.lat},${c.lng},16z" target="_blank" onclick="event.stopPropagation()" class="py-3 rounded-xl bg-blue-500 text-white text-center font-bold text-sm">ğŸ—ºï¸ Google Map</a>
                </div>
                ${myStation ? `<a href="${navitimeUrl}" target="_blank" onclick="event.stopPropagation()" class="block py-3 rounded-xl bg-green-500 text-white text-center font-bold text-sm">ğŸšƒ ${myStation}é§…ã‹ã‚‰ã®ä¹—æ›æ¡ˆå†…</a>` : ''}
            </div>
        `;
    }).join('');
    
    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
    renderRanking(candidates, voteCounts, memberVotes);
}

function renderRanking(candidates, voteCounts, memberVotes) {
    const members = groupData.members || [];
    const hasVotes = Object.values(voteCounts).some(v => v > 0);
    
    if (!hasVotes) {
        document.getElementById('rankingCard').classList.add('hidden');
        return;
    }
    
    document.getElementById('rankingCard').classList.remove('hidden');
    
    // æŠ•ç¥¨æ•°ã§ã‚½ãƒ¼ãƒˆ
    const sorted = candidates.map(c => ({ name: c.name, votes: voteCounts[c.name] || 0 }))
        .sort((a, b) => b.votes - a.votes);
    
    document.getElementById('rankingList').innerHTML = sorted.map((s, i) => {
        const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i+1}.`;
        const barWidth = sorted[0].votes > 0 ? Math.round((s.votes / sorted[0].votes) * 100) : 0;
        return `
            <div class="flex items-center gap-3">
                <span class="text-xl w-8">${medal}</span>
                <span class="font-bold flex-1">${s.name}é§…</span>
                <div class="w-24 h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-indigo-500 to-pink-500" style="width:${barWidth}%"></div>
                </div>
                <span class="text-sm font-bold text-slate-600 w-12 text-right">${s.votes}ç¥¨</span>
            </div>
        `;
    }).join('');
    
    // èª°ãŒã©ã“ã«æŠ•ç¥¨ã—ãŸã‹è¡¨ç¤º
    const voterDetails = [];
    members.forEach(m => {
        const votes = memberVotes[m.id] || [];
        if (votes.length > 0) {
            voterDetails.push(`<span class="font-bold">${m.name}</span>: ${votes.map(v => v + 'é§…').join(', ')}`);
        }
    });
    document.getElementById('votersDetail').innerHTML = voterDetails.length > 0 
        ? voterDetails.join('<br>') 
        : '<span class="text-slate-400">ã¾ã æŠ•ç¥¨ãŒã‚ã‚Šã¾ã›ã‚“</span>';
}

async function vote(stationName) {
    if (!myMemberId) { alert('å…ˆã«å‚åŠ ã—ã¦ãã ã•ã„'); return; }
    
    const memberVotes = { ...(groupData.memberVotes || {}) };
    const myVotes = memberVotes[myMemberId] || [];
    
    if (myVotes.includes(stationName)) {
        // æ—¢ã«æŠ•ç¥¨æ¸ˆã¿ â†’ å–ã‚Šæ¶ˆã—
        memberVotes[myMemberId] = myVotes.filter(v => v !== stationName);
    } else {
        // æ–°è¦æŠ•ç¥¨ï¼ˆè¤‡æ•°å¯ï¼‰
        memberVotes[myMemberId] = [...myVotes, stationName];
    }
    
    await db.collection('groups').doc(groupId).update({ memberVotes });
}

function copyUrl() { navigator.clipboard.writeText(getShareUrl()); alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'); }
function shareToLine() { window.open(`https://line.me/R/msg/text/?${encodeURIComponent(`ã€${groupData?.name || 'ã‚°ãƒ«ãƒ¼ãƒ—'}ã€‘ã®å¾…ã¡åˆã‚ã›å ´æ‰€ã‚’æ±ºã‚ã‚ˆã†ï¼\n\n${getShareUrl()}`)}`, '_blank'); }
function shareToFacebook() { window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(getShareUrl())}`, '_blank'); }
function shareToInstagram() { navigator.clipboard.writeText(getShareUrl()); window.location.href = 'instagram://direct-inbox'; setTimeout(() => alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nInstagramã®DMã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚'), 500); }
</script>
