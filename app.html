<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aida - ã‚°ãƒ«ãƒ¼ãƒ— | å¾…ã¡åˆã‚ã›å ´æ‰€ã‚’æŠ•ç¥¨ã§æ±ºã‚ã‚‹</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WCDYPYTJE3"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-WCDYPYTJE3');</script>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Outfit:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDzpRxX5te8hcxf_az6n92FTkoRbyCEXwI&libraries=places&callback=initApp"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'], heading: ['"Outfit"', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(5px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        .glass { background: rgba(255,255,255,0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); }
        .glass-card { background: rgba(255,255,255,0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); border-radius: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.06); }
        .map-container { height: 250px; border-radius: 1.5rem; width: 100%; overflow: hidden; background: #f8fafc; }
        .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white; font-weight: 800; transition: all 0.2s; }
        .btn-primary:active { transform: scale(0.96); }
        .btn-bias { background: #fdf2f8; border: 1px solid #fbcfe8; color: #db2777; font-weight: 700; transition: all 0.2s; }
        .btn-bias:hover { background: #fbcfe8; }
        .btn-bias.active { background: #db2777; color: white; border-color: #db2777; }
        .candidate-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="font-sans bg-slate-50 text-slate-900 min-h-screen pb-12">
    <nav class="fixed top-0 left-0 right-0 z-50 glass border-b border-slate-200/50 px-6 py-4">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <a href="#" class="text-2xl font-black tracking-tighter bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent font-heading">Aida</a>
            <div id="dateStatus" class="hidden text-[10px] font-black bg-indigo-600 text-white px-3 py-1 rounded-full shadow-sm"></div>
        </div>
    </nav>

    <main class="relative z-10 max-w-2xl mx-auto px-4 pt-24 space-y-6">
        <div id="dateSelection" class="hidden glass-card p-6 animate-fade-in">
            <h2 class="text-[11px] font-black text-slate-400 mb-3 tracking-widest uppercase flex items-center gap-2">ğŸ“… é–‹å‚¬æ—¥è¨­å®š <span class="text-[9px] bg-slate-100 px-2 py-0.5 rounded text-slate-500 font-normal">ä»»æ„</span></h2>
            <div class="flex gap-2">
                <input type="date" id="meetDate" onchange="updateDate()" class="flex-1 px-4 py-3 rounded-xl border-2 border-slate-100 focus:border-indigo-400 outline-none text-sm font-bold bg-white">
                <button onclick="clearDate()" class="px-4 text-xs font-bold text-slate-400 hover:text-red-400 transition-colors">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>

        <div id="createView">
            <div class="glass-card p-8 text-center">
                <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-3xl flex items-center justify-center text-3xl mx-auto mb-6">ğŸ“</div>
                <h1 class="text-2xl font-black mb-2 font-heading">ä¸­é–“åœ°ç‚¹ã§é›†ã¾ã‚ã†</h1>
                <p class="text-sm text-slate-500 mb-8">å ´æ‰€ãŒæ±ºã¾ã‚‰ãªã„ã‚¹ãƒˆãƒ¬ã‚¹ã‚’ã‚¼ãƒ­ã«ã€‚</p>
                <input type="text" id="groupName" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆåï¼ˆä¾‹: åŒçª“ä¼šï¼‰" class="w-full px-5 py-4 rounded-2xl border-2 border-slate-200 mb-4 outline-none focus:border-indigo-500 text-lg">
                <button onclick="createGroup()" class="w-full py-4 rounded-2xl btn-primary shadow-lg shadow-indigo-200 text-lg">ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã™ã‚‹</button>
            </div>
        </div>

        <div id="groupView" class="hidden space-y-6">
            <div class="glass-card p-4 flex items-center justify-between gap-4">
                <div class="flex-1 bg-slate-50 px-3 py-2 rounded-lg border border-slate-100">
                    <div class="text-[9px] font-bold text-slate-400 uppercase mb-1">Invite URL</div>
                    <div class="text-[11px] font-mono text-slate-600 truncate" id="shareUrl"></div>
                </div>
                <button onclick="copyUrl()" class="px-5 py-3 btn-primary rounded-xl text-xs">ã‚³ãƒ”ãƒ¼</button>
            </div>

            <div class="glass-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-black text-slate-800">ğŸ‘¥ å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼ (<span id="memberCount">0</span>)</h2>
                    <button onclick="openAddFriendModal()" class="text-[11px] font-bold text-indigo-600 bg-indigo-50 border border-indigo-100 px-3 py-1.5 rounded-xl hover:bg-indigo-100 transition-colors">ï¼‹ å‹é”ã‚’ç™»éŒ²</button>
                </div>
                <div id="memberList" class="space-y-2"></div>
                <button id="joinBtn" onclick="showJoinForm()" class="w-full mt-4 py-4 rounded-2xl btn-primary shadow-md">âœ‹ è‡ªåˆ†ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦å‚åŠ </button>
            </div>

            <div id="joinForm" class="hidden glass-card p-6 animate-fade-in border-2 border-indigo-500/20">
                <h2 class="text-sm font-black text-indigo-600 mb-4 flex items-center gap-2" id="formLabel"><span>ğŸ™‹</span> æƒ…å ±ã‚’å…¥åŠ›</h2>
                <input type="text" id="nickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 mb-4 outline-none focus:border-indigo-500">
                <input type="text" id="stationInput" placeholder="æœ€å¯„ã‚Šé§…ï¼ˆå€™è£œã‹ã‚‰é¸æŠï¼‰" class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 mb-6 outline-none focus:border-indigo-500">
                <div class="flex gap-2">
                    <button onclick="joinOrUpdateGroup()" class="flex-1 py-4 rounded-xl btn-primary" id="submitBtn">ç¢ºå®š</button>
                    <button onclick="closeJoinForm()" id="cancelBtn" class="hidden px-6 py-4 rounded-xl bg-slate-200 text-slate-700 font-bold">æˆ»ã‚‹</button>
                </div>
            </div>

            <div id="normalSection" class="hidden space-y-4">
                <div class="glass-card p-6">
                    <h2 class="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">ğŸ“<span>ãŠã™ã™ã‚ã®ä¸­é–“åœ°ç‚¹</span></h2>
                    <div id="normalMap" class="map-container mb-6 shadow-inner"></div>
                    <div id="normalCandidates" class="space-y-4"></div>
                </div>
            </div>

            <div id="biasSection" class="hidden space-y-4">
                <div class="glass-card p-6">
                    <h2 class="text-lg font-black text-slate-900 mb-1 flex items-center gap-2">ğŸ‘¤<span>èª°ã‹ã«å¯„ã›ã‚‹</span></h2>
                    <p class="text-[10px] text-slate-400 mb-5 font-bold tracking-tight">ç‰¹å®šã®ãƒ¡ãƒ³ãƒãƒ¼ã®è¿‘ãã‚’å„ªå…ˆã—ã¦æ¢ã—ã¾ã™</p>
                    <div id="biasMemberList" class="flex flex-wrap gap-2 mb-6"></div>
                    <div id="biasMap" class="map-container mb-6 shadow-inner"></div>
                    <div id="biasCandidates" class="space-y-4"></div>
                </div>
            </div>

            <div id="rankingSection" class="hidden glass-card p-6">
                <h2 class="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">ğŸ†<span>ç¾åœ¨ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span></h2>
                <div id="rankingList" class="space-y-2"></div>
            </div>
        </div>
    </main>

    <div id="addFriendModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl animate-fade-in">
            <h2 class="text-xl font-black mb-6">ğŸ‘¤ å‹é”ã‚’ç™»éŒ²</h2>
            <div class="space-y-4 mb-8">
                <div>
                    <label class="text-[10px] font-black text-slate-400 ml-1 mb-1 block uppercase">Name</label>
                    <input type="text" id="addFriendNickname" placeholder="å‹é”ã®åå‰" class="w-full px-5 py-4 rounded-2xl bg-slate-50 border-2 border-slate-100 outline-none focus:border-indigo-400">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 ml-1 mb-1 block uppercase">Station</label>
                    <input type="text" id="addFriendStationInput" placeholder="å‹é”ã®æœ€å¯„ã‚Šé§…" class="w-full px-5 py-4 rounded-2xl bg-slate-50 border-2 border-slate-100 outline-none focus:border-indigo-400">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeAddFriendModal()" class="py-4 bg-slate-100 text-slate-500 rounded-2xl font-black">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="submitAddFriend()" class="py-4 btn-primary rounded-2xl shadow-lg shadow-indigo-100">è¿½åŠ ã™ã‚‹</button>
            </div>
        </div>
    </div>
</body>

<script>
/** Firebase Setup */
const firebaseConfig = {
    apiKey: "AIzaSyCxj6Qxk6PkL9WhbIQZh_wCwlhZBdY8MrQ",
    authDomain: "aida-f2eb3.firebaseapp.com",
    projectId: "aida-f2eb3",
    storageBucket: "aida-f2eb3.firebasestorage.app",
    messagingSenderId: "124876591098",
    appId: "1:124876591098:web:93bef3d94de8cf37799e43"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let groupId = null, groupData = null, myMemberId = null;
let selectedStation = null, addFriendSelectedStation = null, editTargetId = null;
let currentBiasCandidates = [];
let currentBiasMemberId = null; // ç¾åœ¨é¸æŠä¸­ã®biasãƒ¡ãƒ³ãƒãƒ¼

// Google Maps APIãŒèª­ã¿è¾¼ã¾ã‚Œãªãã¦ã‚‚åŸºæœ¬æ©Ÿèƒ½ã¯å‹•ãã‚ˆã†ã«ã™ã‚‹
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    groupId = urlParams.get('g');
    if (groupId) {
        document.getElementById('createView').classList.add('hidden');
        document.getElementById('groupView').classList.remove('hidden');
        document.getElementById('dateSelection').classList.remove('hidden');
        loadGroup();
    }
});

function initApp() {
    // Google Maps Places Autocompleteï¼ˆAPIãŒèª­ã¿è¾¼ã¾ã‚ŒãŸæ™‚ã®ã¿ï¼‰
    if (typeof google !== 'undefined' && google.maps) {
        setupAutocomplete('stationInput', (place) => {
            selectedStation = { 
                name: place.name.replace(/é§…$/g,''), 
                lat: place.geometry.location.lat(), 
                lng: place.geometry.location.lng() 
            };
        });
        setupAutocomplete('addFriendStationInput', (place) => {
            addFriendSelectedStation = { 
                name: place.name.replace(/é§…$/g,''), 
                lat: place.geometry.location.lat(), 
                lng: place.geometry.location.lng() 
            };
        });
    }
}

function setupAutocomplete(id, callback) {
    const input = document.getElementById(id);
    const autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['transit_station'], 
        componentRestrictions: { country: 'jp' }, 
        fields: ['name', 'geometry']
    });
    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (place.geometry) callback(place);
    });
}

/** çµŒè·¯ & çµ‚é›» */
let directionsService = null;

// ç·¯åº¦çµŒåº¦ãƒ™ãƒ¼ã‚¹ã§çµŒè·¯æ¤œç´¢ï¼ˆé§…åã‚ˆã‚Šç²¾åº¦ãŒé«˜ã„ï¼‰
async function getTransitInfoByCoords(originLat, originLng, destLat, destLng, isLast = false) {
    if (typeof google === 'undefined' || !google.maps || !google.maps.DirectionsService) {
        console.log('Google Maps API not available');
        return null;
    }
    
    if (!directionsService) directionsService = new google.maps.DirectionsService();
    
    return new Promise((resolve) => {
        const req = {
            origin: new google.maps.LatLng(originLat, originLng),
            destination: new google.maps.LatLng(destLat, destLng),
            travelMode: google.maps.TravelMode.TRANSIT,
            transitOptions: { 
                routingPreference: google.maps.TransitRoutePreference.FEWER_TRANSFERS
            }
        };
        
        // å‡ºç™ºæ™‚åˆ»ã‚’è¨­å®šï¼ˆç¾åœ¨æ™‚åˆ» or çµ‚é›»æ¤œç´¢ç”¨ï¼‰
        if (isLast) {
            // çµ‚é›»æ¤œç´¢: ä»Šæ—¥ã®23:30åˆ°ç€ã§æ¤œç´¢
            const d = new Date();
            d.setHours(23, 30, 0);
            if (d < new Date()) d.setDate(d.getDate() + 1); // éå»ãªã‚‰æ˜æ—¥
            req.transitOptions.arrivalTime = d;
        } else {
            // é€šå¸¸æ¤œç´¢: ç¾åœ¨æ™‚åˆ»ã‹ã‚‰
            req.transitOptions.departureTime = new Date();
        }
        
        const timeout = setTimeout(() => {
            console.log('getTransitInfo timeout');
            resolve(null);
        }, 8000);
        
        directionsService.route(req, (res, status) => {
            clearTimeout(timeout);
            console.log('Directions API response:', status, res);
            
            if (status === 'OK' && res.routes && res.routes.length > 0) {
                const leg = res.routes[0].legs[0];
                const steps = leg.steps.filter(s => s.travel_mode === 'TRANSIT');
                resolve({
                    duration: leg.duration.text,
                    durationSec: leg.duration.value,
                    transfers: Math.max(0, steps.length - 1),
                    depTime: leg.departure_time ? leg.departure_time.value : null,
                    depTimeStr: leg.departure_time ? leg.departure_time.text : null,
                    arrTimeStr: leg.arrival_time ? leg.arrival_time.text : null
                });
            } else { 
                console.log('Directions API error:', status);
                resolve(null); 
            }
        });
    });
}

// é§…åã‹ã‚‰ç·¯åº¦çµŒåº¦ã‚’å–å¾—ã—ã¦ã‹ã‚‰çµŒè·¯æ¤œç´¢
async function getTransitInfo(originStation, destStation, originCoords, destCoords, isLast = false) {
    // ç·¯åº¦çµŒåº¦ãŒæ¸¡ã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ã†
    if (originCoords && destCoords) {
        return getTransitInfoByCoords(originCoords.lat, originCoords.lng, destCoords.lat, destCoords.lng, isLast);
    }
    return null;
}

async function createGroup() {
    try {
        const name = document.getElementById('groupName').value.trim() || 'æ–°ã—ã„é›†ã¾ã‚Š';
        const doc = await db.collection('groups').add({ 
            name, members: [], memberVotes: {}, date: null, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp() 
        });
        location.href = `?g=${doc.id}`;
    } catch(e) {
        console.error('createGroup error:', e);
        alert('ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    }
}

function loadGroup() {
    document.getElementById('shareUrl').textContent = window.location.href;
    db.collection('groups').doc(groupId).onSnapshot(doc => {
        if (doc.exists) {
            groupData = doc.data();
            myMemberId = localStorage.getItem('aida_member_' + groupId);
            if(groupData.date) {
                document.getElementById('meetDate').value = groupData.date;
                const ds = document.getElementById('dateStatus');
                ds.textContent = groupData.date + " é–‹å‚¬";
                ds.classList.remove('hidden');
            }
            renderAll();
        }
    });
}

async function updateDate() { 
    await db.collection('groups').doc(groupId).update({ date: document.getElementById('meetDate').value }); 
}

async function clearDate() {
    document.getElementById('meetDate').value = "";
    await db.collection('groups').doc(groupId).update({ date: null });
    document.getElementById('dateStatus').classList.add('hidden');
}

function renderAll() {
    const members = groupData.members || [];
    document.getElementById('memberCount').textContent = members.length;
    
    document.getElementById('memberList').innerHTML = members.map(m => `
        <div class="flex items-center gap-3 p-4 bg-white rounded-2xl border ${m.id === myMemberId ? 'ring-2 ring-indigo-500 border-indigo-100 shadow-sm' : 'border-slate-100'}">
            <div class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center font-black text-[10px]">${m.name[0]}</div>
            <div class="flex-1 text-xs font-black text-slate-700">${m.name} <span class="text-[9px] text-slate-400 font-normal ml-1">(${m.station}é§…)</span></div>
            <div class="flex gap-1">
                <button onclick="editMember('${m.id}')" class="text-slate-300 hover:text-indigo-500 p-1 transition-colors text-xs">âœï¸</button>
                <button onclick="deleteMember('${m.id}')" class="text-slate-300 hover:text-red-500 p-1 transition-colors text-xs">ğŸ—‘ï¸</button>
            </div>
        </div>
    `).join('');

    if (myMemberId && members.some(m => m.id === myMemberId)) {
        document.getElementById('joinBtn').classList.add('hidden');
    }

    const sMembers = members.filter(m => m.lat);
    if (sMembers.length >= 2) {
        document.getElementById('normalSection').classList.remove('hidden');
        document.getElementById('biasSection').classList.remove('hidden');
        document.getElementById('rankingSection').classList.remove('hidden');
        calculateNormal(sMembers);
        renderBiasOptions(sMembers);
        renderRanking();
        
        // ğŸ”¥ ä¿®æ­£: biasã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚‚å†æç”»ï¼ˆå€™è£œãŒã‚ã‚Œã°ï¼‰
        if (currentBiasCandidates.length > 0) {
            renderCards('biasCandidates', currentBiasCandidates, 'bias');
        }
    } else {
        document.getElementById('normalSection').classList.add('hidden');
        document.getElementById('biasSection').classList.add('hidden');
        document.getElementById('rankingSection').classList.add('hidden');
    }
}

/** å€™è£œè¨ˆç®— **/
async function calculateNormal(sMembers) {
    const lat = sMembers.reduce((s, m) => s + m.lat, 0) / sMembers.length;
    const lng = sMembers.reduce((s, m) => s + m.lng, 0) / sMembers.length;
    fetchStations(lat, lng, 'normal');
}

function renderBiasOptions(sMembers) {
    document.getElementById('biasMemberList').innerHTML = sMembers.map(m => `
        <button onclick="selectBiasMember('${m.id}', ${m.lat}, ${m.lng})" 
                id="bias-btn-${m.id}"
                class="px-4 py-2 btn-bias rounded-full text-[11px] hover:shadow-sm ${currentBiasMemberId === m.id ? 'active' : ''}">
            ${m.name}
        </button>
    `).join('');
}

// ğŸ”¥ ä¿®æ­£: biasãƒ¡ãƒ³ãƒãƒ¼é¸æŠã‚’åˆ¥é–¢æ•°ã«
function selectBiasMember(memberId, lat, lng) {
    currentBiasMemberId = memberId;
    // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('[id^="bias-btn-"]').forEach(btn => {
        btn.classList.remove('active');
    });
    const activeBtn = document.getElementById(`bias-btn-${memberId}`);
    if (activeBtn) activeBtn.classList.add('active');
    
    fetchStations(lat, lng, 'bias');
}

async function fetchStations(lat, lng, type) {
    try {
        const res = await fetch(`https://express.heartrails.com/api/json?method=getStations&x=${lng}&y=${lat}`);
        const data = await res.json();
        const stations = data.response?.station || [];
        const unique = []; 
        const names = new Set();
        stations.forEach(s => {
            if(!names.has(s.name)){
                unique.push({ name: s.name, lat: parseFloat(s.y), lng: parseFloat(s.x), line: s.line });
                names.add(s.name);
            }
        });
        const candidates = unique.slice(0, 4);
        
        if(type === 'bias') {
            currentBiasCandidates = candidates;
        }
        
        renderCards(type === 'normal' ? 'normalCandidates' : 'biasCandidates', candidates, type);
        updateMap(type === 'normal' ? 'normalMap' : 'biasMap', candidates, type === 'normal' ? '#6366f1' : '#ec4899');
    } catch(e) {
        console.error('fetchStations error:', e);
    }
}

/** ã‚«ãƒ¼ãƒ‰æç”» **/
function renderCards(containerId, candidates, section) {
    const me = groupData.members.find(m => m.id === myMemberId);
    const votes = groupData.memberVotes || {};
    const myVotes = votes[myMemberId] || [];

    document.getElementById(containerId).innerHTML = candidates.map((c, i) => {
        const isVoted = myVotes.includes(c.name);
        const vCount = Object.values(votes).filter(v => v.includes(c.name)).length;
        const infoId = `info-${section}-${i}`;
        const limitId = `limit-${section}-${i}`;

        // éåŒæœŸã§çµŒè·¯æƒ…å ±ã‚’è¨ˆç®—
        if (me && me.lat && me.lng) {
            setTimeout(() => calculateRouteInfo(me, c, infoId, limitId), 100 * i);
        }

        return `
            <div onclick="vote('${c.name}')" class="candidate-card p-5 rounded-[2rem] border-2 shadow-sm cursor-pointer ${isVoted ? 'bg-green-50 border-green-400' : 'bg-white border-slate-50 hover:border-slate-200'}">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-3">
                        <span class="w-7 h-7 rounded-full bg-slate-900 text-white text-[10px] flex items-center justify-center font-black">${i+1}</span>
                        <h3 class="font-black text-lg text-slate-800">${c.name}é§…</h3>
                    </div>
                    ${vCount > 0 ? `<span class="px-3 py-1 bg-indigo-600 text-white text-[10px] rounded-full font-black shadow-sm">${vCount} ç¥¨</span>` : ''}
                </div>
                <p class="text-[10px] font-bold text-slate-400 mb-3 ml-10">${c.line}</p>
                <div id="${infoId}" class="text-[11px] font-bold text-slate-500 mb-2 px-1">
                    ${me ? '<span class="text-slate-400">ğŸ”„ çµŒè·¯ã‚’è¨ˆç®—ä¸­...</span>' : '<span class="text-slate-400">å‚åŠ ã™ã‚‹ã¨çµŒè·¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</span>'}
                </div>
                <div id="${limitId}" class="text-[10px] font-black text-purple-600 bg-purple-50 p-3 rounded-2xl mb-4 hidden">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <a href="https://transit.yahoo.co.jp/search/result?from=${encodeURIComponent(me?.station || '')}é§…&to=${encodeURIComponent(c.name)}é§…" target="_blank" onclick="event.stopPropagation()" class="py-3 bg-indigo-600 text-white text-center text-[10px] rounded-xl font-black">ğŸšƒ çµŒè·¯ã‚’ç¢ºèª</a>
                    <a href="https://transit.yahoo.co.jp/search/result?from=${encodeURIComponent(c.name)}é§…&to=${encodeURIComponent(me?.station || '')}é§…&type=5" target="_blank" onclick="event.stopPropagation()" class="py-3 bg-slate-800 text-white text-center text-[10px] rounded-xl font-black">ğŸŒ™ çµ‚é›»ã‚’ç¢ºèª</a>
                </div>
                <div class="mt-2">
                    <a href="https://www.google.com/search?q=${encodeURIComponent(c.name + 'é§… å±…é…’å±‹')}" target="_blank" onclick="event.stopPropagation()" class="block py-3 bg-orange-500 text-white text-center text-[10px] rounded-xl font-black">ğŸº å‘¨è¾ºã®ãŠåº—ã‚’æ¢ã™</a>
                </div>
            </div>
        `;
    }).join('');
}

// çµŒè·¯æƒ…å ±ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
async function calculateRouteInfo(me, candidate, infoId, limitId) {
    const el = document.getElementById(infoId);
    const limitEl = document.getElementById(limitId);
    
    if (!me || !me.lat || !me.lng || !candidate.lat || !candidate.lng) {
        if (el) el.innerHTML = '<span class="text-slate-400">ä½ç½®æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</span>';
        return;
    }

    try {
        // è‡ªåˆ†ã®é§… â†’ å€™è£œé§… ã®çµŒè·¯
        const route = await getTransitInfoByCoords(me.lat, me.lng, candidate.lat, candidate.lng, false);
        
        if (el && route) {
            el.innerHTML = `<span class="text-indigo-600 font-black">ã‚ãªãŸï¼š</span>${route.duration} <span class="text-slate-300 mx-1">/</span> ä¹—æ›${route.transfers}å›`;
        } else if (el) {
            el.innerHTML = '<span class="text-slate-400">çµŒè·¯æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆYahoo!ä¹—æ›æ¡ˆå†…ã§ç¢ºèªï¼‰</span>';
        }

        // çµ‚é›»æƒ…å ±ï¼ˆå…¨ãƒ¡ãƒ³ãƒãƒ¼åˆ†ï¼‰
        const members = (groupData.members || []).filter(m => m.lat && m.lng);
        if (members.length > 0 && limitEl) {
            const lastTrainResults = await Promise.all(
                members.map(m => getTransitInfoByCoords(candidate.lat, candidate.lng, m.lat, m.lng, true))
            );
            
            const validResults = lastTrainResults
                .map((r, idx) => r && r.depTimeStr ? { ...r, member: members[idx] } : null)
                .filter(r => r !== null);
            
            if (validResults.length > 0) {
                // æœ€ã‚‚æ—©ã„çµ‚é›»ã‚’è¦‹ã¤ã‘ã‚‹
                const earliest = validResults.reduce((prev, curr) => 
                    (prev.depTime && curr.depTime && prev.depTime < curr.depTime) ? prev : curr
                );
                limitEl.innerHTML = `ğŸŒ™ å…¨å“¡ãƒªãƒŸãƒƒãƒˆï¼š<span class="text-lg">${earliest.depTimeStr}</span> <span class="font-normal opacity-60">(${earliest.member.name}ã•ã‚“ã®çµ‚é›»)</span>`;
                limitEl.classList.remove('hidden');
            }
        }
    } catch (e) {
        console.error('calculateRouteInfo error:', e);
        if (el) el.innerHTML = '<span class="text-slate-400">çµŒè·¯è¨ˆç®—ã‚¨ãƒ©ãƒ¼</span>';
    }
}

/** æŠ•ç¥¨ **/
async function vote(sName) {
    if (!myMemberId) {
        alert('å…ˆã«å‚åŠ ã—ã¦ãã ã•ã„');
        return;
    }
    const v = { ...(groupData.memberVotes || {}) };
    let myV = v[myMemberId] || [];
    myV = myV.includes(sName) ? myV.filter(x => x !== sName) : [...myV, sName];
    v[myMemberId] = myV;
    await db.collection('groups').doc(groupId).update({ memberVotes: v });
}

/** å‚åŠ ãƒ»è¿½åŠ  **/
function showJoinForm() { 
    document.getElementById('joinForm').classList.remove('hidden'); 
    document.getElementById('joinBtn').classList.add('hidden'); 
    editTargetId = null;
    document.getElementById('formLabel').innerHTML = '<span>ğŸ™‹</span> æƒ…å ±ã‚’å…¥åŠ›';
    document.getElementById('cancelBtn').classList.add('hidden');
}

function closeJoinForm() { 
    document.getElementById('joinForm').classList.add('hidden'); 
    if(!myMemberId) document.getElementById('joinBtn').classList.remove('hidden');
    document.getElementById('nickname').value = "";
    document.getElementById('stationInput').value = "";
    selectedStation = null;
    editTargetId = null;
}

function openAddFriendModal() { 
    document.getElementById('addFriendModal').classList.remove('hidden'); 
}

function closeAddFriendModal() { 
    document.getElementById('addFriendModal').classList.add('hidden');
    document.getElementById('addFriendNickname').value = "";
    document.getElementById('addFriendStationInput').value = "";
    addFriendSelectedStation = null;
}

async function joinOrUpdateGroup() {
    const name = document.getElementById('nickname').value.trim();
    if (!name) {
        alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    if (!selectedStation && !editTargetId) {
        alert('é§…ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    const members = [...(groupData.members || [])];
    const target = members.find(m => m.id === editTargetId);
    
    const mData = {
        id: editTargetId || 'mem_' + Date.now(), 
        name,
        station: selectedStation ? selectedStation.name : target.station,
        lat: selectedStation ? selectedStation.lat : target.lat,
        lng: selectedStation ? selectedStation.lng : target.lng
    };
    
    if (editTargetId) { 
        members[members.findIndex(m => m.id === editTargetId)] = mData; 
    } else { 
        members.push(mData); 
        localStorage.setItem('aida_member_' + groupId, mData.id);
        myMemberId = mData.id;
    }
    
    await db.collection('groups').doc(groupId).update({ members });
    closeJoinForm();
}

async function submitAddFriend() {
    const name = document.getElementById('addFriendNickname').value.trim();
    if (!name) {
        alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    if (!addFriendSelectedStation) {
        alert('é§…ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    const member = { 
        id: 'mem_' + Date.now(), 
        name, 
        station: addFriendSelectedStation.name, 
        lat: addFriendSelectedStation.lat, 
        lng: addFriendSelectedStation.lng 
    };
    await db.collection('groups').doc(groupId).update({ 
        members: firebase.firestore.FieldValue.arrayUnion(member) 
    });
    closeAddFriendModal();
}

function editMember(id) {
    editTargetId = id;
    const m = groupData.members.find(x => x.id === id);
    document.getElementById('nickname').value = m.name;
    document.getElementById('stationInput').value = m.station;
    document.getElementById('formLabel').innerHTML = '<span>âœï¸</span> æƒ…å ±ã‚’ä¿®æ­£';
    document.getElementById('cancelBtn').classList.remove('hidden');
    document.getElementById('joinForm').classList.remove('hidden');
    document.getElementById('joinBtn').classList.add('hidden');
    document.getElementById('joinForm').scrollIntoView({ behavior: 'smooth' });
}

async function deleteMember(id) {
    if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    const members = groupData.members.filter(x => x.id !== id);
    const v = { ...(groupData.memberVotes || {}) }; 
    delete v[id];
    await db.collection('groups').doc(groupId).update({ members, memberVotes: v });
    if(id === myMemberId) {
        localStorage.removeItem('aida_member_' + groupId);
        myMemberId = null;
        document.getElementById('joinBtn').classList.remove('hidden');
    }
}

/** åœ°å›³ **/
function updateMap(id, cands, color) {
    if (cands.length === 0) return;
    
    const mapEl = document.getElementById(id);
    if (!mapEl) return;
    
    const map = new google.maps.Map(mapEl, { 
        center: { lat: cands[0].lat, lng: cands[0].lng }, 
        zoom: 13, 
        disableDefaultUI: true, 
        zoomControl: true 
    });
    
    const b = new google.maps.LatLngBounds();
    cands.forEach((c, i) => {
        const m = new google.maps.Marker({ 
            position: { lat: c.lat, lng: c.lng }, 
            map, 
            label: { text: String(i+1), color: 'white', fontWeight: 'bold' }, 
            icon: { 
                path: google.maps.SymbolPath.CIRCLE, 
                fillColor: color, 
                fillOpacity: 1, 
                scale: 13, 
                strokeColor: 'white', 
                strokeWeight: 2 
            } 
        });
        b.extend(m.getPosition());
    });
    map.fitBounds(b);
}

function renderRanking() {
    const v = groupData.memberVotes || {};
    const count = {};
    Object.values(v).flat().forEach(s => count[s] = (count[s] || 0) + 1);
    const sorted = Object.entries(count).sort((a,b) => b[1] - a[1]);
    
    document.getElementById('rankingList').innerHTML = sorted.map(([n, c], i) => `
        <div class="bg-white p-5 rounded-[1.5rem] flex justify-between items-center text-sm shadow-sm border border-slate-50">
            <div class="flex items-center gap-3">
                <span class="text-xs font-black text-slate-300">#${i+1}</span>
                <span class="font-black text-slate-700">${n}é§…</span>
            </div>
            <span class="text-[11px] font-black text-indigo-600 bg-indigo-50 px-4 py-1.5 rounded-full">${c} ç¥¨</span>
        </div>
    `).join('') || '<p class="text-center text-[10px] text-slate-400 py-8 font-bold">ã¾ã æŠ•ç¥¨ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
}

function copyUrl() { 
    navigator.clipboard.writeText(window.location.href); 
    alert('æ‹›å¾…URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ ğŸ”—'); 
}
</script>
</html>
