<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aida - ã‚°ãƒ«ãƒ¼ãƒ— | å¾…ã¡åˆã‚ã›å ´æ‰€ã‚’æŠ•ç¥¨ã§æ±ºã‚ã‚‹</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WCDYPYTJE3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-WCDYPYTJE3');
    </script>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="ã¿ã‚“ãªã®ä¸­é–“åœ°ç‚¹ã‚’è¨ˆç®—ã—ã¦ã€æŠ•ç¥¨ã§å¾…ã¡åˆã‚ã›å ´æ‰€ã‚’æ±ºã‚ã‚ˆã†ã€‚ç™»éŒ²ä¸è¦ãƒ»å®Œå…¨ç„¡æ–™ã€‚">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Aida - å¾…ã¡åˆã‚ã›å ´æ‰€ã‚’æ±ºã‚ã‚ˆã†">
    <meta property="og:description" content="ã¿ã‚“ãªã®ä¸­é–“åœ°ç‚¹ã‚’è¨ˆç®—ã—ã¦ã€æŠ•ç¥¨ã§å¾…ã¡åˆã‚ã›å ´æ‰€ã‚’æ±ºã‚ã‚ˆã†ã€‚">
    <meta property="og:image" content="https://aida-meet.jp/ogp.png">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Aida - å¾…ã¡åˆã‚ã›å ´æ‰€ã‚’æ±ºã‚ã‚ˆã†">
    <meta name="twitter:description" content="ã¿ã‚“ãªã®ä¸­é–“åœ°ç‚¹ã‚’è¨ˆç®—ã—ã¦ã€æŠ•ç¥¨ã§å¾…ã¡åˆã‚ã›å ´æ‰€ã‚’æ±ºã‚ã‚ˆã†ã€‚">
    <meta name="twitter:image" content="https://aida-meet.jp/ogp.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
    <meta name="theme-color" content="#6366f1">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Outfit:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'], heading: ['"Outfit"', 'sans-serif'] } } }
        }
    </script>
    <style>
        .glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); }
        .glass-card { background: rgba(255,255,255,0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); border-radius: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.08); }
        .suggestions { position: absolute; left: 0; right: 0; z-index: 9999; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); max-height: 200px; overflow-y: auto; display: none; }
        .suggestions.show { display: block; }
        .map-container { height: 200px; border-radius: 12px; }
    </style>
</head>
<body class="font-sans bg-slate-50 text-slate-900 min-h-screen">
    <div class="fixed inset-0 pointer-events-none overflow-hidden">
        <div class="absolute top-[-20%] right-[-10%] w-[500px] h-[500px] bg-indigo-500/20 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-20%] left-[-10%] w-[400px] h-[400px] bg-pink-500/20 rounded-full blur-[100px]"></div>
    </div>
    <nav class="fixed top-0 left-0 right-0 z-50 glass border-b border-white/20 px-6 py-4">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <a href="index.html" class="text-2xl font-black tracking-tighter bg-gradient-to-r from-indigo-500 to-pink-500 bg-clip-text text-transparent font-heading">Aida</a>
            <a href="index.html" class="text-sm text-slate-500 hover:text-indigo-500 transition-colors">ãƒˆãƒƒãƒ—ã¸</a>
        </div>
    </nav>
    <main class="relative z-10 max-w-2xl mx-auto px-4 pt-24 pb-12">
        <div id="createView">
            <div class="glass-card p-8">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-r from-indigo-500 to-pink-500 text-white text-3xl mb-4">ğŸ‰</div>
                    <h1 class="text-2xl font-black text-slate-900 font-heading">æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ</h1>
                    <p class="text-slate-500 mt-2">å¾…ã¡åˆã‚ã›å ´æ‰€ã‚’ã¿ã‚“ãªã§æ±ºã‚ã‚ˆã†</p>
                </div>
                <input type="text" id="groupName" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—åï¼ˆä¾‹: å¿˜å¹´ä¼š2025ï¼‰" class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none text-lg mb-4">
                <button onclick="createGroup()" class="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-500 to-pink-500 text-white font-bold text-lg shadow-lg shadow-indigo-500/25 hover:scale-[1.02] transition-transform">ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ â†’</button>
            </div>
        </div>
        <div id="groupView" class="hidden space-y-6">
            <!-- URLå…±æœ‰ -->
            <div class="glass-card p-6">
                <h2 class="text-sm font-bold text-slate-500 mb-4">ğŸ“¤ ã“ã®URLã‚’å…±æœ‰</h2>
                <div class="bg-slate-100 rounded-xl p-4 mb-4"><p id="shareUrl" class="text-sm text-slate-700 break-all font-mono"></p></div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <button onclick="copyUrl()" class="py-3 rounded-xl bg-slate-900 text-white font-bold">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    <button onclick="shareToLine()" class="py-3 rounded-xl bg-[#06C755] text-white font-bold">ğŸ’¬ LINE</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="shareToFacebook()" class="py-3 rounded-xl bg-[#1877F2] text-white font-bold">ğŸ“˜ Facebook</button>
                    <button onclick="shareToInstagram()" class="py-3 rounded-xl bg-gradient-to-r from-[#833AB4] via-[#FD1D1D] to-[#F77737] text-white font-bold">ğŸ“· Instagram</button>
                </div>
            </div>
            <!-- ãƒ¡ãƒ³ãƒãƒ¼ -->
            <div class="glass-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-slate-500">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆ<span id="memberCount">0</span>äººï¼‰</h2>
                    <button onclick="openAddFriendModal()" class="text-xs font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 px-3 py-1.5 rounded-lg flex items-center gap-1">ğŸ‘¤ å‹é”ã‚’è¿½åŠ </button>
                </div>
                <div id="memberList" class="space-y-3 mb-4"></div>
                <button id="joinBtn" onclick="showJoinForm()" class="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-500 to-pink-500 text-white font-bold shadow-lg shadow-indigo-500/25 hover:scale-[1.02] transition-transform">âœ‹ è‡ªåˆ†ã‚‚å‚åŠ ã™ã‚‹</button>
            </div>
            <!-- å‚åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="joinForm" class="hidden glass-card p-6">
                <h2 class="text-sm font-bold text-slate-500 mb-4">ğŸ™‹ å‚åŠ æƒ…å ±ã‚’å…¥åŠ›</h2>
                <input type="text" id="nickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none text-lg mb-4">
                <p class="text-sm font-bold text-slate-700 mb-2">ğŸš‰ ã‚ãªãŸã®å‡ºç™ºé§…ï¼ˆæœ€å¯„ã‚Šé§…ï¼‰</p>
                <p class="text-xs text-slate-400 mb-3">â€»ã“ã“ã‹ã‚‰ä¸­é–“åœ°ç‚¹ã‚’è¨ˆç®—ã—ã¾ã™</p>
                <label id="anywhereBtn" onclick="toggleAnywhere()" class="flex items-center gap-3 p-4 rounded-xl bg-amber-50 border-2 border-amber-200 cursor-pointer mb-4">
                    <div id="checkboxIcon" class="w-6 h-6 rounded-md border-2 border-amber-400 flex items-center justify-center text-white text-sm font-bold"></div>
                    <span class="font-bold text-amber-700">ã©ã“ã§ã‚‚OKï¼ˆé§…ã‚’æŒ‡å®šã—ãªã„ï¼‰</span>
                </label>
                <div id="stationWrapper" class="relative mb-4">
                    <input type="text" id="stationInput" placeholder="å‡ºç™ºé§…ã‚’å…¥åŠ›ï¼ˆä¾‹: æ¸‹è°·ã€æ–°å®¿...ï¼‰" oninput="searchStation()" onfocus="searchStation()" class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none text-lg">
                    <div id="suggestions" class="suggestions"></div>
                </div>
                <button onclick="joinGroup()" class="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-500 to-pink-500 text-white font-bold shadow-lg shadow-indigo-500/25 hover:scale-[1.02] transition-transform">å‚åŠ ã™ã‚‹ â†’</button>
            </div>
            <!-- ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="editForm" class="hidden glass-card p-6">
                <h2 class="text-sm font-bold text-slate-500 mb-4">âœï¸ æƒ…å ±ã‚’ç·¨é›†</h2>
                <p class="text-sm font-bold text-slate-700 mb-2">ğŸš‰ å‡ºç™ºé§…ã‚’å¤‰æ›´</p>
                <label id="editAnywhereBtn" onclick="toggleEditAnywhere()" class="flex items-center gap-3 p-4 rounded-xl bg-amber-50 border-2 border-amber-200 cursor-pointer mb-4">
                    <div id="editCheckboxIcon" class="w-6 h-6 rounded-md border-2 border-amber-400 flex items-center justify-center text-white text-sm font-bold"></div>
                    <span class="font-bold text-amber-700">ã©ã“ã§ã‚‚OKï¼ˆè¨ˆç®—ã«å«ã‚ãªã„ï¼‰</span>
                </label>
                <div id="editStationWrapper" class="relative mb-4">
                    <input type="text" id="editStationInput" placeholder="æ–°ã—ã„å‡ºç™ºé§…ã‚’å…¥åŠ›" oninput="searchEditStation()" onfocus="searchEditStation()" class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none text-lg">
                    <div id="editSuggestions" class="suggestions"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="cancelEdit()" class="py-3 rounded-xl bg-slate-200 text-slate-700 font-bold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="saveEdit()" class="py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-pink-500 text-white font-bold">ä¿å­˜ã™ã‚‹</button>
                </div>
            </div>
            <!-- ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ -->
            <div id="jumpButtons" class="hidden glass-card p-4">
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="scrollToSection('normalSection')" class="py-3 rounded-xl bg-indigo-500 text-white font-bold text-sm">ğŸ“ ãƒãƒ¼ãƒãƒ«</button>
                    <button onclick="scrollToSection('biasSection')" class="py-3 rounded-xl bg-pink-500 text-white font-bold text-sm">ğŸ‘¤ å¯„ã›ã‚‹</button>
                    <button onclick="scrollToSection('rankingSection')" class="py-3 rounded-xl bg-amber-500 text-white font-bold text-sm">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
                </div>
            </div>
            <!-- ãƒãƒ¼ãƒãƒ«å€™è£œã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="normalSection" class="hidden space-y-4">
                <div class="glass-card p-6">
                    <h2 class="text-lg font-black text-slate-900 mb-2">ğŸ“ ãƒãƒ¼ãƒãƒ«å€™è£œ</h2>
                    <p class="text-xs text-slate-400 mb-4">é‡å¿ƒãƒ»å¯†é›†åº¦ãƒ»ä¸»è¦é§…ã‚’è€ƒæ…®ã—ãŸ4ã¤ã®å€™è£œ</p>
                    <div id="normalMap" class="map-container mb-4"></div>
                    <div id="normalCandidates" class="space-y-3"></div>
                </div>
            </div>
            <!-- èª°ã‹ã«å¯„ã›ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="biasSection" class="hidden space-y-4">
                <div class="glass-card p-6">
                    <h2 class="text-lg font-black text-slate-900 mb-2">ğŸ‘¤ èª°ã‹ã«å¯„ã›ã‚‹</h2>
                    <p class="text-xs text-slate-400 mb-4">ç‰¹å®šã®äººã®è¿‘ãã®é§…ã‚’å€™è£œã«ã™ã‚‹</p>
                    <div id="biasMemberList" class="flex flex-wrap gap-2 mb-4"></div>
                    <div id="biasMap" class="map-container mb-4"></div>
                    <div id="biasCandidates" class="space-y-3"></div>
                </div>
            </div>
            <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="rankingSection" class="hidden space-y-4">
                <div class="glass-card p-6">
                    <h2 class="text-lg font-black text-slate-900 mb-2">ğŸ† æŠ•ç¥¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
                    <p class="text-xs text-slate-400 mb-4">å…¨ã¦ã®æŠ•ç¥¨çµæœ</p>
                    <div id="rankingList" class="space-y-3"></div>
                    <div id="votersList" class="mt-4 pt-4 border-t border-slate-200">
                        <h3 class="text-xs font-bold text-slate-400 mb-2">æŠ•ç¥¨çŠ¶æ³</h3>
                        <div id="votersDetail" class="text-sm text-slate-600"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- å‹é”è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="addFriendModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-slate-900">ğŸ‘¤ å‹é”ã‚’è¿½åŠ ï¼ˆä»£ç†ç™»éŒ²ï¼‰</h2>
                <button onclick="closeAddFriendModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <input type="text" id="addFriendNickname" placeholder="å‹é”ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none text-lg mb-4">
            <p class="text-sm font-bold text-slate-700 mb-2">ğŸš‰ å‡ºç™ºé§…ï¼ˆæœ€å¯„ã‚Šé§…ï¼‰</p>
            <label onclick="toggleAddFriendAnywhere()" class="flex items-center gap-3 p-4 rounded-xl bg-amber-50 border-2 border-amber-200 cursor-pointer mb-4">
                <div id="addFriendCheckboxIcon" class="w-6 h-6 rounded-md border-2 border-amber-400 flex items-center justify-center text-white text-sm font-bold"></div>
                <span class="font-bold text-amber-700">ã©ã“ã§ã‚‚OKï¼ˆé§…ã‚’æŒ‡å®šã—ãªã„ï¼‰</span>
            </label>
            <div id="addFriendStationWrapper" class="relative mb-4">
                <input type="text" id="addFriendStationInput" placeholder="å‡ºç™ºé§…ã‚’å…¥åŠ›ï¼ˆä¾‹: æ¸‹è°·ã€æ–°å®¿...ï¼‰" oninput="searchAddFriendStation()" onfocus="searchAddFriendStation()" class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none text-lg">
                <div id="addFriendSuggestions" class="suggestions"></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeAddFriendModal()" class="py-3 rounded-xl bg-slate-200 text-slate-700 font-bold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="submitAddFriend()" class="py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-pink-500 text-white font-bold">è¿½åŠ ã™ã‚‹</button>
            </div>
        </div>
    </div>
    
    <!-- ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editMemberModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-slate-900">âœï¸ ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç·¨é›†</h2>
                <button onclick="closeEditMemberModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <input type="text" id="editMemberNickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none text-lg mb-4">
            <p class="text-sm font-bold text-slate-700 mb-2">ğŸš‰ å‡ºç™ºé§…ï¼ˆæœ€å¯„ã‚Šé§…ï¼‰</p>
            <label onclick="toggleEditMemberAnywhere()" class="flex items-center gap-3 p-4 rounded-xl bg-amber-50 border-2 border-amber-200 cursor-pointer mb-4">
                <div id="editMemberCheckboxIcon" class="w-6 h-6 rounded-md border-2 border-amber-400 flex items-center justify-center text-white text-sm font-bold"></div>
                <span class="font-bold text-amber-700">ã©ã“ã§ã‚‚OKï¼ˆé§…ã‚’æŒ‡å®šã—ãªã„ï¼‰</span>
            </label>
            <div id="editMemberStationWrapper" class="relative mb-4">
                <input type="text" id="editMemberStationInput" placeholder="å‡ºç™ºé§…ã‚’å…¥åŠ›ï¼ˆä¾‹: æ¸‹è°·ã€æ–°å®¿...ï¼‰" oninput="searchEditMemberStation()" onfocus="searchEditMemberStation()" class="w-full px-5 py-4 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none text-lg">
                <div id="editMemberSuggestions" class="suggestions"></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeEditMemberModal()" class="py-3 rounded-xl bg-slate-200 text-slate-700 font-bold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="submitEditMember()" class="py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-pink-500 text-white font-bold">ä¿å­˜ã™ã‚‹</button>
            </div>
        </div>
    </div>
</body>
</html>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCxj6Qxk6PkL9WhbIQZh_wCwlhZBdY8MrQ",
    authDomain: "aida-f2eb3.firebaseapp.com",
    projectId: "aida-f2eb3",
    storageBucket: "aida-f2eb3.firebasestorage.app",
    messagingSenderId: "124876591098",
    appId: "1:124876591098:web:93bef3d94de8cf37799e43"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let groupId = null, groupData = null, myMemberId = null, isAnywhere = false, selectedStation = null;
let normalMap = null, biasMap = null;
let normalCandidates = [], biasCandidates = [];

const busyStations = ['æ¸‹è°·','æ–°å®¿','æ± è¢‹','æ±äº¬','å“å·','ä¸Šé‡','ç§‹è‘‰åŸ','æœ‰æ¥½ç”º','éŠ€åº§','å…­æœ¬æœ¨','æµæ¯”å¯¿','ç›®é»’','äº”åç”°','å¤§å´','æ–°æ©‹','æµœæ¾ç”º','ç”°ç”º','é«˜ç”°é¦¬å ´','ä¸­é‡','å‰ç¥¥å¯º','ç«‹å·','ç”ºç”°','æ¨ªæµœ','å·å´','å¤§å®®','åƒè‘‰','èˆ¹æ©‹','æŸ','åŒ—åƒä½','èµ¤ç¾½','è’²ç”°','è‡ªç”±ãŒä¸˜','ä¸‹åŒ—æ²¢','ä¸‰è»’èŒ¶å±‹','ä¸­ç›®é»’','ä»£å®˜å±±','è¡¨å‚é“','åŸå®¿','ä»£ã€…æœ¨','å¾¡èŒ¶ãƒæ°´','ç¥ç”°','æ—¥æœ¬æ©‹','é–€å‰ä»²ç”º','éŒ¦ç³¸ç”º','æŠ¼ä¸Š','æµ…è‰','å·£é´¨','å¤§å¡š','é§’è¾¼','ç‹å­','åæ¡','æ¿æ©‹','ç·´é¦¬','è»çªª','é˜¿ä½ãƒ¶è°·','é«˜å††å¯º','è¥¿è»çªª','ä¸‰é·¹','æ­¦è”µå¢ƒ','å›½åˆ†å¯º','å…«ç‹å­','èª¿å¸ƒ','åºœä¸­','è–è¹Ÿæ¡œãƒ¶ä¸˜','å¤šæ‘©ã‚»ãƒ³ã‚¿ãƒ¼','æºã®å£','æ­¦è”µå°æ‰','æ—¥å‰','èŠå','æ–°æ¨ªæµœ','æˆ¸å¡š','è—¤æ²¢','å¤§èˆ¹','éŒå€‰','èŒ…ãƒ¶å´','å¹³å¡š','å°ç”°åŸ','æµ·è€å','æœ¬åšæœ¨','ç›¸æ¨¡å¤§é‡','ç™»æˆ¸','å‘ãƒ¶ä¸˜éŠåœ’','æµ¦å’Œ','å·å£','è‰åŠ ','è¶Šè°·','æ˜¥æ—¥éƒ¨','ä¹…å–œ','ç†Šè°·','æ‰€æ²¢','å·è¶Š','å¿—æœ¨','æœéœå°','å’Œå…‰å¸‚','æˆå¢—','å…‰ãŒä¸˜','çŸ³ç¥äº•å…¬åœ’','å¤§æ³‰å­¦åœ’','ã²ã°ã‚Šãƒ¶ä¸˜','æ¸…ç€¬','æ±æ‘å±±','å°å¹³','å›½ç«‹','æ—¥é‡','è±Šç”°','é«˜å°¾','æ©‹æœ¬','ç›¸æ¨¡åŸ','æ·µé‡è¾º','å¤æ·µ','å—ç”ºç”°','é•·æ´¥ç”°','é’è‘‰å°','ãŸã¾ãƒ—ãƒ©ãƒ¼ã‚¶','ã‚ã–ã¿é‡','ã‚»ãƒ³ã‚¿ãƒ¼åŒ—','ã‚»ãƒ³ã‚¿ãƒ¼å—','æ–°ç™¾åˆãƒ¶ä¸˜','ä¸­å¤®æ—é–“','å¤§å’Œ','äºŒä¿£å·','ä¸Šå¤§å²¡','é‡‘æ²¢æ–‡åº«','é–¢å†…','æ¡œæœ¨ç”º','ã¿ãªã¨ã¿ã‚‰ã„','å…ƒç”ºãƒ»ä¸­è¯è¡—'];

const urlParams = new URLSearchParams(window.location.search);
groupId = urlParams.get('g');
if (groupId) { document.getElementById('createView').classList.add('hidden'); document.getElementById('groupView').classList.remove('hidden'); loadGroup(); }

async function createGroup() {
    const name = document.getElementById('groupName').value.trim() || 'æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—';
    const docRef = await db.collection('groups').add({ name, members: [], memberVotes: {}, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    groupId = docRef.id;
    window.history.pushState({}, '', `?g=${groupId}`);
    document.getElementById('createView').classList.add('hidden');
    document.getElementById('groupView').classList.remove('hidden');
    loadGroup();
}

function getShareUrl() {
    return window.location.protocol === 'https:' ? window.location.origin + '/app.html?g=' + groupId : 'https://top-bay-three.vercel.app/app.html?g=' + groupId;
}

function getMyStation() {
    const savedId = localStorage.getItem('aida_member_' + groupId);
    const me = (groupData?.members || []).find(m => m.id === savedId);
    return me?.station || null;
}

async function loadGroup() {
    document.getElementById('shareUrl').textContent = getShareUrl();
    db.collection('groups').doc(groupId).onSnapshot(doc => {
        if (doc.exists) { groupData = doc.data(); renderAll(); }
    });
}

function renderAll() {
    renderMembers();
    const members = groupData.members || [];
    const stationMembers = members.filter(m => !m.anywhere && m.lat && m.lng);
    if (stationMembers.length >= 2) {
        document.getElementById('jumpButtons').classList.remove('hidden');
        document.getElementById('normalSection').classList.remove('hidden');
        document.getElementById('biasSection').classList.remove('hidden');
        document.getElementById('rankingSection').classList.remove('hidden');
        calculateAndRenderNormal(stationMembers);
        renderBiasOptions(stationMembers);
        renderRanking();
    }
}

function renderMembers() {
    const list = document.getElementById('memberList');
    const members = groupData.members || [];
    const savedId = localStorage.getItem('aida_member_' + groupId);
    document.getElementById('memberCount').textContent = members.length;
    if (members.length === 0) {
        list.innerHTML = '<p class="text-center text-slate-400 py-8">ã¾ã èª°ã‚‚å‚åŠ ã—ã¦ã„ã¾ã›ã‚“</p>';
    } else {
        list.innerHTML = members.map(m => {
            const isMe = m.id === savedId;
            return `
            <div class="flex items-center gap-4 p-4 bg-white/50 rounded-xl ${isMe ? 'ring-2 ring-indigo-400' : ''}">
                <div class="w-12 h-12 rounded-full bg-gradient-to-r from-indigo-500 to-pink-500 flex items-center justify-center text-white font-bold text-lg">${m.name.charAt(0)}</div>
                <div class="flex-1">
                    <p class="font-bold text-slate-900">${m.name}${isMe ? ' <span class="text-xs text-indigo-500">(è‡ªåˆ†)</span>' : ''}</p>
                    <p class="text-sm text-slate-500">${m.anywhere ? 'ğŸŒ ã©ã“ã§ã‚‚OK' : 'ğŸš‰ ' + m.station + 'é§…'}</p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openEditMemberModal('${m.id}')" class="px-3 py-1 rounded-lg bg-slate-200 text-slate-600 text-xs font-bold hover:bg-slate-300">âœï¸</button>
                    <button onclick="deleteMember('${m.id}')" class="p-1 rounded-lg text-slate-300 hover:text-red-500 hover:bg-red-50 transition-colors" title="å‰Šé™¤">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        `}).join('');
    }
    if (savedId && members.find(m => m.id === savedId)) {
        myMemberId = savedId;
        document.getElementById('joinBtn').classList.add('hidden');
        document.getElementById('joinForm').classList.add('hidden');
        document.getElementById('editForm').classList.add('hidden');
    }
}

function scrollToSection(id) {
    document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
}

async function calculateAndRenderNormal(stationMembers) {
    const avgLat = stationMembers.reduce((s, m) => s + m.lat, 0) / stationMembers.length;
    const avgLng = stationMembers.reduce((s, m) => s + m.lng, 0) / stationMembers.length;
    
    // å¯†é›†åº¦è¨ˆç®—: å„ãƒ¡ãƒ³ãƒãƒ¼ã®è¿‘ãã«ä½•äººã„ã‚‹ã‹ã§é‡ã¿ä»˜ã‘ï¼ˆ50kmä»¥å†…ã®äººæ•°ï¼‰
    const getDistKm = (m1, m2) => Math.sqrt(Math.pow((m1.lat - m2.lat) * 111, 2) + Math.pow((m1.lng - m2.lng) * 91, 2));
    const nearbyCount = stationMembers.map(m => {
        return stationMembers.filter(other => other.id !== m.id && getDistKm(m, other) <= 50).length;
    });
    // é‡ã¿ = è¿‘ãã«ã„ã‚‹äººæ•° + 1ï¼ˆè‡ªåˆ†ï¼‰
    let totalLat = 0, totalLng = 0, totalWeight = 0;
    stationMembers.forEach((m, i) => { 
        const w = nearbyCount[i] + 1; 
        totalLat += m.lat * w; 
        totalLng += m.lng * w; 
        totalWeight += w; 
    });
    const densityLat = totalLat / totalWeight, densityLng = totalLng / totalWeight;
    
    // å…¨å›½ã®ä¸»è¦é§…ï¼ˆäººå£ãŒå¤šã„ã‚¨ãƒªã‚¢ã®é§…ï¼‰
    const majorStations = [
        // æ±äº¬éƒ½å¿ƒ
        { name: 'æ±äº¬', lat: 35.6812, lng: 139.7671 },
        { name: 'æ–°å®¿', lat: 35.6896, lng: 139.7006 },
        { name: 'æ¸‹è°·', lat: 35.6580, lng: 139.7016 },
        { name: 'æ± è¢‹', lat: 35.7295, lng: 139.7109 },
        { name: 'å“å·', lat: 35.6284, lng: 139.7387 },
        { name: 'ä¸Šé‡', lat: 35.7141, lng: 139.7774 },
        // ç¥å¥ˆå·
        { name: 'æ¨ªæµœ', lat: 35.4657, lng: 139.6225 },
        { name: 'å·å´', lat: 35.5308, lng: 139.7030 },
        { name: 'è—¤æ²¢', lat: 35.3386, lng: 139.4870 },
        { name: 'å°ç”°åŸ', lat: 35.2564, lng: 139.1550 },
        // åŸ¼ç‰
        { name: 'å¤§å®®', lat: 35.9063, lng: 139.6237 },
        { name: 'å·è¶Š', lat: 35.9078, lng: 139.4856 },
        { name: 'æ‰€æ²¢', lat: 35.7872, lng: 139.4690 },
        // åƒè‘‰
        { name: 'åƒè‘‰', lat: 35.6139, lng: 140.1137 },
        { name: 'èˆ¹æ©‹', lat: 35.7015, lng: 139.9854 },
        { name: 'æŸ', lat: 35.8617, lng: 139.9714 },
        // åŒ—é–¢æ±
        { name: 'å®‡éƒ½å®®', lat: 36.5592, lng: 139.8985 },
        { name: 'é«˜å´', lat: 36.3219, lng: 139.0134 },
        { name: 'æ°´æˆ¸', lat: 36.3706, lng: 140.4769 },
        // é™å²¡
        { name: 'é™å²¡', lat: 34.9717, lng: 138.3889 },
        { name: 'æµœæ¾', lat: 34.7038, lng: 137.7349 },
        { name: 'ç†±æµ·', lat: 35.1039, lng: 139.0779 },
        { name: 'æ²¼æ´¥', lat: 35.0956, lng: 138.8636 },
        // ä¸­éƒ¨
        { name: 'åå¤å±‹', lat: 35.1709, lng: 136.8815 },
        { name: 'é‡‘æ²¢', lat: 36.5780, lng: 136.6476 },
        { name: 'é•·é‡', lat: 36.6432, lng: 138.1889 },
        { name: 'æ–°æ½Ÿ', lat: 37.9126, lng: 139.0634 },
        { name: 'å²é˜œ', lat: 35.4094, lng: 136.7567 },
        // é–¢è¥¿
        { name: 'å¤§é˜ª', lat: 34.7024, lng: 135.4959 },
        { name: 'äº¬éƒ½', lat: 34.9858, lng: 135.7588 },
        { name: 'ç¥æˆ¸', lat: 34.6794, lng: 135.1800 },
        { name: 'å¥ˆè‰¯', lat: 34.6851, lng: 135.8048 },
        { name: 'å§«è·¯', lat: 34.8267, lng: 134.6914 },
        // ä¸­å›½
        { name: 'åºƒå³¶', lat: 34.3963, lng: 132.4594 },
        { name: 'å²¡å±±', lat: 34.6655, lng: 133.9185 },
        // å››å›½
        { name: 'é«˜æ¾', lat: 34.3503, lng: 134.0467 },
        { name: 'æ¾å±±', lat: 33.8396, lng: 132.7656 },
        // ä¹å·
        { name: 'åšå¤š', lat: 33.5902, lng: 130.4207 },
        { name: 'å°å€‰', lat: 33.8863, lng: 130.8825 },
        { name: 'ç†Šæœ¬', lat: 32.7898, lng: 130.6875 },
        { name: 'é¹¿å…å³¶ä¸­å¤®', lat: 31.5842, lng: 130.5414 },
        // æ±åŒ—
        { name: 'ä»™å°', lat: 38.2601, lng: 140.8820 },
        { name: 'ç››å²¡', lat: 39.7014, lng: 141.1369 },
        { name: 'éƒ¡å±±', lat: 37.3985, lng: 140.3883 },
        // åŒ—æµ·é“
        { name: 'æœ­å¹Œ', lat: 43.0687, lng: 141.3508 },
        { name: 'å‡½é¤¨', lat: 41.7739, lng: 140.7264 }
    ];
    
    try {
        const [res1, res2] = await Promise.all([
            fetch(`https://express.heartrails.com/api/json?method=getStations&x=${avgLng}&y=${avgLat}`),
            fetch(`https://express.heartrails.com/api/json?method=getStations&x=${densityLng}&y=${densityLat}`)
        ]);
        const [data1, data2] = await Promise.all([res1.json(), res2.json()]);
        
        const candidates = [];
        const usedNames = new Set();
        const stations1 = data1.response?.station ? [...new Map(data1.response.station.slice(0, 20).map(c => [c.name, c])).values()] : [];
        const stations2 = data2.response?.station ? [...new Map(data2.response.station.slice(0, 20).map(c => [c.name, c])).values()] : [];
        
        // é§…ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€é‡å¿ƒã«æœ€ã‚‚è¿‘ã„ä¸»è¦é§…ã‚’å€™è£œã«ã™ã‚‹
        if (stations1.length === 0 && stations2.length === 0) {
            // é‡å¿ƒã‹ã‚‰å„ä¸»è¦é§…ã¸ã®è·é›¢ã‚’è¨ˆç®—ï¼ˆç·¯åº¦1åº¦â‰’111kmï¼‰
            const stationsWithDist = majorStations.map(st => ({
                ...st,
                distKm: Math.sqrt(Math.pow((st.lat - avgLat) * 111, 2) + Math.pow((st.lng - avgLng) * 91, 2))
            })).sort((a, b) => a.distKm - b.distKm);
            
            // æœ€ã‚‚è¿‘ã„ä¸»è¦é§…
            const nearestMajor = stationsWithDist[0];
            const fallbackCandidates = [{
                name: nearestMajor.name,
                lat: nearestMajor.lat,
                lng: nearestMajor.lng,
                line: 'ä¸»è¦ã‚¿ãƒ¼ãƒŸãƒŠãƒ«',
                type: 'ğŸ™ï¸ é‡å¿ƒã«æœ€ã‚‚è¿‘ã„ä¸»è¦é§…'
            }];
            
            // ä¸»è¦é§…å‘¨è¾º5kmä»¥å†…ã®æ „ãˆã¦ã„ã‚‹é§…ã‚’æ¤œç´¢
            try {
                const nearbyRes = await fetch(`https://express.heartrails.com/api/json?method=getStations&x=${nearestMajor.lng}&y=${nearestMajor.lat}`);
                const nearbyData = await nearbyRes.json();
                if (nearbyData.response?.station) {
                    const nearbyStations = nearbyData.response.station;
                    const usedNames = new Set([nearestMajor.name]);
                    // 5kmä»¥å†…ã®æ „ãˆã¦ã„ã‚‹é§…ã‚’è¿½åŠ 
                    for (const s of nearbyStations) {
                        if (fallbackCandidates.length >= 4) break;
                        const distKm = Math.sqrt(Math.pow((parseFloat(s.y) - nearestMajor.lat) * 111, 2) + Math.pow((parseFloat(s.x) - nearestMajor.lng) * 91, 2));
                        if (distKm <= 5 && busyStations.includes(s.name) && !usedNames.has(s.name)) {
                            fallbackCandidates.push({
                                name: s.name,
                                lat: parseFloat(s.y),
                                lng: parseFloat(s.x),
                                line: s.line,
                                type: 'ğŸ™ï¸ å‘¨è¾ºã®æ „ãˆã¦ã„ã‚‹é§…'
                            });
                            usedNames.add(s.name);
                        }
                    }
                    // ã¾ã 4ã¤ã«æº€ãŸãªã„å ´åˆã€2ç•ªç›®ã«è¿‘ã„ä¸»è¦é§…ã‚‚è¿½åŠ 
                    if (fallbackCandidates.length < 4 && stationsWithDist.length > 1) {
                        for (let i = 1; i < stationsWithDist.length && fallbackCandidates.length < 4; i++) {
                            const st = stationsWithDist[i];
                            if (!usedNames.has(st.name)) {
                                fallbackCandidates.push({
                                    name: st.name,
                                    lat: st.lat,
                                    lng: st.lng,
                                    line: 'ä¸»è¦ã‚¿ãƒ¼ãƒŸãƒŠãƒ«',
                                    type: 'ğŸ™ï¸ å€™è£œã®ä¸»è¦é§…'
                                });
                                usedNames.add(st.name);
                            }
                        }
                    }
                }
            } catch(e) { console.error('Nearby search error:', e); }
            
            // 4ã¤ã«æº€ãŸãªã„å ´åˆã€ä»–ã®ä¸»è¦é§…ã§åŸ‹ã‚ã‚‹
            const usedNames = new Set(fallbackCandidates.map(c => c.name));
            for (let i = 1; i < stationsWithDist.length && fallbackCandidates.length < 4; i++) {
                const st = stationsWithDist[i];
                if (!usedNames.has(st.name)) {
                    fallbackCandidates.push({
                        name: st.name,
                        lat: st.lat,
                        lng: st.lng,
                        line: 'ä¸»è¦ã‚¿ãƒ¼ãƒŸãƒŠãƒ«',
                        type: 'ğŸ™ï¸ å€™è£œã®ä¸»è¦é§…'
                    });
                    usedNames.add(st.name);
                }
            }
            
            normalCandidates = fallbackCandidates.slice(0, 4);
            document.getElementById('normalCandidates').innerHTML = `
                <p class="text-center text-amber-600 py-2 mb-4">âš ï¸ ãƒ¡ãƒ³ãƒãƒ¼ã®è·é›¢ãŒé›¢ã‚Œã¦ã„ã‚‹ãŸã‚ã€ä¸»è¦é§…ã‚¨ãƒªã‚¢ã‚’å€™è£œã¨ã—ã¦è¡¨ç¤ºã—ã¦ã„ã¾ã™</p>
            ` + normalCandidates.map((c, i) => renderCandidateCard(c, i, [], getMyStation(), 'normal')).join('');
            renderNormalMap();
            return;
        }
        
        // 1. é‡å¿ƒã«è¿‘ã„é§…
        if (stations1[0]) { candidates.push({ name: stations1[0].name, lat: parseFloat(stations1[0].y), lng: parseFloat(stations1[0].x), line: stations1[0].line, type: 'ğŸ“ é‡å¿ƒã«è¿‘ã„é§…' }); usedNames.add(stations1[0].name); }
        // 2. é‡å¿ƒè¿‘ãã®ä¸»è¦é§…
        const busy1 = stations1.find(s => busyStations.includes(s.name) && !usedNames.has(s.name));
        if (busy1) { candidates.push({ name: busy1.name, lat: parseFloat(busy1.y), lng: parseFloat(busy1.x), line: busy1.line, type: 'ğŸ™ï¸ é‡å¿ƒè¿‘ãã®ä¸»è¦é§…' }); usedNames.add(busy1.name); }
        // 3. å¯†é›†åº¦è€ƒæ…®ã®é§…
        const density = stations2.find(s => !usedNames.has(s.name));
        if (density) { candidates.push({ name: density.name, lat: parseFloat(density.y), lng: parseFloat(density.x), line: density.line, type: 'ğŸ“Š å¯†é›†åº¦ã‚’è€ƒæ…®ã—ãŸé§…' }); usedNames.add(density.name); }
        // 4. å¯†é›†åº¦è¿‘ãã®ä¸»è¦é§…
        const busy2 = stations2.find(s => busyStations.includes(s.name) && !usedNames.has(s.name));
        if (busy2) { candidates.push({ name: busy2.name, lat: parseFloat(busy2.y), lng: parseFloat(busy2.x), line: busy2.line, type: 'ğŸ™ï¸ å¯†é›†åº¦è¿‘ãã®ä¸»è¦é§…' }); usedNames.add(busy2.name); }
        
        // 4ã¤ã«æº€ãŸãªã„å ´åˆã€é‡å¿ƒãƒ»å¯†é›†åº¦å‘¨è¾ºã®é§…ã‹ã‚‰è¿½åŠ 
        for (const s of [...stations1, ...stations2]) {
            if (candidates.length >= 4) break;
            if (!usedNames.has(s.name)) { candidates.push({ name: s.name, lat: parseFloat(s.y), lng: parseFloat(s.x), line: s.line, type: 'ğŸ“ å‘¨è¾ºé§…' }); usedNames.add(s.name); }
        }
        
        // ãã‚Œã§ã‚‚4ã¤ã«æº€ãŸãªã„å ´åˆã€ä¸»è¦é§…ãƒªã‚¹ãƒˆã‹ã‚‰è¿‘ã„é †ã«è¿½åŠ 
        if (candidates.length < 4) {
            const majorStationsNearby = majorStations.map(st => ({
                ...st,
                distKm: Math.sqrt(Math.pow((st.lat - avgLat) * 111, 2) + Math.pow((st.lng - avgLng) * 91, 2))
            })).sort((a, b) => a.distKm - b.distKm);
            for (const st of majorStationsNearby) {
                if (candidates.length >= 4) break;
                if (!usedNames.has(st.name)) {
                    candidates.push({ name: st.name, lat: st.lat, lng: st.lng, line: 'ä¸»è¦ã‚¿ãƒ¼ãƒŸãƒŠãƒ«', type: 'ğŸ™ï¸ è¿‘ãã®ä¸»è¦é§…' });
                    usedNames.add(st.name);
                }
            }
        }
        
        normalCandidates = candidates.slice(0, 4);
        if (normalCandidates.length > 0) {
            renderNormalMap();
            renderNormalCandidates();
        } else {
            document.getElementById('normalCandidates').innerHTML = '<p class="text-center text-slate-400 py-4">âš ï¸ å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
        }
    } catch(e) { 
        console.error('calculateAndRenderNormal error:', e); 
        document.getElementById('normalCandidates').innerHTML = '<p class="text-center text-red-400 py-4">âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
    }
}

function renderNormalMap() {
    if (normalCandidates.length === 0) return;
    if (!normalMap) { normalMap = L.map('normalMap').setView([normalCandidates[0].lat, normalCandidates[0].lng], 12); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM' }).addTo(normalMap); }
    normalMap.eachLayer(layer => { if (layer instanceof L.Marker) normalMap.removeLayer(layer); });
    normalCandidates.forEach((c, i) => {
        const icon = L.divIcon({ className: '', html: `<div style="background:linear-gradient(135deg,#6366f1,#ec4899);color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,0.3);">${i+1}</div>`, iconSize: [28, 28] });
        L.marker([c.lat, c.lng], { icon }).addTo(normalMap).bindPopup(`${c.name}é§…`);
    });
    normalMap.fitBounds(L.latLngBounds(normalCandidates.map(c => [c.lat, c.lng])), { padding: [30, 30] });
}

function renderNormalCandidates() {
    const memberVotes = groupData.memberVotes || {};
    const myVotes = memberVotes[myMemberId] || [];
    const myStation = getMyStation();
    document.getElementById('normalCandidates').innerHTML = normalCandidates.map((c, i) => renderCandidateCard(c, i, myVotes, myStation, 'normal')).join('');
}

function renderBiasOptions(stationMembers) {
    document.getElementById('biasMemberList').innerHTML = stationMembers.map(m => `
        <button onclick="biasToMember('${m.id}')" class="px-4 py-2 rounded-full bg-pink-100 text-pink-700 font-bold text-sm hover:bg-pink-200 transition-colors">${m.name}ã•ã‚“</button>
    `).join('');
}

async function biasToMember(memberId) {
    const target = (groupData.members || []).find(m => m.id === memberId);
    if (!target || !target.lat) return;
    try {
        const res = await fetch(`https://express.heartrails.com/api/json?method=getStations&x=${target.lng}&y=${target.lat}`);
        const data = await res.json();
        if (data.response?.station) {
            const stations = [...new Map(data.response.station.slice(0, 20).map(c => [c.name, c])).values()];
            biasCandidates = stations.slice(0, 5).map(c => ({ name: c.name, lat: parseFloat(c.y), lng: parseFloat(c.x), line: c.line, type: `${target.name}ã•ã‚“å‘¨è¾º` }));
            renderBiasMap();
            renderBiasCandidates();
        }
    } catch(e) { console.error(e); }
}

function renderBiasMap() {
    if (biasCandidates.length === 0) return;
    if (!biasMap) { biasMap = L.map('biasMap').setView([biasCandidates[0].lat, biasCandidates[0].lng], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM' }).addTo(biasMap); }
    biasMap.eachLayer(layer => { if (layer instanceof L.Marker) biasMap.removeLayer(layer); });
    biasCandidates.forEach((c, i) => {
        const icon = L.divIcon({ className: '', html: `<div style="background:linear-gradient(135deg,#ec4899,#f97316);color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,0.3);">${i+1}</div>`, iconSize: [28, 28] });
        L.marker([c.lat, c.lng], { icon }).addTo(biasMap).bindPopup(`${c.name}é§…`);
    });
    biasMap.fitBounds(L.latLngBounds(biasCandidates.map(c => [c.lat, c.lng])), { padding: [30, 30] });
}

function renderBiasCandidates() {
    const memberVotes = groupData.memberVotes || {};
    const myVotes = memberVotes[myMemberId] || [];
    const myStation = getMyStation();
    document.getElementById('biasCandidates').innerHTML = biasCandidates.map((c, i) => renderCandidateCard(c, i, myVotes, myStation, 'bias')).join('');
}

function renderCandidateCard(c, i, myVotes, myStation, section) {
    const memberVotes = groupData.memberVotes || {};
    let voteCount = 0;
    Object.values(memberVotes).forEach(votes => { if (votes.includes(c.name)) voteCount++; });
    const isVoted = myVotes.includes(c.name);
    const navitimeUrl = myStation ? `https://www.navitime.co.jp/transfer/searchlist?orvStationName=${encodeURIComponent(myStation)}&dnvStationName=${encodeURIComponent(c.name)}` : '';
    return `
        <div class="p-4 rounded-2xl ${isVoted ? 'bg-green-50 border-2 border-green-400' : 'bg-white/60 border-2 border-transparent'} transition-all cursor-pointer hover:shadow-lg" onclick="vote('${c.name}')">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-3">
                    <span class="w-8 h-8 rounded-full bg-gradient-to-r from-indigo-500 to-pink-500 text-white flex items-center justify-center font-bold text-sm">${i+1}</span>
                    <span class="font-bold text-lg">${c.name}é§…</span>
                </div>
                ${voteCount > 0 ? `<span class="px-3 py-1 rounded-full bg-blue-100 text-blue-600 text-xs font-bold">${voteCount}ç¥¨</span>` : ''}
            </div>
            <p class="text-sm text-slate-500 mb-1">${c.line || ''}</p>
            <p class="text-xs text-indigo-500 font-bold mb-3">${c.type}</p>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <a href="https://www.google.com/search?q=${encodeURIComponent(c.name + 'é§… å±…é…’å±‹ é£Ÿã¹ãƒ­ã‚°')}" target="_blank" onclick="event.stopPropagation()" class="py-2 rounded-xl bg-orange-500 text-white text-center font-bold text-sm">ğŸº é£Ÿã¹ãƒ­ã‚°</a>
                <a href="https://www.google.com/maps/search/å±…é…’å±‹/@${c.lat},${c.lng},16z" target="_blank" onclick="event.stopPropagation()" class="py-2 rounded-xl bg-blue-500 text-white text-center font-bold text-sm">ğŸ—ºï¸ Google Map</a>
            </div>
            ${myStation ? `<a href="${navitimeUrl}" target="_blank" onclick="event.stopPropagation()" class="block py-2 rounded-xl bg-green-500 text-white text-center font-bold text-sm">ğŸšƒ ${myStation}é§…ã‹ã‚‰ã®ä¹—æ›æ¡ˆå†…</a>` : ''}
        </div>
    `;
}

function renderRanking() {
    const memberVotes = groupData.memberVotes || {};
    const members = groupData.members || [];
    const allVoteCounts = {};
    Object.values(memberVotes).forEach(votes => { votes.forEach(station => { allVoteCounts[station] = (allVoteCounts[station] || 0) + 1; }); });
    
    if (Object.keys(allVoteCounts).length === 0) {
        document.getElementById('rankingList').innerHTML = '<p class="text-center text-slate-400 py-4">ã¾ã æŠ•ç¥¨ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        document.getElementById('votersDetail').innerHTML = '';
        return;
    }
    
    const sorted = Object.entries(allVoteCounts).map(([name, votes]) => ({ name, votes })).sort((a, b) => b.votes - a.votes);
    const maxVotes = sorted[0]?.votes || 1;
    
    document.getElementById('rankingList').innerHTML = sorted.map((s, i) => {
        const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i+1}.`;
        const barWidth = Math.round((s.votes / maxVotes) * 100);
        return `
            <div class="flex items-center gap-3">
                <span class="text-xl w-8">${medal}</span>
                <span class="font-bold flex-1">${s.name}é§…</span>
                <div class="w-24 h-2 bg-slate-200 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-indigo-500 to-pink-500" style="width:${barWidth}%"></div></div>
                <span class="text-sm font-bold text-slate-600 w-12 text-right">${s.votes}ç¥¨</span>
            </div>
        `;
    }).join('');
    
    const voterDetails = [];
    members.forEach(m => { const votes = memberVotes[m.id] || []; if (votes.length > 0) voterDetails.push(`<span class="font-bold">${m.name}</span>: ${votes.map(v => v + 'é§…').join(', ')}`); });
    document.getElementById('votersDetail').innerHTML = voterDetails.length > 0 ? voterDetails.join('<br>') : '';
}

async function vote(stationName) {
    if (!myMemberId) { alert('å…ˆã«å‚åŠ ã—ã¦ãã ã•ã„'); return; }
    const memberVotes = { ...(groupData.memberVotes || {}) };
    const myVotes = memberVotes[myMemberId] || [];
    if (myVotes.includes(stationName)) { memberVotes[myMemberId] = myVotes.filter(v => v !== stationName); }
    else { memberVotes[myMemberId] = [...myVotes, stationName]; }
    await db.collection('groups').doc(groupId).update({ memberVotes });
}

function showJoinForm() { document.getElementById('joinForm').classList.remove('hidden'); document.getElementById('joinBtn').classList.add('hidden'); }

function toggleAnywhere() {
    isAnywhere = !isAnywhere;
    const checkbox = document.getElementById('checkboxIcon');
    const wrapper = document.getElementById('stationWrapper');
    if (isAnywhere) { checkbox.innerHTML = 'âœ“'; checkbox.classList.add('bg-amber-400'); wrapper.classList.add('hidden'); }
    else { checkbox.innerHTML = ''; checkbox.classList.remove('bg-amber-400'); wrapper.classList.remove('hidden'); }
}

let searchTimeout = null;
function searchStation() {
    const query = document.getElementById('stationInput').value.trim();
    const suggestionsDiv = document.getElementById('suggestions');
    if (query.length < 1) { suggestionsDiv.classList.remove('show'); return; }
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
        suggestionsDiv.innerHTML = '<div class="p-4 text-slate-400">æ¤œç´¢ä¸­...</div>';
        suggestionsDiv.classList.add('show');
        try {
            const res = await fetch(`https://express.heartrails.com/api/json?method=getStations&name=${encodeURIComponent(query)}`);
            const data = await res.json();
            if (data.response?.station) {
                const unique = [...new Map(data.response.station.map(s => [s.name + s.line, s])).values()];
                suggestionsDiv.innerHTML = unique.slice(0, 8).map(s => `<div class="p-4 hover:bg-slate-50 cursor-pointer border-b border-slate-100" onclick="selectStation('${s.name}',${s.y},${s.x},'${s.line}')"><p class="font-bold">${s.name}é§…</p><p class="text-sm text-slate-500">${s.line}ï¼ˆ${s.prefecture}ï¼‰</p></div>`).join('');
            } else { suggestionsDiv.innerHTML = '<div class="p-4 text-slate-400">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>'; }
        } catch(e) { suggestionsDiv.innerHTML = '<div class="p-4 text-red-500">ã‚¨ãƒ©ãƒ¼</div>'; }
    }, 300);
}

function selectStation(name, lat, lng, line) { selectedStation = { name, lat, lng, line }; document.getElementById('stationInput').value = name; document.getElementById('suggestions').classList.remove('show'); }

async function joinGroup() {
    const members = groupData.members || [];
    if (members.length >= 20) { alert('ãƒ¡ãƒ³ãƒãƒ¼ã¯æœ€å¤§20äººã¾ã§ã§ã™'); return; }
    const name = document.getElementById('nickname').value.trim();
    if (!name) { alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if (!isAnywhere && !selectedStation) { alert('é§…ã‚’é¸æŠã™ã‚‹ã‹ã€Œã©ã“ã§ã‚‚OKã€ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
    const memberId = 'member_' + Date.now();
    const member = { id: memberId, name, anywhere: isAnywhere, station: isAnywhere ? null : selectedStation.name, lat: isAnywhere ? null : selectedStation.lat, lng: isAnywhere ? null : selectedStation.lng };
    await db.collection('groups').doc(groupId).update({ members: firebase.firestore.FieldValue.arrayUnion(member) });
    myMemberId = memberId;
    localStorage.setItem('aida_member_' + groupId, memberId);
    document.getElementById('joinForm').classList.add('hidden');
}

function copyUrl() { navigator.clipboard.writeText(getShareUrl()); alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'); }
function shareToLine() { window.open(`https://line.me/R/msg/text/?${encodeURIComponent(`ã€${groupData?.name || 'ã‚°ãƒ«ãƒ¼ãƒ—'}ã€‘ã®å¾…ã¡åˆã‚ã›å ´æ‰€ã‚’æ±ºã‚ã‚ˆã†ï¼\n\n${getShareUrl()}`)}`, '_blank'); }
function shareToFacebook() { window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(getShareUrl())}`, '_blank'); }
function shareToInstagram() { navigator.clipboard.writeText(getShareUrl()); window.location.href = 'instagram://direct-inbox'; setTimeout(() => alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nInstagramã®DMã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚'), 500); }

// ç·¨é›†æ©Ÿèƒ½
let editAnywhere = false, editSelectedStation = null;

function showEditForm() {
    const me = (groupData.members || []).find(m => m.id === myMemberId);
    if (!me) return;
    editAnywhere = me.anywhere || false;
    editSelectedStation = me.station ? { name: me.station, lat: me.lat, lng: me.lng } : null;
    document.getElementById('editForm').classList.remove('hidden');
    document.getElementById('editStationInput').value = me.station || '';
    updateEditCheckbox();
}

function updateEditCheckbox() {
    const checkbox = document.getElementById('editCheckboxIcon');
    const wrapper = document.getElementById('editStationWrapper');
    if (editAnywhere) { 
        checkbox.innerHTML = 'âœ“'; 
        checkbox.classList.add('bg-amber-400'); 
        wrapper.classList.add('hidden'); 
    } else { 
        checkbox.innerHTML = ''; 
        checkbox.classList.remove('bg-amber-400'); 
        wrapper.classList.remove('hidden'); 
    }
}

function cancelEdit() { document.getElementById('editForm').classList.add('hidden'); }

function toggleEditAnywhere() {
    editAnywhere = !editAnywhere;
    editSelectedStation = null;
    document.getElementById('editStationInput').value = '';
    updateEditCheckbox();
}

let editSearchTimeout = null;
function searchEditStation() {
    const query = document.getElementById('editStationInput').value.trim();
    const suggestionsDiv = document.getElementById('editSuggestions');
    if (query.length < 1) { suggestionsDiv.classList.remove('show'); return; }
    clearTimeout(editSearchTimeout);
    editSearchTimeout = setTimeout(async () => {
        suggestionsDiv.innerHTML = '<div class="p-4 text-slate-400">æ¤œç´¢ä¸­...</div>';
        suggestionsDiv.classList.add('show');
        try {
            const res = await fetch(`https://express.heartrails.com/api/json?method=getStations&name=${encodeURIComponent(query)}`);
            const data = await res.json();
            if (data.response?.station) {
                const unique = [...new Map(data.response.station.map(s => [s.name + s.line, s])).values()];
                suggestionsDiv.innerHTML = unique.slice(0, 8).map(s => `<div class="p-4 hover:bg-slate-50 cursor-pointer border-b border-slate-100" onclick="selectEditStation('${s.name}',${s.y},${s.x},'${s.line}')"><p class="font-bold">${s.name}é§…</p><p class="text-sm text-slate-500">${s.line}ï¼ˆ${s.prefecture}ï¼‰</p></div>`).join('');
            } else { suggestionsDiv.innerHTML = '<div class="p-4 text-slate-400">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>'; }
        } catch(e) { suggestionsDiv.innerHTML = '<div class="p-4 text-red-500">ã‚¨ãƒ©ãƒ¼</div>'; }
    }, 300);
}

function selectEditStation(name, lat, lng, line) { 
    editSelectedStation = { name, lat, lng, line }; 
    editAnywhere = false;
    document.getElementById('editStationInput').value = name; 
    document.getElementById('editSuggestions').classList.remove('show'); 
}

async function saveEdit() {
    if (!editAnywhere && !editSelectedStation) { alert('é§…ã‚’é¸æŠã™ã‚‹ã‹ã€Œã©ã“ã§ã‚‚OKã€ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
    const members = groupData.members || [];
    const updatedMembers = members.map(m => {
        if (m.id === myMemberId) {
            return { ...m, anywhere: editAnywhere, station: editAnywhere ? null : editSelectedStation.name, lat: editAnywhere ? null : editSelectedStation.lat, lng: editAnywhere ? null : editSelectedStation.lng };
        }
        return m;
    });
    await db.collection('groups').doc(groupId).update({ members: updatedMembers });
    document.getElementById('editForm').classList.add('hidden');
}

document.addEventListener('click', e => { 
    if (!e.target.closest('#stationWrapper')) document.getElementById('suggestions').classList.remove('show'); 
    if (!e.target.closest('#editStationWrapper')) document.getElementById('editSuggestions').classList.remove('show'); 
    if (!e.target.closest('#addFriendStationWrapper')) { const el = document.getElementById('addFriendSuggestions'); if(el) el.classList.remove('show'); }
    if (!e.target.closest('#editMemberStationWrapper')) { const el = document.getElementById('editMemberSuggestions'); if(el) el.classList.remove('show'); }
});

// å‹é”è¿½åŠ æ©Ÿèƒ½ï¼ˆä»£ç†ç™»éŒ²ï¼‰
let isProxyMode = false;
let addFriendAnywhere = false;
let addFriendSelectedStation = null;

function openAddFriendModal() {
    isProxyMode = true;
    addFriendAnywhere = false;
    addFriendSelectedStation = null;
    document.getElementById('addFriendModal').classList.remove('hidden');
    document.getElementById('addFriendNickname').value = '';
    document.getElementById('addFriendStationInput').value = '';
    updateAddFriendCheckbox();
}

function closeAddFriendModal() {
    document.getElementById('addFriendModal').classList.add('hidden');
    isProxyMode = false;
}

function toggleAddFriendAnywhere() {
    addFriendAnywhere = !addFriendAnywhere;
    addFriendSelectedStation = null;
    document.getElementById('addFriendStationInput').value = '';
    updateAddFriendCheckbox();
}

function updateAddFriendCheckbox() {
    const checkbox = document.getElementById('addFriendCheckboxIcon');
    const wrapper = document.getElementById('addFriendStationWrapper');
    if (addFriendAnywhere) { 
        checkbox.innerHTML = 'âœ“'; 
        checkbox.classList.add('bg-amber-400'); 
        wrapper.classList.add('hidden'); 
    } else { 
        checkbox.innerHTML = ''; 
        checkbox.classList.remove('bg-amber-400'); 
        wrapper.classList.remove('hidden'); 
    }
}

let addFriendSearchTimeout = null;
function searchAddFriendStation() {
    const query = document.getElementById('addFriendStationInput').value.trim();
    const suggestionsDiv = document.getElementById('addFriendSuggestions');
    if (query.length < 1) { suggestionsDiv.classList.remove('show'); return; }
    clearTimeout(addFriendSearchTimeout);
    addFriendSearchTimeout = setTimeout(async () => {
        suggestionsDiv.innerHTML = '<div class="p-4 text-slate-400">æ¤œç´¢ä¸­...</div>';
        suggestionsDiv.classList.add('show');
        try {
            const res = await fetch(`https://express.heartrails.com/api/json?method=getStations&name=${encodeURIComponent(query)}`);
            const data = await res.json();
            if (data.response?.station) {
                const unique = [...new Map(data.response.station.map(s => [s.name + s.line, s])).values()];
                suggestionsDiv.innerHTML = unique.slice(0, 8).map(s => `<div class="p-4 hover:bg-slate-50 cursor-pointer border-b border-slate-100" onclick="selectAddFriendStation('${s.name}',${s.y},${s.x},'${s.line}')"><p class="font-bold">${s.name}é§…</p><p class="text-sm text-slate-500">${s.line}ï¼ˆ${s.prefecture}ï¼‰</p></div>`).join('');
            } else { suggestionsDiv.innerHTML = '<div class="p-4 text-slate-400">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>'; }
        } catch(e) { suggestionsDiv.innerHTML = '<div class="p-4 text-red-500">ã‚¨ãƒ©ãƒ¼</div>'; }
    }, 300);
}

function selectAddFriendStation(name, lat, lng, line) { 
    addFriendSelectedStation = { name, lat, lng, line }; 
    addFriendAnywhere = false;
    document.getElementById('addFriendStationInput').value = name; 
    document.getElementById('addFriendSuggestions').classList.remove('show'); 
}

async function submitAddFriend() {
    const members = groupData.members || [];
    if (members.length >= 20) { alert('ãƒ¡ãƒ³ãƒãƒ¼ã¯æœ€å¤§20äººã¾ã§ã§ã™'); return; }
    const name = document.getElementById('addFriendNickname').value.trim();
    if (!name) { alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if (!addFriendAnywhere && !addFriendSelectedStation) { alert('é§…ã‚’é¸æŠã™ã‚‹ã‹ã€Œã©ã“ã§ã‚‚OKã€ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
    const memberId = 'member_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const member = { id: memberId, name, anywhere: addFriendAnywhere, station: addFriendAnywhere ? null : addFriendSelectedStation.name, lat: addFriendAnywhere ? null : addFriendSelectedStation.lat, lng: addFriendAnywhere ? null : addFriendSelectedStation.lng };
    await db.collection('groups').doc(groupId).update({ members: firebase.firestore.FieldValue.arrayUnion(member) });
    closeAddFriendModal();
    alert('å‹é”ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
}

// ãƒ¡ãƒ³ãƒãƒ¼å‰Šé™¤æ©Ÿèƒ½ï¼ˆèª°ã§ã‚‚å‰Šé™¤å¯èƒ½ï¼‰
async function deleteMember(targetId) {
    if (!confirm('ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    const members = groupData.members || [];
    const newMembers = members.filter(m => m.id !== targetId);
    const newVotes = { ...(groupData.memberVotes || {}) };
    delete newVotes[targetId];
    await db.collection('groups').doc(groupId).update({ members: newMembers, memberVotes: newVotes });
    if (targetId === myMemberId) {
        myMemberId = null;
        localStorage.removeItem('aida_member_' + groupId);
        document.getElementById('joinBtn').classList.remove('hidden');
    }
}

// ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†æ©Ÿèƒ½ï¼ˆèª°ã§ã‚‚ç·¨é›†å¯èƒ½ï¼‰
let editMemberTargetId = null;
let editMemberAnywhere = false;
let editMemberSelectedStation = null;

function openEditMemberModal(memberId) {
    const member = (groupData.members || []).find(m => m.id === memberId);
    if (!member) return;
    
    editMemberTargetId = memberId;
    editMemberAnywhere = member.anywhere || false;
    editMemberSelectedStation = member.station ? { name: member.station, lat: member.lat, lng: member.lng } : null;
    
    document.getElementById('editMemberNickname').value = member.name;
    document.getElementById('editMemberStationInput').value = member.station || '';
    document.getElementById('editMemberModal').classList.remove('hidden');
    updateEditMemberCheckbox();
}

function closeEditMemberModal() {
    document.getElementById('editMemberModal').classList.add('hidden');
    editMemberTargetId = null;
}

function toggleEditMemberAnywhere() {
    editMemberAnywhere = !editMemberAnywhere;
    editMemberSelectedStation = null;
    document.getElementById('editMemberStationInput').value = '';
    updateEditMemberCheckbox();
}

function updateEditMemberCheckbox() {
    const checkbox = document.getElementById('editMemberCheckboxIcon');
    const wrapper = document.getElementById('editMemberStationWrapper');
    if (editMemberAnywhere) { 
        checkbox.innerHTML = 'âœ“'; 
        checkbox.classList.add('bg-amber-400'); 
        wrapper.classList.add('hidden'); 
    } else { 
        checkbox.innerHTML = ''; 
        checkbox.classList.remove('bg-amber-400'); 
        wrapper.classList.remove('hidden'); 
    }
}

let editMemberSearchTimeout = null;
function searchEditMemberStation() {
    const query = document.getElementById('editMemberStationInput').value.trim();
    const suggestionsDiv = document.getElementById('editMemberSuggestions');
    if (query.length < 1) { suggestionsDiv.classList.remove('show'); return; }
    clearTimeout(editMemberSearchTimeout);
    editMemberSearchTimeout = setTimeout(async () => {
        suggestionsDiv.innerHTML = '<div class="p-4 text-slate-400">æ¤œç´¢ä¸­...</div>';
        suggestionsDiv.classList.add('show');
        try {
            const res = await fetch(`https://express.heartrails.com/api/json?method=getStations&name=${encodeURIComponent(query)}`);
            const data = await res.json();
            if (data.response?.station) {
                const unique = [...new Map(data.response.station.map(s => [s.name + s.line, s])).values()];
                suggestionsDiv.innerHTML = unique.slice(0, 8).map(s => `<div class="p-4 hover:bg-slate-50 cursor-pointer border-b border-slate-100" onclick="selectEditMemberStation('${s.name}',${s.y},${s.x},'${s.line}')"><p class="font-bold">${s.name}é§…</p><p class="text-sm text-slate-500">${s.line}ï¼ˆ${s.prefecture}ï¼‰</p></div>`).join('');
            } else { suggestionsDiv.innerHTML = '<div class="p-4 text-slate-400">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>'; }
        } catch(e) { suggestionsDiv.innerHTML = '<div class="p-4 text-red-500">ã‚¨ãƒ©ãƒ¼</div>'; }
    }, 300);
}

function selectEditMemberStation(name, lat, lng, line) { 
    editMemberSelectedStation = { name, lat, lng, line }; 
    editMemberAnywhere = false;
    document.getElementById('editMemberStationInput').value = name; 
    document.getElementById('editMemberSuggestions').classList.remove('show'); 
}

async function submitEditMember() {
    if (!editMemberTargetId) return;
    const name = document.getElementById('editMemberNickname').value.trim();
    if (!name) { alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if (!editMemberAnywhere && !editMemberSelectedStation) { alert('é§…ã‚’é¸æŠã™ã‚‹ã‹ã€Œã©ã“ã§ã‚‚OKã€ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
    
    const members = groupData.members || [];
    const updatedMembers = members.map(m => {
        if (m.id === editMemberTargetId) {
            return { 
                ...m, 
                name,
                anywhere: editMemberAnywhere, 
                station: editMemberAnywhere ? null : editMemberSelectedStation.name, 
                lat: editMemberAnywhere ? null : editMemberSelectedStation.lat, 
                lng: editMemberAnywhere ? null : editMemberSelectedStation.lng 
            };
        }
        return m;
    });
    await db.collection('groups').doc(groupId).update({ members: updatedMembers });
    closeEditMemberModal();
    alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
}
</script>
