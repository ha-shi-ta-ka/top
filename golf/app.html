<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fairway Meet - ã‚´ãƒ«ãƒ•å ´æ¤œç´¢ & å ´æ‰€æ±ºã‚</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WCDYPYTJE3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-WCDYPYTJE3');
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Outfit:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDzpRxX5te8hcxf_az6n92FTkoRbyCEXwI&libraries=places&callback=initMap"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'], heading: ['"Outfit"', 'sans-serif'] },
                    colors: { brand: { 50: '#f0fdf4', 100: '#dcfce7', 500: '#22c55e', 600: '#16a34a', 900: '#14532d' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f0fdf4; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.6); }
        .glass-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.7); border-radius: 1.5rem; }
        .map-container { height: 340px; border-radius: 1.5rem; width: 100%; border: 4px solid white; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .tab-active { color: #15803d; border-bottom: 3px solid #22c55e; }
        .tab-inactive { color: #94a3b8; }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="pb-20">
    <div class="fixed inset-0 z-[-1] bg-[radial-gradient(at_0%_0%,rgba(34,197,94,0.15)_0,transparent_50%),radial-gradient(at_100%_100%,rgba(234,179,8,0.1)_0,transparent_50%)]"></div>

    <nav class="fixed top-0 left-0 right-0 z-50 glass px-6 py-4 border-b border-white/50">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2 group">
                <span class="text-2xl pt-1">â›³ï¸</span>
                <span class="text-xl font-black tracking-tighter text-brand-900 font-heading tracking-tight">Fairway Meet</span>
            </a>
            <button onclick="shareGroupInfo()" class="bg-white/80 text-brand-600 px-4 py-2 rounded-full text-xs font-bold border border-brand-100 shadow-sm">æ‹›å¾…</button>
        </div>
    </nav>

    <main class="max-w-2xl mx-auto px-4 pt-24 space-y-6">
        <div id="loading" class="fixed inset-0 bg-white/90 backdrop-blur-md z-[100] flex flex-col items-center justify-center hidden">
            <div class="animate-spin rounded-full h-14 w-14 border-[5px] border-brand-100 border-t-brand-600 mb-4"></div>
            <p class="text-brand-600 font-bold text-sm tracking-widest animate-pulse">SEARCHING COURSES...</p>
        </div>

        <div id="createView" class="fade-in">
            <div class="glass p-8 text-center rounded-[2.5rem] shadow-xl">
                <div class="w-20 h-20 bg-brand-600 rounded-[2rem] flex items-center justify-center text-4xl mx-auto mb-6 shadow-lg text-white">ğŸŒï¸â€â™‚ï¸</div>
                <h1 class="text-2xl font-black mb-2 text-slate-800 font-heading">ã‚´ãƒ«ãƒ•å ´èª¿æ•´</h1>
                <p class="text-slate-500 text-sm mb-8 leading-relaxed">å…¨å“¡ã®å‡ºç™ºåœ°ã‹ã‚‰<br>ã€ŒçœŸã‚“ä¸­ã€ã®ã‚´ãƒ«ãƒ•å ´ã‚’æ¢ãã†ã€‚</p>
                <input type="text" id="groupName" placeholder="ä¾‹: å¤ã®ã‚³ãƒ³ãƒš ğŸ†" class="w-full px-6 py-4 rounded-2xl bg-white border border-brand-100 outline-none text-lg text-slate-800 text-center shadow-inner mb-6">
                <button onclick="createGroup()" class="w-full py-4 rounded-2xl bg-brand-600 text-white font-bold text-lg shadow-xl shadow-brand-600/30 hover:scale-105 active:scale-95 transition-all">ã¯ã˜ã‚ã‚‹ ğŸš€</button>
            </div>
        </div>

        <div id="groupView" class="hidden space-y-6">
            <div class="glass p-6 rounded-[2rem] border border-white/60">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 id="groupTitleDisplay" class="text-xl font-black text-slate-800 font-heading">Group</h2>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Members: <span id="memberCount" class="text-brand-600">0</span></p>
                    </div>
                    <button onclick="openAddFriendModal()" class="bg-white text-brand-600 p-3 rounded-2xl border border-brand-100 shadow-sm">ï¼‹ å‹é”</button>
                </div>
                <div class="flex gap-3 overflow-x-auto hide-scrollbar pb-2" id="memberList"></div>
                <div id="actionArea" class="mt-6"></div>
            </div>

            <div id="searchArea" class="hidden glass p-4 rounded-2xl border border-brand-200 shadow-sm space-y-3">
                <p class="text-[10px] font-black text-brand-600 uppercase tracking-widest">ã‚´ãƒ«ãƒ•å ´ã‚’æ¤œç´¢ã—ã¦å€™è£œã«è¿½åŠ </p>
                <div class="flex gap-2">
                    <input type="text" id="golfSearchInput" placeholder="ä¾‹: å¸‚åŸ, æˆç”°, ã€‡ã€‡ã‚«ãƒ³ãƒˆãƒªãƒ¼" class="flex-1 px-4 py-3 rounded-xl bg-white border border-brand-100 outline-none text-sm">
                    <button onclick="searchGolfCourses()" class="bg-brand-600 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-md">æ¤œç´¢</button>
                </div>
                <div id="searchResults" class="space-y-2 max-h-40 overflow-y-auto hidden"></div>
            </div>

            <div id="mainContent" class="hidden space-y-6">
                <div class="flex border-b border-brand-200 sticky top-[72px] bg-[#f0fdf4]/95 backdrop-blur-xl z-40 px-2 pt-2">
                    <button onclick="switchTab('normal')" id="tab-normal" class="flex-1 py-3 text-sm font-bold tab-active">ğŸ“ å€™è£œã‚³ãƒ¼ã‚¹</button>
                    <button onclick="switchTab('ranking')" id="tab-ranking" class="flex-1 py-3 text-sm font-bold tab-inactive">ğŸ† æŠ•ç¥¨çµæœ</button>
                </div>

                <div id="content-normal" class="space-y-6">
                    <div id="normalMap" class="map-container"></div>
                    <div id="normalCandidates" class="grid gap-4"></div>
                </div>

                <div id="content-ranking" class="hidden space-y-4">
                    <div class="glass p-6 rounded-[2rem]">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                        <div id="rankingList" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] hidden flex items-end sm:items-center justify-center p-0 sm:p-4 transition-opacity duration-300">
        <div id="modalContent" class="bg-white w-full max-w-md rounded-t-[2rem] sm:rounded-[2rem] p-8 shadow-2xl transform translate-y-full transition-transform duration-300">
            <h2 id="modalTitle" class="text-xl font-black text-slate-900 mb-6 text-center font-heading tracking-tight">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h2>
            <div class="space-y-6">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-widest">ãŠåå‰</label>
                    <input type="text" id="nickname" class="w-full px-5 py-4 rounded-xl bg-slate-50 border border-slate-100 outline-none font-bold shadow-inner">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-widest">å‡ºç™ºåœ° (æœ€å¯„ã‚Šé§…/IC)</label>
                    <div class="relative">
                        <input type="text" id="stationInput" placeholder="ä¾‹: ç·´é¦¬IC, ã€‡ã€‡é§…" oninput="searchStationDebounced()" class="w-full px-5 py-4 rounded-xl bg-slate-50 border border-slate-100 outline-none font-bold shadow-inner">
                        <div id="suggestions" class="absolute left-0 right-0 top-full mt-2 bg-white rounded-xl shadow-xl border border-slate-100 max-h-48 overflow-y-auto hidden z-50"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">ç§»å‹•æ‰‹æ®µ</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="cursor-pointer"><input type="radio" name="carStatus" value="driver" class="peer sr-only" checked><div class="rounded-xl border border-slate-200 bg-white p-3 text-center transition-all peer-checked:border-brand-500 peer-checked:bg-brand-50 peer-checked:text-brand-700 font-bold text-[10px]">ğŸš— è»Šå‡ºã™</div></label>
                        <label class="cursor-pointer"><input type="radio" name="carStatus" value="passenger" class="peer sr-only"><div class="rounded-xl border border-slate-200 bg-white p-3 text-center transition-all peer-checked:border-brand-500 peer-checked:bg-brand-50 peer-checked:text-brand-700 font-bold text-[10px]">ğŸ™‹â€â™‚ï¸ åŒä¹—</div></label>
                        <label class="cursor-pointer"><input type="radio" name="carStatus" value="train" class="peer sr-only"><div class="rounded-xl border border-slate-200 bg-white p-3 text-center transition-all peer-checked:border-brand-500 peer-checked:bg-brand-50 peer-checked:text-brand-700 font-bold text-[10px]">ğŸšƒ é›»è»Š</div></label>
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="closeModal()" class="flex-1 py-4 bg-slate-100 text-slate-500 font-bold rounded-xl">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="submitMember()" class="flex-1 py-4 bg-brand-600 text-white font-bold rounded-xl shadow-lg shadow-brand-500/30">ä¿å­˜ã™ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCxj6Qxk6PkL9WhbIQZh_wCwlhZBdY8MrQ",
            authDomain: "aida-f2eb3.firebaseapp.com",
            projectId: "aida-f2eb3",
            storageBucket: "aida-f2eb3.firebasestorage.app",
            messagingSenderId: "124876591098",
            appId: "1:124876591098:web:93bef3d94de8cf37799e43"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const COLLECTION_NAME = 'golf_groups';
        const STORAGE_KEY_PREFIX = 'fairway_mem_';
        let groupId = new URLSearchParams(window.location.search).get('g');
        let groupData = null, myMemberId = null, selectedStation = null;
        let googleMap = null, mapMarkers = [], calculatedCandidates = [], isProxyMode = false;

        function initMap() { /* Google Maps Callback */ }

        if (groupId) {
            document.getElementById('createView').classList.add('hidden');
            document.getElementById('groupView').classList.remove('hidden');
            document.getElementById('searchArea').classList.remove('hidden');
            initGroup();
        }

        async function createGroup() {
            const name = document.getElementById('groupName').value.trim() || 'ã‚´ãƒ«ãƒ•ã‚³ãƒ³ãƒš';
            showLoading(true);
            try {
                const docRef = await db.collection(COLLECTION_NAME).add({ 
                    name, members: [], memberVotes: {}, candidates: [], createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                });
                window.location.href = `?g=${docRef.id}`;
            } catch(e) { console.error(e); }
        }

        function initGroup() {
            myMemberId = localStorage.getItem(`${STORAGE_KEY_PREFIX}${groupId}`);
            db.collection(COLLECTION_NAME).doc(groupId).onSnapshot(doc => {
                if (doc.exists) {
                    groupData = doc.data();
                    renderMemberSection();
                    renderRanking();
                    if (groupData.candidates && groupData.candidates.length > 0) {
                        calculatedCandidates = groupData.candidates;
                        renderMainContent();
                    } else {
                        document.getElementById('emptyState').classList.remove('hidden');
                    }
                }
            });
        }

        // --- â›³ï¸ å„²ã‘ã‚‹ãŸã‚ã®æ¤œç´¢æ©Ÿèƒ½ (Google Places API) ---
        function searchGolfCourses() {
            const query = document.getElementById('golfSearchInput').value;
            if (!query) return;
            showLoading(true);
            const service = new google.maps.places.PlacesService(googleMap || new google.maps.Map(document.createElement('div')));
            service.textSearch({ query: `ã‚´ãƒ«ãƒ•å ´ ${query}` }, (results, status) => {
                showLoading(false);
                const list = document.getElementById('searchResults');
                list.classList.remove('hidden');
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    list.innerHTML = results.slice(0, 5).map(res => `
                        <div onclick='addGolfCandidate("${res.name}", ${res.geometry.location.lat()}, ${res.geometry.location.lng()}, ${res.rating || 0}, "${res.place_id}")' 
                            class="p-3 bg-white border border-brand-100 rounded-xl cursor-pointer hover:bg-brand-50 flex justify-between items-center transition-all">
                            <div>
                                <p class="font-bold text-slate-800 text-sm">${res.name}</p>
                                <p class="text-[10px] text-slate-400">${res.formatted_address}</p>
                            </div>
                            <span class="text-brand-600 font-bold">ï¼‹è¿½åŠ </span>
                        </div>
                    `).join('');
                }
            });
        }

        async function addGolfCandidate(name, lat, lng, rating, placeId) {
            const newCandidate = { name, lat, lng, rating, placeId, price: 12000 }; // æ–™é‡‘ã¯ãƒ€ãƒŸãƒ¼
            const updated = [...(groupData.candidates || []), newCandidate];
            await db.collection(COLLECTION_NAME).doc(groupId).update({ candidates: updated });
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('golfSearchInput').value = '';
            Toastify({ text: "å€™è£œã«è¿½åŠ ã—ã¾ã—ãŸï¼", gravity: "top", position: "center", style: { background: "#16a34a" } }).showToast();
        }

        // --- å°ç·šï¼šæ¥½å¤©GORAãªã©ã®äºˆç´„ãƒªãƒ³ã‚¯ç”Ÿæˆ ---
        function getReservationLink(courseName) {
            // ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆIDã‚’çµ„ã¿è¾¼ã‚“ã æ¤œç´¢URL (ä¾‹: æ¥½å¤©GORA)
            return `https://search.gora.golf.rakuten.co.jp/?menu=search&act=search&keyword=${encodeURIComponent(courseName)}`;
        }

        function renderMainContent() {
            document.getElementById('mainContent').classList.remove('hidden');
            if (document.getElementById('emptyState')) document.getElementById('emptyState').classList.add('hidden');

            if (!googleMap && window.google) {
                googleMap = new google.maps.Map(document.getElementById('normalMap'), {
                    center: { lat: calculatedCandidates[0].lat, lng: calculatedCandidates[0].lng },
                    zoom: 12, disableDefaultUI: true
                });
            }

            mapMarkers.forEach(m => m.setMap(null));
            mapMarkers = [];
            const bounds = new google.maps.LatLngBounds();
            
            calculatedCandidates.forEach((c, i) => {
                const marker = new google.maps.Marker({
                    position: { lat: c.lat, lng: c.lng },
                    map: googleMap,
                    label: { text: (i + 1).toString(), color: "white", fontWeight: "bold" },
                    icon: { path: google.maps.SymbolPath.CIRCLE, scale: 16, fillColor: "#16a34a", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 }
                });
                bounds.extend(marker.getPosition());
                mapMarkers.push(marker);
            });
            googleMap.fitBounds(bounds);

            const votes = groupData.memberVotes || {};
            const myVotes = votes[myMemberId] || [];

            document.getElementById('normalCandidates').innerHTML = calculatedCandidates.map((c, i) => {
                const isVoted = myVotes.includes(c.name);
                const voteCount = Object.values(votes).filter(v => v.includes(c.name)).length;
                
                return `
                <div class="glass-card p-5 relative overflow-hidden transition-all ${isVoted ? 'ring-2 ring-brand-500 bg-brand-50' : ''}" onclick="toggleVote('${c.name}')">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-brand-600 text-white flex items-center justify-center font-black">${i+1}</div>
                            <div>
                                <h3 class="font-bold text-slate-900">${c.name}</h3>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <span class="text-[10px] text-orange-400 font-bold">â˜… ${c.rating}</span>
                                    <span class="text-[10px] text-slate-400">å¹³å‡äºˆç®— Â¥${c.price.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-brand-900 text-white px-3 py-1 rounded-full text-[10px] font-bold">ğŸ‘ ${voteCount}</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 relative z-10">
                        <a href="${getReservationLink(c.name)}" target="_blank" onclick="event.stopPropagation()" class="bg-white border border-brand-200 py-3 rounded-xl text-[11px] font-bold text-brand-700 flex items-center justify-center gap-2 shadow-sm">
                            <span>ğŸ“²</span> æ¥½å¤©GORAã§äºˆç´„
                        </a>
                        <button class="py-3 rounded-xl text-[11px] font-bold transition-all shadow-sm ${isVoted ? 'bg-brand-600 text-white' : 'bg-slate-800 text-white'}">
                            ${isVoted ? 'æŠ•ç¥¨æ¸ˆã¿' : 'ã“ã“ã«æŠ•ç¥¨'}
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        // --- Common UI Logic (Modified) ---
        function renderMemberSection() {
            document.getElementById('groupTitleDisplay').textContent = groupData.name;
            document.getElementById('memberCount').textContent = groupData.members.length;
            document.getElementById('memberList').innerHTML = groupData.members.map(m => `
                <div class="flex-shrink-0 flex flex-col items-center gap-1">
                    <img src="https://api.dicebear.com/7.x/notionists/svg?seed=${m.name}" class="w-12 h-12 rounded-xl bg-white border-2 ${m.id === myMemberId ? 'border-brand-500' : 'border-slate-100'} object-cover shadow-sm">
                    <p class="text-[10px] font-bold text-slate-600 truncate max-w-[60px]">${m.name}</p>
                </div>`).join('');

            const actionArea = document.getElementById('actionArea');
            if (myMemberId && groupData.members.find(m => m.id === myMemberId)) {
                actionArea.innerHTML = `<div onclick="showEditModal()" class="p-4 bg-brand-50 rounded-xl border border-brand-100 flex justify-between items-center cursor-pointer"><div><p class="text-[9px] text-brand-600 font-bold">YOUR ENTRY</p><p class="font-bold text-slate-800">${groupData.members.find(m => m.id === myMemberId).station}</p></div><span class="text-slate-400 text-xs">âœ</span></div>`;
            } else {
                actionArea.innerHTML = `<button onclick="showJoinModal()" class="w-full py-4 rounded-xl bg-brand-600 text-white font-bold shadow-lg">å‚åŠ ãƒ»å‡ºç™ºåœ°ç™»éŒ²</button>`;
            }
        }

        // --- Helper Funcs ---
        function showLoading(s) { document.getElementById('loading').classList.toggle('hidden', !s); }
        function closeModal() { 
            const overlay = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            content.classList.add('translate-y-full');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }
        function openModal(title) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalOverlay').classList.remove('hidden');
            setTimeout(() => document.getElementById('modalContent').classList.remove('translate-y-full'), 10);
        }
        function showJoinModal() { isProxyMode = false; openModal("å‚åŠ ç™»éŒ²"); }
        function openAddFriendModal() { isProxyMode = true; openModal("å‹é”ã‚’ä»£ç†è¿½åŠ "); }
        function showEditModal() { isProxyMode = false; openModal("æƒ…å ±ã‚’ä¿®æ­£"); }

        async function submitMember() {
            const name = document.getElementById('nickname').value.trim();
            if (!name || (!selectedStation && !document.getElementById('stationInput').value)) return;
            showLoading(true);
            const id = (isProxyMode) ? `mem_${Date.now()}` : (myMemberId || `mem_${Date.now()}`);
            const newMember = { id, name, station: selectedStation ? selectedStation.name : document.getElementById('stationInput').value, lat: selectedStation ? selectedStation.lat : 35.6895, lng: selectedStation ? selectedStation.lng : 139.6917, carStatus: document.querySelector('input[name="carStatus"]:checked').value };
            const members = [...(groupData.members || [])].filter(m => m.id !== id);
            members.push(newMember);
            await db.collection(COLLECTION_NAME).doc(groupId).update({ members });
            if (!isProxyMode) { myMemberId = id; localStorage.setItem(`${STORAGE_KEY_PREFIX}${groupId}`, id); }
            closeModal();
            showLoading(false);
        }

        let sT;
        function searchStationDebounced() {
            clearTimeout(sT);
            const q = document.getElementById('stationInput').value;
            if(q.length < 1) return;
            sT = setTimeout(() => {
                fetch(`https://express.heartrails.com/api/json?method=getStations&name=${encodeURIComponent(q)}`)
                    .then(res => res.json())
                    .then(data => {
                        const sug = document.getElementById('suggestions');
                        if (data.response?.station) {
                            sug.classList.remove('hidden');
                            sug.innerHTML = data.response.station.map(s => `<div onclick='selectStation("${s.name}", ${s.y}, ${s.x})' class="p-3 border-b border-slate-50 font-bold text-sm text-slate-700">${s.name}</div>`).join('');
                        }
                    });
            }, 400);
        }
        function selectStation(n, y, x) {
            selectedStation = { name: n, lat: y, lng: x };
            document.getElementById('stationInput').value = n;
            document.getElementById('suggestions').classList.add('hidden');
        }

        async function toggleVote(name) {
            if (!myMemberId) return showJoinModal();
            const votes = groupData.memberVotes || {};
            let my = votes[myMemberId] || [];
            if (my.includes(name)) my = my.filter(v => v !== name);
            else { my.push(name); confetti({ particleCount: 30, colors: ['#22c55e'] }); }
            votes[myMemberId] = my;
            await db.collection(COLLECTION_NAME).doc(groupId).update({ memberVotes: votes });
        }

        function switchTab(t) {
            document.getElementById('content-normal').classList.toggle('hidden', t !== 'normal');
            document.getElementById('content-ranking').classList.toggle('hidden', t !== 'ranking');
            document.getElementById('tab-normal').className = `flex-1 py-3 text-sm font-bold ${t==='normal'?'tab-active':'tab-inactive'}`;
            document.getElementById('tab-ranking').className = `flex-1 py-3 text-sm font-bold ${t==='ranking'?'tab-active':'tab-inactive'}`;
        }

        function renderRanking() {
            const votes = groupData.memberVotes || {};
            const counts = {};
            Object.values(votes).forEach(vArr => vArr.forEach(name => counts[name] = (counts[name] || 0) + 1));
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
            document.getElementById('rankingList').innerHTML = sorted.map(([name, count], i) => `
                <div class="flex items-center justify-between p-4 bg-white/50 rounded-xl border border-slate-100">
                    <span class="font-bold text-slate-800">${i+1}. ${name}</span>
                    <span class="font-black text-brand-600">${count} ç¥¨</span>
                </div>`).join('');
        }

        function shareGroupInfo() {
            const url = window.location.href;
            if(navigator.share) navigator.share({ title: 'Fairway Meet', url });
            else { navigator.clipboard.writeText(url); Toastify({ text: "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ" }).showToast(); }
        }
    </script>
</body>
</html>
