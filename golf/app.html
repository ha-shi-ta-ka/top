<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Aida - å…¬å¹³ãªã‚´ãƒ«ãƒ•å ´é¸ã³</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Outfit:wght@700;900&display=swap" rel="stylesheet">
    
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDzpRxX5te8hcxf_az6n92FTkoRbyCEXwI&libraries=places&callback=initApp"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script>
        tailwind.config = {
            theme: { extend: { 
                fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'], heading: ['"Outfit"', 'sans-serif'] },
                colors: { golf: '#15803d' }
            } }
        }
    </script>
    <style>
        .glass-card { background: rgba(255,255,255,0.98); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); border-radius: 2rem; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
        .role-btn.active { border-color: #15803d !important; background-color: #f0fdf4 !important; color: #15803d !important; }
        .map-container { height: 250px; border-radius: 1.5rem; overflow: hidden; background: #e5e7eb; }
        .loading-dots:after { content: ' .'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 40% { color: #666; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 60% { text-shadow: .25em 0 0 #666, .5em 0 0 rgba(0,0,0,0); } 80%, 100% { text-shadow: .25em 0 0 #666, .5em 0 0 #666; } }
    </style>
</head>
<body class="font-sans bg-slate-100 text-slate-900 min-h-screen pb-12">
    <nav class="fixed top-0 left-0 right-0 z-50 bg-white border-b border-slate-200 px-6 py-4">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <a href="/golf/app.html" class="text-2xl font-black tracking-tighter text-golf font-heading italic">Golf Aida</a>
            <div id="dateStatus" class="hidden text-[10px] font-black bg-golf text-white px-3 py-1 rounded-full"></div>
        </div>
    </nav>

    <main class="relative z-10 max-w-2xl mx-auto px-4 pt-24 space-y-6">
        <div id="createView">
            <div class="glass-card p-10 text-center">
                <div class="w-16 h-16 bg-green-100 text-golf rounded-3xl flex items-center justify-center text-3xl mx-auto mb-6">â›³ï¸</div>
                <h2 class="text-2xl font-black mb-6 font-heading italic">å…¬å¹³ãªã‚´ãƒ«ãƒ•å ´é¸ã³</h2>
                <input type="text" id="groupName" placeholder="ã‚³ãƒ³ãƒšåã‚’å…¥åŠ›" class="w-full px-6 py-4 rounded-xl border-2 border-slate-100 mb-6 outline-none focus:border-golf text-lg font-bold">
                <button onclick="createGroup()" class="w-full py-5 rounded-2xl bg-golf text-white font-black text-lg shadow-lg hover:scale-[1.01] active:scale-95 transition-all">ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ</button>
            </div>
        </div>

        <div id="groupView" class="hidden space-y-6">
            <div class="glass-card p-4 flex items-center justify-between gap-4">
                <div class="flex-1 bg-slate-50 px-3 py-2 rounded-lg border border-slate-100 overflow-hidden">
                    <div class="text-[9px] font-bold text-slate-400 uppercase">Invite URL</div>
                    <div id="shareUrl" class="text-[11px] font-mono text-slate-600 truncate"></div>
                </div>
                <button onclick="copyUrl()" class="px-5 py-3 bg-golf text-white rounded-xl text-xs font-black whitespace-nowrap">ã‚³ãƒ”ãƒ¼</button>
            </div>

            <div class="glass-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-black text-slate-800">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ (<span id="memberCount">0</span>)</h2>
                </div>
                <div id="memberList" class="space-y-3 mb-6"></div>
                <button id="joinBtn" onclick="showJoinForm()" class="w-full py-4 rounded-2xl bg-white border-2 border-golf text-golf font-black">âœ‹ ã‚ãªãŸã®æƒ…å ±ã‚’å…¥åŠ›</button>
            </div>

            <div id="joinForm" class="hidden glass-card p-6 border-2 border-golf/20 animate-fade-in">
                <h2 class="text-sm font-black text-golf mb-6">ğŸ“ å‡ºç™ºæƒ…å ±</h2>
                <input type="text" id="nickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " class="w-full px-5 py-4 rounded-xl border-2 border-slate-100 mb-4 outline-none focus:border-golf text-lg font-bold">
                
                <div class="mb-2">
                    <input type="text" id="addressInput" placeholder="å‡ºç™ºåœ°ï¼ˆè‡ªå®…ä½æ‰€ãªã©ï¼‰" class="w-full px-5 py-4 rounded-xl border-2 border-slate-100 outline-none focus:border-golf text-lg font-bold">
                </div>
                
                <button id="locBtn" onclick="getCurrentLocation()" class="flex items-center gap-2 text-golf text-[11px] font-black px-4 py-3 bg-green-50 rounded-xl mb-6 active:scale-95 transition-all border border-green-100">
                    <span class="text-base">ğŸ“</span> ç¾åœ¨åœ°ã‚’å–å¾—ã™ã‚‹
                </button>
                
                <p class="text-[10px] font-black text-slate-400 mb-3 ml-1 uppercase font-bold">ç§»å‹•ã®å½¹å‰²</p>
                <div class="grid grid-cols-3 gap-3 mb-8">
                    <button onclick="setRole('driver')" id="role-driver" class="role-btn py-4 rounded-xl border-2 border-slate-100 flex flex-col items-center gap-2 bg-white">
                        <span class="text-2xl">ğŸš—</span><span class="text-[10px] font-black">é‹è»¢æ‰‹</span>
                    </button>
                    <button onclick="setRole('passenger')" id="role-passenger" class="role-btn py-4 rounded-xl border-2 border-slate-100 flex flex-col items-center gap-2 bg-white">
                        <span class="text-2xl">ğŸ™‹â€â™‚ï¸</span><span class="text-[10px] font-black">ç›¸ä¹—ã‚Š</span>
                    </button>
                    <button onclick="setRole('individual')" id="role-individual" class="role-btn py-4 rounded-xl border-2 border-slate-100 flex flex-col items-center gap-2 bg-white">
                        <span class="text-2xl">ğŸš†</span><span class="text-[10px] font-black">è‡ªèµ°</span>
                    </button>
                </div>

                <div class="flex gap-2">
                    <button onclick="joinGolfGroup()" class="flex-1 py-4 rounded-xl bg-slate-900 text-white font-bold text-lg">ç¢ºå®š</button>
                    <button onclick="closeJoinForm()" class="px-6 py-4 rounded-xl bg-slate-200 font-bold">æˆ»ã‚‹</button>
                </div>
            </div>

            <div id="golfSection" class="hidden space-y-4">
                <div class="glass-card p-6">
                    <h2 class="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">â›³ï¸ ä¸­é–“åœ°ç‚¹å‘¨è¾ºã®ã‚³ãƒ¼ã‚¹</h2>
                    <div id="golfCandidates" class="space-y-4 text-center">
                        <p class="py-10 text-xs text-slate-300 font-bold loading-dots">è¨ˆç®—ä¸­</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

<script>
    /** * Config & Firebase */
    const RAKUTEN_APP_ID = "1018104301501452402";
    const RAKUTEN_AFFILIATE_ID = "4f92e4a3.4db7743d.4f92e4a4.13bb04b6";
    
    firebase.initializeApp({
        apiKey: "AIzaSyCxj6Qxk6PkL9WhbIQZh_wCwlhZBdY8MrQ",
        authDomain: "aida-f2eb3.firebaseapp.com",
        projectId: "aida-f2eb3",
        storageBucket: "aida-f2eb3.firebasestorage.app",
        messagingSenderId: "124876591098",
        appId: "1:124876591098:web:93bef3d94de8cf37799e43"
    });
    const db = firebase.firestore();

    let groupId = null, groupData = null, myMemberId = null;
    let selectedPlace = null, currentRole = 'individual';

    /** * åˆæœŸåŒ– */
    function initApp() {
        const urlParams = new URLSearchParams(window.location.search);
        groupId = urlParams.get('g');
        if (groupId) {
            document.getElementById('createView').classList.add('hidden');
            document.getElementById('groupView').classList.remove('hidden');
            loadGroup();
        }

        const input = document.getElementById('addressInput');
        const autocomplete = new google.maps.places.Autocomplete(input, {
            types: ['address', 'establishment'],
            componentRestrictions: { country: 'jp' }
        });
        autocomplete.addListener('place_changed', () => {
            const place = autocomplete.getPlace();
            if (place.geometry) {
                selectedPlace = {
                    name: place.name || place.formatted_address,
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng()
                };
            }
        });
        setRole('individual');
    }

    /** * ç¾åœ¨åœ°å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ */
    function getCurrentLocation() {
        if (!navigator.geolocation) return alert("ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
        const btn = document.getElementById('locBtn');
        btn.innerHTML = "å–å¾—ä¸­...";
        btn.disabled = true;

        navigator.geolocation.getCurrentPosition(
            async (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: { lat, lng } }, (res, status) => {
                    if (status === "OK" && res[0]) {
                        const addr = res[0].formatted_address.replace('æ—¥æœ¬ã€', '');
                        document.getElementById('addressInput').value = addr;
                        selectedPlace = { name: addr, lat, lng };
                    }
                    btn.innerHTML = "ğŸ“ ç¾åœ¨åœ°ã‚’å–å¾—ã™ã‚‹";
                    btn.disabled = false;
                });
            },
            (err) => {
                alert("ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„");
                btn.innerHTML = "ğŸ“ ç¾åœ¨åœ°ã‚’å–å¾—ã™ã‚‹";
                btn.disabled = false;
            }
        );
    }

    /** * ãƒ‡ãƒ¼ã‚¿åŒæœŸ */
    function loadGroup() {
        document.getElementById('shareUrl').textContent = window.location.href;
        db.collection('groups').doc(groupId).onSnapshot(doc => {
            if (doc.exists) {
                groupData = doc.data();
                myMemberId = localStorage.getItem('aida_member_' + groupId);
                renderAll();
            }
        });
    }

    function renderAll() {
        const members = groupData.members || [];
        document.getElementById('memberCount').textContent = members.length;
        document.getElementById('memberList').innerHTML = members.map(m => `
            <div class="flex items-center gap-4 p-4 bg-white rounded-2xl border ${m.id === myMemberId ? 'ring-2 ring-golf' : 'border-slate-100'}">
                <div class="text-2xl">${m.role === 'driver' ? 'ğŸš—' : m.role === 'passenger' ? 'ğŸ™‹â€â™‚ï¸' : 'ğŸš†'}</div>
                <div class="flex-1">
                    <p class="text-xs font-black">${m.name}</p>
                    <p class="text-[9px] text-slate-400 truncate">${m.address}</p>
                </div>
                <button onclick="deleteMember('${m.id}')" class="text-slate-300">ğŸ—‘ï¸</button>
            </div>`).join('');

        if (myMemberId) document.getElementById('joinBtn').classList.add('hidden');
        if (members.length >= 2) {
            calculateGolfCenter(members);
            document.getElementById('golfSection').classList.remove('hidden');
        }
    }

    async function calculateGolfCenter(members) {
        const lat = members.reduce((s, m) => s + m.lat, 0) / members.length;
        const lng = members.reduce((s, m) => s + m.lng, 0) / members.length;
        const rakutenUrl = `https://app.rakuten.co.jp/services/api/Gora/GoraGolfCourseSearch/20170623?format=json&latitude=${lat}&longitude=${lng}&searchRadius=50&applicationId=${RAKUTEN_APP_ID}&affiliateId=${RAKUTEN_AFFILIATE_ID}`;
        
        try {
            const res = await fetch(rakutenUrl);
            const data = await res.json();
            if (data.Items) renderGolfCourses(data.Items.slice(0, 5));
        } catch (e) { console.error(e); }
    }

    function renderGolfCourses(items) {
        document.getElementById('golfCandidates').innerHTML = items.map(item => {
            const c = item.Item;
            return `
                <div class="candidate-card p-5 bg-white border-2 border-slate-50 shadow-sm rounded-[2rem] text-left">
                    <img src="${c.golfCourseImageUrl}" class="w-full h-32 object-cover rounded-2xl mb-4">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-black text-slate-800 flex-1 truncate text-sm">${c.golfCourseName}</h3>
                        <span class="bg-amber-100 text-amber-700 text-[9px] font-bold px-2 py-0.5 rounded">â˜…${c.evaluation}</span>
                    </div>
                    <p class="text-[10px] text-slate-400 mb-4 line-clamp-2 leading-relaxed">${c.golfCourseCaption}</p>
                    <a href="${c.reserveUrlPC}" target="_blank" class="block w-full py-4 bg-golf text-white text-center text-xs rounded-xl font-black shadow-lg">æ¥½å¤©GORAã§äºˆç´„</a>
                </div>`;
        }).join('');
    }

    function setRole(role) {
        currentRole = role;
        document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`role-${role}`).classList.add('active');
    }

    function showJoinForm() { document.getElementById('joinForm').classList.remove('hidden'); document.getElementById('joinBtn').classList.add('hidden'); }
    function closeJoinForm() { document.getElementById('joinForm').classList.add('hidden'); if(!myMemberId) document.getElementById('joinBtn').classList.remove('hidden'); }

    async function createGroup() {
        const name = document.getElementById('groupName').value.trim() || 'ã‚´ãƒ«ãƒ•ã‚³ãƒ³ãƒš';
        const doc = await db.collection('groups').add({ name, members: [], createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        location.href = `?g=${doc.id}`;
    }

    async function joinGolfGroup() {
        const name = document.getElementById('nickname').value.trim();
        if (!name || !selectedPlace) return alert('å ´æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„');
        const m = { id: 'mem_' + Date.now(), name, role: currentRole, address: selectedPlace.name, lat: selectedPlace.lat, lng: selectedPlace.lng };
        await db.collection('groups').doc(groupId).update({ members: firebase.firestore.FieldValue.arrayUnion(m) });
        localStorage.setItem('aida_member_' + groupId, m.id);
        closeJoinForm();
    }

    async function deleteMember(id) {
        if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        const members = groupData.members.filter(x => x.id !== id);
        await db.collection('groups').doc(groupId).update({ members });
        if(id === myMemberId) localStorage.removeItem('aida_member_' + groupId);
    }

    function copyUrl() { navigator.clipboard.writeText(window.location.href); alert('æ‹›å¾…URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'); }
</script>
</body>
</html>
